(window.webpackJsonp=window.webpackJsonp||[]).push([[1],[,function(e,t,n){"use strict";n.r(t);class s{constructor(){this.domElement=document.createElement("div"),this.domElement.className="world_view",this.domElement.id="world_view"}}class i{constructor(){this.listeners=[],this.listenersOnce=[]}bind(e){return this.listeners.push(e),{dispose:()=>this.unbind(e)}}bindForOneExecution(e){this.listenersOnce.push(e)}unbind(e){let t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}execute(e){this.listeners.forEach(t=>{t(e)}),this.listenersOnce.forEach(t=>{t(e)}),this.listenersOnce=[]}}class o{constructor(e,t,n){this.listEntry=e,this.x=t,this.y=n}}class a{constructor(e=!0){this.isSelected=!1,this.onClicked=new i,this.onContextMenu=new i,this.domElement=document.createElement("div"),e&&(this.domElement.className="list_view_entry",this.domElement.addEventListener("click",e=>{this.onClicked.execute(this)}),this.domElement.addEventListener("contextmenu",e=>{this.onContextMenu.execute(new o(this,e.pageX,e.pageY))}))}setIsSelected(e){this.isSelected=e,this.updateVisuals()}updateVisuals(){this.domElement.className=this.isSelected?"list_view_entry_selected":"list_view_entry"}}class r{constructor(){this.listEntries=[],this.domElement=document.createElement("div"),this.domElement.className="list_view_container",this.borderDomElement=document.createElement("div"),this.borderDomElement.className="list_view_border",this.contentDomElement=document.createElement("div"),this.contentDomElement.className="list_view",this.domElement.appendChild(this.contentDomElement),this.domElement.appendChild(this.borderDomElement)}addListEntry(e){e.onClicked.bind(e=>this.handleListEntryClicked(e)),e.onContextMenu.bind(e=>this.handleListEntryContextMenu(e)),this.listEntries.push(e),this.contentDomElement.appendChild(e.domElement)}handleListEntryClicked(e){this.selectedEntry&&this.selectedEntry.setIsSelected(!1),this.selectedEntry=e,this.selectedEntry.setIsSelected(!0)}handleListEntryContextMenu(e){this.handleListEntryClicked(e.listEntry)}clear(){this.contentDomElement.innerHTML="",this.listEntries=[],this.selectedEntry=void 0}}class l extends a{constructor(){super(!1),this.subEntries=[],this.onSubEntryAdded=new i,this.depth=0,this.isCollapsed=!1,this.entryDomElement=document.createElement("div"),this.entryDomElement.className="list_view_entry",this.entryDomElement.addEventListener("click",e=>{this.onClicked.execute(this)}),this.entryDomElement.addEventListener("contextmenu",e=>{this.onContextMenu.execute(new o(this,e.pageX,e.pageY))}),this.domElement.appendChild(this.entryDomElement),this.subEntriesDomElement=document.createElement("div"),this.setIsCollapsed(!1)}updateVisuals(){this.entryDomElement.className=this.isSelected?"list_view_entry_selected":"list_view_entry"}setDepth(e){this.depth=e,this.subEntries.forEach(t=>{t.setDepth(e+1)})}setIsCollapsed(e){this.isCollapsed=e,e?this.domElement.removeChild(this.subEntriesDomElement):this.domElement.appendChild(this.subEntriesDomElement)}addSubEntry(e,t){t.registerSubEntry(e),e.setDepth(this.depth+1),this.subEntries.push(e),this.subEntriesDomElement.appendChild(e.domElement),this.onSubEntryAdded.execute(e)}createExpansionWidget(){let e=document.createElement("div");return e.style.pointerEvents="none",e.style.width="10px",this.onSubEntryAdded.bindForOneExecution(t=>{console.log("SubEntry added"),e.style.pointerEvents="auto",e.textContent=this.isCollapsed?"▸":"▾ "}),e.addEventListener("click",t=>{e.textContent=this.isCollapsed?"▾ ":"▸",this.setIsCollapsed(!this.isCollapsed),t.stopPropagation()}),e}}class h extends r{addListEntry(e){super.addListEntry(e),e instanceof l&&e.setDepth(0)}registerSubEntry(e){e.onClicked.bind(e=>this.handleListEntryClicked(e)),e.onContextMenu.bind(e=>this.handleListEntryContextMenu(e))}}class d extends l{constructor(e){super(),this.expansionWidget=this.createExpansionWidget(),this.entryDomElement.appendChild(this.expansionWidget),this.labelDomElement=document.createElement("div"),this.labelDomElement.style.marginLeft="2px",this.labelDomElement.textContent=e,this.entryDomElement.appendChild(this.labelDomElement)}setDepth(e){let t=8*e;this.expansionWidget.style.marginLeft=t+"px",super.setDepth(e)}}class c extends d{constructor(e){super(e),this.skeletonName=e}}class m extends d{constructor(e){super(e),this.meshName=e}}class u extends d{constructor(e){super(e),this.animationName=e}}class w extends d{constructor(e){super(e),this.imageName=e}}class p extends h{constructor(e){super(),this.recreateList=(()=>{this.clear();let e=new d("Skeletons"),t=new d("Animations"),n=new d("Meshes"),s=new d("Images");if(this.world){for(const[t,n]of this.world.resourceManager.skeletons){let n=new c(t);e.addSubEntry(n,this)}for(const[e,n]of this.world.resourceManager.animations){let n=new u(e);t.addSubEntry(n,this)}for(const[e,t]of this.world.resourceManager.meshes){let t=new m(e);n.addSubEntry(t,this)}for(const[e,t]of this.world.resourceManager.images){let t=new w(e);s.addSubEntry(t,this)}}this.addListEntry(e),this.addListEntry(t),this.addListEntry(n),this.addListEntry(s)}),this.contextMenu=e}setWorld(e){this.world=e,this.recreateList()}setEditor(e){this.editor=e}handleListEntryClicked(e){super.handleListEntryClicked(e),this.editor&&(e instanceof c&&this.editor.showSkeleton(e.skeletonName),e instanceof u&&this.editor.showAnimation(e.animationName),e instanceof m?this.editor.showMesh(e.meshName):e instanceof w&&this.editor.showImage(e.imageName))}handleListEntryContextMenu(e){super.handleListEntryContextMenu(e),this.contextMenu.clear(),this.contextMenu.setPositionFromMousePos(e.x,e.y),e.listEntry instanceof w&&this.contextMenu.addEntry("Remove",()=>{this.world&&(this.world.resourceManager.removeImage(e.listEntry.imageName),this.recreateList())})}}class g{constructor(e){e=e,this.domElement=document.createElement("div"),this.domElement.className="side_panel",this.domElement.id="left_panel",this.outliner=new p(e),this.domElement.appendChild(this.outliner.domElement)}setWorld(e){this.world=e,this.outliner.setWorld(e),this.outliner.recreateList(),this.world.resourceManager.onSkeletonsChanged.bind(this.outliner.recreateList),this.world.resourceManager.onAnimationsChanged.bind(this.outliner.recreateList),this.world.resourceManager.onMeshesChanged.bind(this.outliner.recreateList),this.world.resourceManager.onImagesChanged.bind(this.outliner.recreateList)}setEditor(e){this.outliner.setEditor(e)}}class b{constructor(e){this.domElement=document.createElement("div"),this.domElement.className="property_section",this.verticalBox=document.createElement("div"),this.verticalBox.className="vertical_box";let t=document.createElement("div");t.className="property_section_title";let n=document.createTextNode("▾ "+e);t.appendChild(n),this.verticalBox.appendChild(t),this.domElement.appendChild(this.verticalBox)}addWidget(e){this.verticalBox.appendChild(e.domElement)}}class f{constructor(e){this.domElement=document.createElement("div"),this.domElement.className="button",this.domElement.onclick=(()=>{this.onClick()}),this.domElement.appendChild(document.createTextNode(e))}}class x{constructor(e){this.domElement=document.createElement("label"),this.domElement.className="button",this.domElement.appendChild(document.createTextNode(e)),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept="application/zip",this.domElement.appendChild(this.fileInput)}}class v{constructor(){this.domElement=document.createElement("div"),this.domElement.className="button_group",this.buttons=[]}addButton(e){this.buttons.push(e),this.domElement.appendChild(e.domElement)}}class k{constructor(){this.domElement=document.createElement("input"),this.domElement.className="input_entry",this.domElement.type="number",this.domElement.oninput=(()=>{this.onInput()})}}class E{constructor(){this.domElement=document.createElement("div"),this.domElement.className="input_group",this.inputs=[]}addInput(e){this.inputs.push(e),this.domElement.appendChild(e.domElement)}}class S{constructor(){this.domElement=document.createElement("div"),this.domElement.className="side_panel";let e=new b("Import/Export"),t=new x("Open");t.fileInput.addEventListener("change",()=>{t.fileInput.files&&this.world&&this.world.loadProject(t.fileInput.files[0])},!1);let n=new f("Save");zip.workerScriptsPath="zip-js/",n.onClick=(()=>{this.world&&this.world.downloadProject()});let s=new v;s.addButton(t),s.addButton(n),e.addWidget(s);let i=new x("Load image");i.fileInput.accept="image/*",i.fileInput.addEventListener("change",()=>{i.fileInput.files&&this.world&&this.world.loadImage(i.fileInput.files[0])},!1);let o=new v;o.addButton(i),e.addWidget(o);let a=new k;a.onInput=(()=>{this.editor&&this.editor.setFrame(parseInt(a.domElement.value)),this.world&&this.world.render()});let r=new E;r.addInput(a),e.addWidget(r),this.domElement.appendChild(e.domElement)}setWorld(e){this.world=e}setEditor(e){this.editor=e}}class y{constructor(){this.domElement=document.createElement("ul"),this.domElement.className="context_menu"}clear(){this.domElement.innerHTML=""}addEntry(e,t){let n=document.createElement("li");n.className="context_menu_entry",n.appendChild(document.createTextNode(e)),n.onclick=t,this.domElement.appendChild(n)}setPositionFromMousePos(e,t){this.domElement.style.left=e+"px",this.domElement.style.top=t+"px"}}var _,D,M=n(2);class C{constructor(e,t,n,s){this.x=e,this.y=t,this.u=n,this.v=s}clone(){return new C(this.x,this.y,this.u,this.v)}}class A{constructor(e,t){this.v1=e,this.v2=t}clone(){return new A(this.v1,this.v2)}}class I{constructor(e,t,n){this.v1=e,this.v2=t,this.v3=n}clone(){return new I(this.v1,this.v2,this.v3)}}class V{constructor(e,t,n,s){this.v1=e,this.v2=t,this.v3=n,this.v4=s}clone(){return new V(this.v1,this.v2,this.v3,this.v4)}}class B{constructor(){this.meshName="",this.textureName="",this.vertices=[],this.lines=[],this.triangles=[],this.quads=[]}clone(){let e=new B;e.meshName=this.meshName,e.textureName=this.textureName;for(let t of this.vertices)e.vertices.push(t.clone());for(let t of this.lines)e.lines.push(t.clone());for(let t of this.triangles)e.triangles.push(t.clone());for(let t of this.quads)e.quads.push(t.clone());return e}reset(){this.vertices=[],this.lines=[],this.triangles=[],this.quads=[]}setAsRectangle(e,t){this.reset();let n=this.addVertex(0,0,0,0),s=this.addVertex(e,0,1,0),i=this.addVertex(e,t,1,1),o=this.addVertex(0,t,0,1);this.addQuad(n,s,i,o)}addVertex(e,t,n,s){return this.vertices.push(new C(e,t,n||0,s||0))-1}addLine(e,t){this.lines.push(new A(e,t))}addTriangle(e,t,n){this.triangles.push(new I(e,t,n))}addQuad(e,t,n,s){this.quads.push(new V(e,t,n,s))}getVertexPosition(e){return new M.w(this.vertices[e].x,this.vertices[e].y)}setVertexPosition(e,t){this.vertices[e].x=t.x,this.vertices[e].y=t.y}setTextureName(e){this.textureName=e}generatePositionBuffer(){let e=new Float32Array(3*this.vertices.length);return this.vertices.forEach((t,n)=>{e[3*n]=t.x,e[3*n+1]=t.y,e[3*n+2]=0}),e}generateTexCoordBuffer(){let e=new Float32Array(2*this.vertices.length);return this.vertices.forEach((t,n)=>{e[2*n]=t.u,e[2*n+1]=t.v}),e}generateFaceIndices(){let e=new Uint32Array(3*this.triangles.length+6*this.quads.length);this.triangles.forEach((t,n)=>{e[3*n]=t.v1,e[3*n+1]=t.v2,e[3*n+2]=t.v3});let t=3*this.triangles.length;return this.quads.forEach((n,s)=>{e[6*s+t]=n.v1,e[6*s+t+1]=n.v2,e[6*s+t+2]=n.v3,e[6*s+t+3]=n.v1,e[6*s+t+4]=n.v3,e[6*s+t+5]=n.v4}),e}}class L{constructor(){this.mesh=new M.m,this.pivot=new M.w(0,0),this.position=new M.w(0,0),this.rotation=0}createMeshFromMeshData(e,t){return new Promise(n=>{let s=t.images.get(e.textureName);if(s){let t=new Image;t.onload=(()=>{let s=new M.u(t);s.needsUpdate=!0,this.setupMesh(e,s),n()}),t.src=URL.createObjectURL(s.blob)}})}createMeshDataFromImageResource(e,t){return new Promise(n=>{let s=t.images.get(e);if(s){let e=new Image;e.onload=(()=>{let t=new M.u(e);t.needsUpdate=!0;let s=new B;s.setAsRectangle(t.image.width,t.image.height),this.setupMesh(s,t),n()}),e.src=URL.createObjectURL(s.blob)}})}createMeshDataFromTexture(e){return new Promise(t=>this.loadTexture("images/"+e).then(e=>{let n=new B;n.setAsRectangle(e.image.width,e.image.height),this.setupMesh(n,e),t()}))}setupMesh(e,t){if(!e)return;let n=e.generatePositionBuffer(),s=e.generateTexCoordBuffer(),i=e.generateFaceIndices(),o=new M.c;o.addAttribute("position",new M.b(n,3)),o.addAttribute("uv",new M.b(s,2)),o.setIndex(new M.b(i,1)),t.anisotropy=0,t.premultiplyAlpha=!0,t.magFilter=M.k,t.minFilter=M.k;let a=new M.n({map:t,opacity:1,transparent:!0,side:M.f,blending:M.e,blendEquation:M.a,blendSrc:M.o,blendDst:M.p});this.mesh.geometry=o,this.mesh.material=a}loadTexture(e){return new Promise(t=>{(new M.v).load(e,t)})}setPivot(e,t){this.pivot.x=e,this.pivot.y=t}setPosition(e,t){this.position.x=e,this.position.y=t}setRotation(e){this.rotation=e}updateTransform(){let e=M.l.degToRad(this.rotation),t=this.position.clone().sub(this.pivot.clone().rotateAround(new M.w(0,0),e));this.mesh.position.x=t.x,this.mesh.position.y=t.y,this.mesh.rotation.z=e}}!function(e){e[e.Male=0]="Male",e[e.Female=1]="Female"}(_||(_={})),function(e){e[e.Standard=0]="Standard",e[e.Skin=1]="Skin",e[e.Eye=2]="Eye",e[e.Hair=3]="Hair"}(D||(D={}));class P{constructor(e,t,n){this.path=e,this.zOffset=t,this.meshType=n}}const R=[new M.d(16764597),new M.d(15249304),new M.d(7885904)],N=[new M.d(12412238),new M.d(6408447),new M.d(4706377),new M.d(16776960)],z=[new M.d(2891805),new M.d(15062686),new M.d(7021340),new M.d(458844)],T=[new P("m/m_f_r_arm_1.png",-6,D.Skin),new P("m/m_f_r_arm_2.png",-7,D.Skin),new P("m/m_f_r_arm_3.png",-8,D.Skin),new P("m/m_f_r_leg_1.png",-3,D.Skin),new P("m/m_f_r_leg_2.png",-5,D.Skin),new P("m/m_f_r_leg_3.png",-4,D.Skin),new P("m/m_s_eyebrow.png",-2.5,D.Hair),new P("m/m_s_eye_fg.png",-2.4,D.Eye),new P("m/m_s_eye_bg.png",-2.3,D.Standard),new P("m/m_s_ear.png",-2.2,D.Skin),new P("m/m_s_head.png",-2,D.Skin),new P("m/m_f_neck.png",-1,D.Skin),new P("m/m_f_torso.png",0,D.Skin),new P("m/m_f_l_leg_1.png",3,D.Skin),new P("m/m_f_l_leg_2.png",1,D.Skin),new P("m/m_f_l_leg_3.png",2,D.Skin),new P("m/m_f_l_arm_1.png",6,D.Skin),new P("m/m_f_l_arm_2.png",5,D.Skin),new P("m/m_f_l_arm_3.png",4,D.Skin)],H=[new P("f/f_f_r_arm_1.png",-6,D.Skin),new P("f/f_f_r_arm_2.png",-7,D.Skin),new P("f/f_f_r_arm_3.png",-8,D.Skin),new P("f/f_f_r_leg_1.png",-3,D.Skin),new P("f/f_f_r_leg_2.png",-4,D.Skin),new P("f/f_f_r_leg_3.png",-5,D.Skin),new P("f/f_head_s_eyebrow.png",-2.5,D.Hair),new P("f/f_head_s_eye_fg.png",-2.4,D.Eye),new P("f/f_head_s_eye_bg.png",-2.3,D.Standard),new P("f/f_head_s_ear.png",-2.2,D.Skin),new P("f/f_head_s_head.png",-2,D.Skin),new P("f/f_head_f_neck.png",-1,D.Skin),new P("f/f_f_torso.png",0,D.Skin),new P("f/f_f_l_leg_1.png",3,D.Skin),new P("f/f_f_l_leg_2.png",2,D.Skin),new P("f/f_f_l_leg_3.png",1,D.Skin),new P("f/f_f_l_arm_1.png",6,D.Skin),new P("f/f_f_l_arm_2.png",5,D.Skin),new P("f/f_f_l_arm_3.png",4,D.Skin)],K=[new P("m/m_s_hair_front_1.png",-2.6,D.Hair),new P("m/m_s_hair_1.png",-2.1,D.Hair)],F=[new P("m/m_s_hair_front_2.png",-2.6,D.Hair),new P("m/m_s_hair_2.png",-2.1,D.Hair),new P("m/m_s_hair_back_2.png",.1,D.Hair)],U=[new P("f/f_hair_s_hair_front_1.png",-2.6,D.Hair),new P("f/f_hair_s_hair_1.png",-2.1,D.Hair)],W=[new P("f/f_hair_s_hair_2.png",-2.1,D.Hair),new P("f/f_hair_s_hair_back_2.png",.1,D.Hair)],O=[new P("m/m_clothing_f_r_arm_1.png",-6.1,D.Standard),new P("m/m_clothing_shirt_bottom.png",-5.9,D.Standard),new P("m/m_clothing_f_r_leg_1.png",-3.1,D.Standard),new P("m/m_clothing_f_r_leg_2.png",-5.1,D.Standard),new P("m/m_clothing_f_torso.png",-.1,D.Standard),new P("m/m_clothing_f_l_leg_1.png",2.9,D.Standard),new P("m/m_clothing_f_l_leg_2.png",.9,D.Standard),new P("m/m_clothing_f_l_arm_1.png",5.9,D.Standard)],j=[new P("m/m_clothing2_f_r_arm_1.png",-6.1,D.Standard),new P("m/m_clothing2_shirt_bottom.png",-5.9,D.Standard),new P("m/m_clothing2_f_r_leg_1.png",-3.1,D.Standard),new P("m/m_clothing2_f_r_leg_2.png",-5.1,D.Standard),new P("m/m_clothing2_f_torso.png",-.1,D.Standard),new P("m/m_clothing2_f_l_leg_1.png",2.9,D.Standard),new P("m/m_clothing2_f_l_leg_2.png",.9,D.Standard),new P("m/m_clothing2_f_l_arm_1.png",5.9,D.Standard)],Z=[new P("f/f_clothing_f_r_arm_1.png",-6.1,D.Standard),new P("f/f_clothing_shirt_bottom.png",-5.9,D.Standard),new P("f/f_clothing_f_r_leg_1.png",-3.1,D.Standard),new P("f/f_clothing_f_r_leg_2.png",-5.1,D.Standard),new P("f/f_clothing_f_torso.png",-.1,D.Standard),new P("f/f_clothing_f_l_leg_1.png",2.9,D.Standard),new P("f/f_clothing_f_l_leg_2.png",.9,D.Standard),new P("f/f_clothing_f_l_arm_1.png",5.9,D.Standard)],q=[new P("f/f_clothing2_f_r_arm_1.png",-6.1,D.Standard),new P("f/f_clothing2_shirt_bottom.png",-5.9,D.Standard),new P("f/f_clothing2_f_r_leg_1.png",-3.1,D.Standard),new P("f/f_clothing2_f_r_leg_2.png",-5.1,D.Standard),new P("f/f_clothing2_f_torso.png",-.1,D.Standard),new P("f/f_clothing2_f_l_leg_1.png",2.9,D.Standard),new P("f/f_clothing2_f_l_leg_2.png",.9,D.Standard),new P("f/f_clothing2_f_l_arm_1.png",5.9,D.Standard)],J=[new P("m/m_sabre.png",-6.9,D.Standard),new P("m/m_longsword.png",-6.9,D.Standard)],Y=[new P("f/f_sabre.png",-6.9,D.Standard),new P("f/f_longsword.png",-6.9,D.Standard)];class X{constructor(){this.isLoading=!1,this.gender=_.Male,this.hairIndex=0,this.clothingIndex=0,this.swordIndex=0,this.skinColorIndex=0,this.eyeColorIndex=0,this.hairColorIndex=0,this.standardMeshes=[],this.skinMeshes=[],this.hairMeshes=[],this.eyeMesh=new L,this.skinColor=R[this.skinColorIndex],this.eyeColor=N[this.eyeColorIndex],this.hairColor=z[this.hairColorIndex],this.wasAddedToScene=!1}setScene(e){this.scene=e}setGender(e){return this.gender!==e&&(this.gender=e,!0)}setHairIndex(e){return this.hairIndex!==e&&(this.hairIndex=e,!0)}setClothingIndex(e){return this.clothingIndex!==e&&(this.clothingIndex=e,!0)}setSwordIndex(e){return this.swordIndex!==e&&(this.swordIndex=e,!0)}setSkinColorIndex(e){this.skinColorIndex!==e&&(this.skinColorIndex=e,this.setSkinColor(R[e]))}setSkinColor(e){if(!this.isLoading){this.skinColor=e;for(let t of this.skinMeshes){let n=t.mesh.material;n&&(n.color=e)}}}setEyeColorIndex(e){this.eyeColorIndex!==e&&(this.eyeColorIndex=e,this.setEyeColor(N[e]))}setEyeColor(e){if(this.isLoading)return;this.eyeColor=e;let t=this.eyeMesh.mesh.material;t&&(t.color=e)}setHairColorIndex(e){this.hairColorIndex!==e&&(this.hairColorIndex=e,this.setHairColor(z[e]))}setHairColor(e){if(!this.isLoading){this.hairColor=e;for(let t of this.hairMeshes){let n=t.mesh.material;n&&(n.color=e)}}}createMeshInternal(e){return this.createMesh(e.path,e.zOffset,e.meshType)}createMeshes(e){let t=[];for(let n of e)t.push(this.createMeshInternal(n));return Promise.all(t)}createMesh(e,t,n){return new Promise(s=>{let i=new L,o=null;switch(n){case D.Standard:this.standardMeshes.push(i);break;case D.Skin:this.skinMeshes.push(i),o=this.skinColor;break;case D.Eye:this.eyeMesh=i,o=this.eyeColor;break;case D.Hair:this.hairMeshes.push(i),o=this.hairColor}i.createMeshDataFromTexture(e).then(()=>{if(o){let e=i.mesh.material;e&&(e.color=o)}i.mesh.translateZ(-8-t),s()})})}recreateCharacter(){if(this.isLoading)return Promise.all([]);this.isLoading=!0,this.removeFromScene();let e=[];return this.gender===_.Male?(e=e.concat(T),0===this.hairIndex?e=e.concat(K):1===this.hairIndex&&(e=e.concat(F)),0===this.clothingIndex?e=e.concat(O):1===this.clothingIndex&&(e=e.concat(j)),e.push(J[this.swordIndex])):(e=e.concat(H),0===this.hairIndex?e=e.concat(U):1===this.hairIndex&&(e=e.concat(W)),0===this.clothingIndex?e=e.concat(Z):1===this.clothingIndex&&(e=e.concat(q)),e.push(Y[this.swordIndex])),this.createMeshes(e).then(()=>(this.addToScene(),this.isLoading=!1,Promise.all([])))}addToScene(){if(this.scene){this.wasAddedToScene=!0;for(let e of this.standardMeshes)this.scene.add(e.mesh);for(let e of this.skinMeshes)this.scene.add(e.mesh);this.scene.add(this.eyeMesh.mesh);for(let e of this.hairMeshes)this.scene.add(e.mesh)}}removeFromScene(){if(this.scene&&this.wasAddedToScene){this.wasAddedToScene=!1;for(let e of this.standardMeshes)this.scene.remove(e.mesh);for(let e of this.skinMeshes)this.scene.remove(e.mesh);this.scene.remove(this.eyeMesh.mesh);for(let e of this.hairMeshes)this.scene.remove(e.mesh);this.standardMeshes=[],this.skinMeshes=[],this.hairMeshes=[]}}}class G{constructor(e,t,n){this.length=0,this.isConnected=!1,this.children=[],this.name=e,this.translation=t,this.rotation=n}clone(){let e=new G(this.name,this.translation,this.rotation);return e.length=this.length,e.isConnected=this.isConnected,e.children=[...this.children],e}}class Q{constructor(e,t){this.targetBone=e,this.bones=[...t]}clone(){return new Q(this.targetBone,this.bones)}}class ${constructor(e){this.bones=[],this.ikConstraints=[],this.name=e}clone(){let e=new $(this.name);for(let t of this.bones)e.bones.push(t.clone());for(let t of this.ikConstraints)e.ikConstraints.push(t);return e}addBone(e,t,n,s){return this.bones.push(new G(e,new M.w(t,n),s))-1}addIKConstraint(e,t){return this.ikConstraints.push(new Q(e,t))-1}setBoneLength(e,t){this.bones[e].length=t}setIsBoneConnected(e,t){this.bones[e].isConnected=t}attachBone(e,t){let n=this.bones[t];n.children.push(e);let s=this.bones[e];s.isConnected&&(s.translation.x=0,s.translation.y=n.length)}getRootIndices(){class e{constructor(){this.children=[]}}let t=new Array(this.bones.length);for(let n=0;n<this.bones.length;++n)t[n]=new e;for(let e=0;e<this.bones.length;++e){t[e].children=this.bones[e].children;for(let n of t[e].children)t[n].parent=e}let n=[];for(let e=0;e<t.length;++e)void 0===t[e].parent&&n.push(e);return n}createJsonObject(){let e={};e.name=this.name,e.bones=[];for(const t of this.bones){let n={};n.name=t.name,t.isConnected||(n.translation=[t.translation.x,t.translation.y]),n.rotation=t.rotation,n.length=t.length,t.isConnected&&(n.isConnected=t.isConnected),t.children.length>0&&(n.children=t.children),e.bones.push(n)}return e.ikConstraints=this.ikConstraints,e}}class ee{static normalizeAngle(e){let t=(e+180)%360;return t<0&&(t+=360),t-180}static isIterable(e){return null!=e&&"function"==typeof e[Symbol.iterator]}}class te{constructor(e){this.frame=e}}class ne extends te{constructor(e,t){super(e),this.angle=0,this.angle=t}}class se extends te{constructor(e,t){super(e),this.translation=new M.w(0,0),this.translation=t}}class ie extends te{constructor(e,t){super(e),this.scale=1,this.scale=t}}class oe{constructor(e){this.translation=void 0,this.rotation=void 0,this.scale=void 0,this.boneName=e}insertTranslation(e,t){if(this.translation){for(let n=0;n<this.translation.length;++n){if(this.translation[n].frame===e)return void(this.translation[n].translation=t);if(this.translation[n].frame>e)return void this.translation.splice(n,0,new se(e,t))}this.translation.push(new se(e,t))}else this.translation=[new se(e,t)]}insertRotation(e,t){if(this.rotation){for(let n=0;n<this.rotation.length;++n){if(this.rotation[n].frame===e)return void(this.rotation[n].angle=t);if(this.rotation[n].frame>e)return void this.rotation.splice(n,0,new ne(e,t))}this.rotation.push(new ne(e,t))}else this.rotation=[new ne(e,t)]}insertScale(e,t){if(this.scale){for(let n=0;n<this.scale.length;++n){if(this.scale[n].frame===e)return void(this.scale[n].scale=t);if(this.scale[n].frame>e)return void this.scale.splice(n,0,new ie(e,t))}this.scale.push(new ie(e,t))}else this.scale=[new ie(e,t)]}removeTranslation(e){if(this.translation)for(let t=0;t<this.translation.length;++t)if(this.translation[t].frame===e)return void this.translation.splice(t,1)}removeRotation(e){if(this.rotation)for(let t=0;t<this.rotation.length;++t)if(this.rotation[t].frame===e)return void this.rotation.splice(t,1)}removeScale(e){if(this.scale)for(let t=0;t<this.scale.length;++t)if(this.scale[t].frame===e)return void this.scale.splice(t,1)}getInterpolationKeyIndicesAndAlpha(e,t){if(t.length>0){let n=void 0;for(let s=0;s<t.length&&t[s].frame<=e;++s)n=s;if(void 0===n)return[void 0,void 0,0];let s=void 0,i=0;if(n+1<t.length){s=n+1;let o=t[n].frame;return[n,s,(e-o)/((i=t[s].frame)-o)]}return[n,void 0,0]}return[void 0,void 0,0]}}class ae{constructor(e,t){this.bones=new Map,this.animationName=e,this.skeletonName=t}addBoneAnimationData(e){this.bones.set(e.boneName,e)}getBoneTranslation(e,t){let n=this.bones.get(t);if(n&&n.translation){let[t,s,i]=n.getInterpolationKeyIndicesAndAlpha(e,n.translation);if(void 0===t)return;{if(void 0===s)return n.translation[t].translation.clone();let e=n.translation[t].translation,o=(new M.w).subVectors(n.translation[s].translation,e);return(new M.w).addVectors(e,o.multiplyScalar(i))}}}getBoneRotation(e,t){let n=this.bones.get(t);if(n&&n.rotation){let[t,s,i]=n.getInterpolationKeyIndicesAndAlpha(e,n.rotation);if(void 0===t)return;{if(void 0===s)return n.rotation[t].angle;let e=n.rotation[t].angle;return e+(n.rotation[s].angle-e)*i}}}getBoneScale(e,t){let n=this.bones.get(t);if(n&&n.scale){let[t,s,i]=n.getInterpolationKeyIndicesAndAlpha(e,n.scale);if(void 0===t)return;{if(void 0===s)return n.scale[t].scale;let e=n.scale[t].scale;return e+(n.scale[s].scale-e)*i}}}hasTranslationKeyframe(e,t){let n=this.bones.get(t);if(void 0!==n&&void 0!==n.translation)for(const t of n.translation){if(t.frame===e)return!0;if(t.frame>e)return!1}return!1}hasRotationKeyframe(e,t){let n=this.bones.get(t);if(void 0!==n&&void 0!==n.rotation)for(const t of n.rotation){if(t.frame===e)return!0;if(t.frame>e)return!1}return!1}createJsonObject(){let e={};e.animationName=this.animationName,e.skeletonName=this.skeletonName,e.bones=[];for(const t of this.bones.values()){let n={};if(n.boneName=t.boneName,t.translation&&ee.isIterable(t.translation)){let e=[];for(const n of t.translation){let t={};t.frame=n.frame,t.translation=[n.translation.x,n.translation.y],e.push(t)}n.translation=e}if(t.rotation&&ee.isIterable(t.rotation)){let e=[];for(const n of t.rotation){let t={};t.frame=n.frame,t.angle=n.angle,e.push(t)}n.rotation=e}if(t.scale&&ee.isIterable(t.scale)){let e=[];for(const n of t.scale){let t={};t.frame=n.frame,t.angle=n.scale,e.push(t)}n.scale=e}e.bones.push(n)}return e}}class re{constructor(e,t){this.zOffset=0,this.meshName=e,this.boneName=t}}class le{constructor(e,t){this.components=[],this.skinName=e,this.skeletonName=t}}class he{constructor(e,t){this.blob=e,this.imageBitmap=t}}class de{constructor(){this.images=new Map,this.onImagesChanged=new i,this.meshes=new Map,this.onMeshesChanged=new i,this.skeletons=new Map,this.onSkeletonsChanged=new i,this.animations=new Map,this.onAnimationsChanged=new i,this.skins=new Map,this.onSkinsChanged=new i}loadImage(e,t){return new Promise((n,s)=>{createImageBitmap(t).then(s=>{this.images.set(e,new he(t,s)),console.log("loaded image "+e),this.onImagesChanged.execute(void 0),n()},t=>{console.log("error loading image "+e+": "+t),s()})})}removeImage(e){this.images.delete(e)}addMesh(e){this.meshes.set(e.meshName,e),this.onMeshesChanged.execute(void 0)}loadSkeleton(e){if(!e.name)return;let t=new $(e.name),n=!0;e.bones&&(e.bones.forEach((e,s)=>{if(!n)return;if(!e.name)return void(n=!1);let i=0,o=0,a=!!e.isConnected&&e.isConnected;!a&&e.translation&&2==e.translation.length&&(i=e.translation[0],o=e.translation[1]);let r=e.rotation?e.rotation:0;t.addBone(e.name,i,o,r),e.isConnected&&t.setIsBoneConnected(s,a),e.length&&t.setBoneLength(s,e.length)}),e.bones.forEach((e,n)=>{if(e.children)for(let s of e.children)t.attachBone(s,n)})),e.ikConstraints&&e.ikConstraints.forEach(e=>{n&&(void 0!==e.targetBone&&void 0!==e.bones&&2===e.bones.length?t.addIKConstraint(e.targetBone,e.bones):n=!1)}),n&&(this.skeletons.set(t.name,t),this.onSkeletonsChanged.execute(void 0))}loadAnimation(e){if(!e.animationName||!e.skeletonName)return;let t=new ae(e.animationName,e.skeletonName);if(ee.isIterable(e.bones))for(let n of e.bones){if(!n.boneName)return;let e=new oe(n.boneName);if(n.translation){let t=void 0;for(let s of n.translation){if(void 0===t)t=s.frame;else if(s.frame<=t)return;e.insertTranslation(s.frame,s.translation)}}if(n.rotation){let t=void 0;for(let s of n.rotation){if(void 0===t)t=s.frame;else if(s.frame<=t)return;e.insertRotation(s.frame,s.angle)}}if(n.scale){let t=void 0;for(let s of n.scale){if(void 0===t)t=s.frame;else if(s.frame<=t)return;e.insertScale(s.frame,s.rotation)}}t.addBoneAnimationData(e),this.animations.set(t.animationName,t),this.onAnimationsChanged.execute(void 0)}}loadSkin(e){if(!e.skinName||!e.skeletonName)return;let t=new le(e.skinName,e.skeletonName);if(e.components)for(let n of e.components){if(!n.meshName||!n.boneName)continue;let e=new re(n.meshName,n.boneName);n.zOffset&&(e.zOffset=n.zOffset),t.components.push(e)}this.skins.set(t.skinName,t),this.onSkinsChanged.execute(void 0)}loadMesh(e){let t=new B;e.meshName&&(t.meshName=e.meshName),e.textureName&&(t.textureName=e.textureName),e.vertices&&e.vertices.forEach(e=>{t.addVertex(e.x,e.y,e.u,e.v)}),e.lines&&e.lines.forEach(e=>{t.addLine(e.v1,e.v2)}),e.triangles&&e.triangles.forEach(e=>{t.addTriangle(e.v1,e.v2,e.v3)}),e.quads&&e.quads.forEach(e=>{t.addQuad(e.v1,e.v2,e.v3,e.v4)}),this.meshes.set(t.meshName,t),this.onMeshesChanged.execute(void 0)}loadJson(e){console.log(e);let t=JSON.parse(e);t.skeletons&&t.skeletons.forEach(e=>{this.loadSkeleton(e)}),t.animations&&t.animations.forEach(e=>{this.loadAnimation(e)}),t.skins&&t.skins.forEach(e=>{this.loadSkin(e)}),t.meshes&&t.meshes.forEach(e=>{this.loadMesh(e)})}getZipEntries(e){return new Promise((t,n)=>{zip.createReader(new zip.BlobReader(e),e=>{e.getEntries(t)},e=>{console.log(e),n()})})}async loadZip(e){let t=await this.getZipEntries(e);for(const e of t)e.filename.endsWith("png")?e.getData(new zip.BlobWriter("image/png"),t=>{this.loadImage(e.filename,t)}):e.filename.endsWith("json")&&e.getData(new zip.BlobWriter("application/json"),e=>{let t=new FileReader;t.onload=(()=>{"string"==typeof t.result&&this.loadJson(t.result)}),t.readAsText(e)})}addBlobToZip(e,t,n){return new Promise((s,i)=>{n.add(e,new zip.BlobReader(t),()=>{s(n)})})}addTextToZip(e,t,n){return new Promise((s,i)=>{n.add(e,new zip.TextReader(t),()=>{s(n)})})}createZipWriter(){return new Promise((e,t)=>{zip.createWriter(new zip.BlobWriter("application/zip"),t=>{e(t)},e=>{console.log(e),t()})})}writeZip(e){return new Promise(t=>{e.close(e=>{t(e)})})}async downloadZip(){let e=await this.createZipWriter();for(const[t,n]of this.images)await this.addBlobToZip(t,n.blob,e);let t={skeletons:[],animations:[],skins:[],meshes:[]};for(const[e,n]of this.skeletons)t.skeletons.push(n.createJsonObject());for(const[e,n]of this.animations)t.animations.push(n.createJsonObject());for(const[e,n]of this.skins)t.skins.push(n);for(const[e,n]of this.meshes)t.meshes.push(n);let n=JSON.stringify(t);await this.addTextToZip("meshes.json",n,e);let s=await this.writeZip(e),i=URL.createObjectURL(s),o=document.createElement("a");document.body.appendChild(o),o.style.display="none",o.href=i,o.download="project.zip",o.click(),o.parentNode&&o.parentNode.removeChild(o),window.URL.revokeObjectURL(i)}}class ce{constructor(){this.scene=new M.t,this.onUndo=new i,this.onRedo=new i,this.scene.background=new M.d(1315860)}disableActiveContext(){this.activeContext&&this.activeContext.disable()}setActiveContext(e){this.disableActiveContext(),this.activeContext=e,this.activeContext.enable()}disable(){this.disableActiveContext()}}class me{constructor(e,t){this.isEnabled=!1,this.onUndo=new i,this.onRedo=new i,this.onUndo.bind(e),this.onRedo.bind(t),this.keyDownListener=this.handleKeyDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,document.addEventListener("keydown",this.keyDownListener))}disable(){this.isEnabled&&(this.isEnabled=!1,document.removeEventListener("keydown",this.keyDownListener))}handleKeyDown(e){"KeyZ"===e.code&&(e.ctrlKey&&!e.shiftKey?this.onUndo.execute(void 0):e.ctrlKey&&e.shiftKey&&this.onRedo.execute(void 0))}}class ue{constructor(e){this.isEnabled=!1,this.middleButtonDown=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener,!0),this.worldView.addEventListener("mousedown",this.mouseDownListener,!0),this.worldView.addEventListener("mouseup",this.mouseUpListener,!0))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener,!0),this.worldView.removeEventListener("mousedown",this.mouseDownListener,!0),this.worldView.removeEventListener("mouseup",this.mouseUpListener,!0))}handleMouseMove(e){this.middleButtonDown&&(this.world.camera.position.x+=-e.movementX/this.world.camera.zoom,this.world.camera.position.y+=e.movementY/this.world.camera.zoom,this.world.render())}handleMouseDown(e){1!==e.button||this.middleButtonDown||(this.middleButtonDown=!0)}handleMouseUp(e){1===e.button&&(this.middleButtonDown=!1)}}class we{constructor(e){this.isEnabled=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.wheelListener=this.handleWheel.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("wheel",this.wheelListener,{capture:!0,passive:!0}))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("wheel",this.wheelListener,!0))}handleWheel(e){let t=e.deltaY>0?.1:-.1;this.world.camera.zoom-=t,this.world.camera.zoom=Math.min(this.world.camera.zoom,5),this.world.camera.zoom=Math.max(this.world.camera.zoom,.1),this.world.camera.updateProjectionMatrix(),this.world.render()}}class pe{constructor(e,t){this.isEnabled=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.selectable=t,this.mouseDownListener=this.handleMouseDown.bind(this),this.keyDownListener=this.handleKeyDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousedown",this.mouseDownListener,!0),document.addEventListener("keydown",this.keyDownListener))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousedown",this.mouseDownListener,!0),document.removeEventListener("keydown",this.keyDownListener))}handleMouseDown(e){if(0===e.button&&!e.ctrlKey){e.shiftKey||this.selectable.deselectAll();let t=this.world.getMouseWorldPosition();this.selectable.trySelectAtMousePosition(t.x,t.y,this.world.camera.zoom),this.world.render()}}handleKeyDown(e){switch(e.code){case"KeyA":this.selectable.toggleSelectAll(),this.world.render()}}}class ge{constructor(e){this.editableMesh=e,this.selectedVertices=e.getSelectedVertices()}}var be;!function(e){e[e.Vertices=0]="Vertices",e[e.Edges=1]="Edges"}(be||(be={}));class fe{constructor(e){this.selectionType=be.Vertices,this.editableSkeleton=e,this.selectedIndices=Array.from(e.selectedIndices),this.selectionType=e.selectionType}}class xe{constructor(e,t,n,s){this.startingPositions=[],this.meshName=e,this.resourceManager=t,this.selection=n,this.deltaPosition=s;let i=t.meshes.get(e);if(i)for(let e of n)this.startingPositions.push(i.getVertexPosition(e))}apply(){let e=this.resourceManager.meshes.get(this.meshName);this.selection.forEach((t,n)=>{e&&e.setVertexPosition(t,(new M.w).addVectors(this.startingPositions[n],this.deltaPosition))})}revert(){let e=this.resourceManager.meshes.get(this.meshName);this.selection.forEach((t,n)=>{e&&e.setVertexPosition(t,this.startingPositions[n])})}}class ve{constructor(e,t){this.startingPositions=[],this.deltaPosition=new M.w(0,0),this.selection=e,this.world=t,this.selection.selectedVertices.forEach(e=>{this.startingPositions.push(this.selection.editableMesh.getVertexPosition(e))})}onMouseMove(){this.selection.selectedVertices.forEach((e,t)=>{this.selection.editableMesh.setVertexPosition(e,(new M.w).addVectors(this.startingPositions[t],this.deltaPosition))})}createGrabAction(){return new xe(this.selection.editableMesh.meshData.meshName,this.world.resourceManager,this.selection.selectedVertices,this.deltaPosition)}}class ke{constructor(e,t,n){this.skeletonName=e,this.resourceManager=t,this.cachedSkeletonData=n}swapSkeletonData(){let e=this.resourceManager.skeletons.get(this.skeletonName);if(e){let t=e.clone();this.resourceManager.skeletons.set(this.skeletonName,this.cachedSkeletonData),this.cachedSkeletonData=t}}apply(){this.swapSkeletonData()}revert(){this.swapSkeletonData()}}class Ee{constructor(e,t){this.startingPositions=[],this.deltaPosition=new M.w(0,0),this.selection=e,this.world=t,this.selection.selectedIndices.forEach(e=>{this.startingPositions.push(this.selection.editableSkeleton.getBoneVertexPosition(e))})}onMouseMove(){this.selection.selectedIndices.forEach((e,t)=>{this.selection.editableSkeleton.setBoneVertexPosition(e,(new M.w).addVectors(this.startingPositions[t],this.deltaPosition))}),this.selection.editableSkeleton.updateBoneData()}createGrabAction(){let e;return this.selection.editableSkeleton.cachedSkeleton.skeletonData&&(e=this.selection.editableSkeleton.cachedSkeleton.skeletonData),new ke(e.name,this.world.resourceManager,e.clone())}}class Se{constructor(e,t,n){this.startingRotations=[],this.angle=0,this.animationName=e,this.resourceManager=t,this.selection=n}apply(){}revert(){}}class ye{constructor(e,t){this.startingPositions=[],this.hadKeyframes=[],this.deltaPosition=new M.w(0,0),this.selection=e,this.world=t,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneEdgeTranslation(e);this.startingPositions.push(t),this.hadKeyframes.push(this.selection.editableSkeleton.hasTranslationKeyframe(e))}),this.selection.editableSkeleton.cachedSkeleton.animationData&&(this.animationName=this.selection.editableSkeleton.cachedSkeleton.animationData.animationName),this.selection.editableSkeleton.updateBoneEdges(!1,!0),this.selection.editableSkeleton.updateVisuals(),this.selection.editableSkeleton.cachedSkeleton.setAnimationData(void 0)}onMouseMove(){let e=this.selection.editableSkeleton.cachedSkeleton.skeletonData;this.selection.selectedIndices.forEach((t,n)=>{console.log("startingPositions[",n,"] = ",this.startingPositions[n]),console.log("deltaPosition = ",this.deltaPosition);let s=this.deltaPosition.clone(),i=this.selection.editableSkeleton.boneEdges[t],o=this.selection.editableSkeleton.cachedSkeleton.cachedBones[i.cachedBoneIndex];if(void 0!==o.parent){let e=this.selection.editableSkeleton.cachedSkeleton.cachedBones[o.parent];s.rotateAround(new M.w,-M.l.degToRad(e.globalRotation))}let a=(new M.w).addVectors(this.startingPositions[n],s);const r=this.selection.editableSkeleton.getBoneIndexFromEdgeIndex(t);e&&void 0!==r&&(e.bones[r].translation=a)}),this.selection.editableSkeleton.updateBoneEdges(!0,!1),this.selection.editableSkeleton.updateVisuals()}createGrabAction(){return new Se(this.animationName,this.world.resourceManager,this.selection.selectedIndices)}}class _e{constructor(e,t,n,s){this.isEnabled=!1,this.onApplyAction=new i,this.onCancel=new i,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.onApplyAction.bind(n),this.onCancel.bind(s),this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selection instanceof ge?this.grabHelper=new ve(this.selection,this.world):this.selection instanceof fe&&(this.selection.selectionType===be.Vertices?this.grabHelper=new Ee(this.selection,this.world):this.grabHelper=new ye(this.selection,this.world)))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.onCancel.execute(void 0))}handleMouseMove(e){this.grabHelper.deltaPosition.x+=e.movementX/this.world.camera.zoom,this.grabHelper.deltaPosition.y+=-e.movementY/this.world.camera.zoom,this.grabHelper.onMouseMove(),this.world.render()}handleMouseDown(e){0===e.button&&this.onApplyAction.execute(this.grabHelper.createGrabAction()),2===e.button&&this.onCancel.execute(void 0)}}class De{constructor(e,t,n,s,i){this.startingPositions=[],this.meshName=e,this.resourceManager=t,this.selection=n,this.pivot=s,this.angle=i;let o=t.meshes.get(e);if(o)for(let e of n)this.startingPositions.push(o.getVertexPosition(e))}apply(){let e=this.resourceManager.meshes.get(this.meshName);this.selection.forEach((t,n)=>{if(!e)return;let s=this.startingPositions[n].clone().rotateAround(this.pivot,this.angle);e.setVertexPosition(t,s)})}revert(){let e=this.resourceManager.meshes.get(this.meshName);this.selection.forEach((t,n)=>{e&&e.setVertexPosition(t,this.startingPositions[n])})}}class Me{constructor(e,t){this.startingPositions=[],this.pivot=new M.w(0,0),this.angle=0,this.selection=e,this.world=t,this.selection.selectedVertices.forEach(e=>{let t=this.selection.editableMesh.getVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length)}onMouseMove(){this.selection.selectedVertices.forEach((e,t)=>{let n=this.startingPositions[t].clone().rotateAround(this.pivot,this.angle);this.selection.editableMesh.setVertexPosition(e,n)})}createRotateAction(){return new De(this.selection.editableMesh.meshData.meshName,this.world.resourceManager,this.selection.selectedVertices,this.pivot,this.angle)}}class Ce{constructor(e,t){this.startingPositions=[],this.pivot=new M.w(0,0),this.angle=0,this.selection=e,this.world=t,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length)}onMouseMove(){this.selection.selectedIndices.forEach((e,t)=>{let n=this.startingPositions[t].clone().rotateAround(this.pivot,this.angle);this.selection.editableSkeleton.setBoneVertexPosition(e,n)}),this.selection.editableSkeleton.updateBoneData()}createRotateAction(){let e;return this.selection.editableSkeleton.cachedSkeleton.skeletonData&&(e=this.selection.editableSkeleton.cachedSkeleton.skeletonData),new ke(e.name,this.world.resourceManager,e.clone())}}class Ae{constructor(e,t){this.startingRotations=[],this.hadKeyframes=[],this.pivot=new M.w(0,0),this.angle=0,this.selection=e,this.world=t,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneEdgeRotation(e);this.startingRotations.push(t),this.hadKeyframes.push(this.selection.editableSkeleton.hasRotationKeyframe(e)),this.pivot.add(this.selection.editableSkeleton.getBoneEdgeHeadPosition(e))}),this.pivot.divideScalar(this.startingRotations.length),this.selection.editableSkeleton.cachedSkeleton.animationData&&(this.animationName=this.selection.editableSkeleton.cachedSkeleton.animationData.animationName),this.selection.editableSkeleton.updateBoneEdges(!1,!0),this.selection.editableSkeleton.updateVisuals(),this.selection.editableSkeleton.cachedSkeleton.setAnimationData(void 0)}onMouseMove(){let e=this.selection.editableSkeleton.cachedSkeleton.skeletonData;this.selection.selectedIndices.forEach((t,n)=>{console.log("startingRotation[",n,"] = ",this.startingRotations[n]),console.log("angle = ",M.l.radToDeg(this.angle));let s=ee.normalizeAngle(this.startingRotations[n]+M.l.radToDeg(this.angle));console.log("rotation = ",s);const i=this.selection.editableSkeleton.getBoneIndexFromEdgeIndex(t);e&&void 0!==i&&(e.bones[i].rotation=s)}),this.selection.editableSkeleton.updateBoneEdges(!0,!1),this.selection.editableSkeleton.updateVisuals()}createRotateAction(){return new Se(this.animationName,this.world.resourceManager,this.selection.selectedIndices)}}class Ie{constructor(e,t,n,s){this.isEnabled=!1,this.onApplyAction=new i,this.onCancel=new i,this.startingAngle=0,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.onApplyAction.bind(n),this.onCancel.bind(s),this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){if(!this.isEnabled){this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selection instanceof ge?this.rotateHelper=new Me(this.selection,this.world):this.selection instanceof fe&&(this.selection.selectionType===be.Vertices?this.rotateHelper=new Ce(this.selection,this.world):this.rotateHelper=new Ae(this.selection,this.world));let e=this.world.getMouseWorldPosition();this.startingAngle=Math.atan2(e.y-this.rotateHelper.pivot.y,e.x-this.rotateHelper.pivot.x)}}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.onCancel.execute(void 0))}handleMouseMove(e){let t=this.world.getMouseWorldPosition(),n=Math.atan2(t.y-this.rotateHelper.pivot.y,t.x-this.rotateHelper.pivot.x);this.rotateHelper.angle=n-this.startingAngle,this.rotateHelper.onMouseMove(),this.world.render()}handleMouseDown(e){0===e.button&&this.onApplyAction.execute(this.rotateHelper.createRotateAction()),2===e.button&&this.onCancel.execute(void 0)}}class Ve{constructor(e,t,n,s,i){this.startingPositions=[],this.meshName=e,this.resourceManager=t,this.selection=n,this.pivot=s,this.scale=i;let o=t.meshes.get(e);if(o)for(let e of n)this.startingPositions.push(o.getVertexPosition(e))}apply(){console.log("scale apply");let e=this.resourceManager.meshes.get(this.meshName);this.selection.forEach((t,n)=>{if(!e)return;let s=this.startingPositions[n].clone().sub(this.pivot),i=this.pivot.clone().add(s.clone().multiplyScalar(this.scale));e.setVertexPosition(t,i)})}revert(){console.log("scale revert");let e=this.resourceManager.meshes.get(this.meshName);this.selection.forEach((t,n)=>{e&&e.setVertexPosition(t,this.startingPositions[n])})}}class Be{constructor(e,t){this.startingPositions=[],this.pivot=new M.w(0,0),this.scale=0,this.selection=e,this.world=t,this.selection.selectedVertices.forEach(e=>{let t=this.selection.editableMesh.getVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length)}onMouseMove(){this.selection.selectedVertices.forEach((e,t)=>{let n=this.startingPositions[t].clone().sub(this.pivot),s=this.pivot.clone().add(n.clone().multiplyScalar(this.scale));this.selection.editableMesh.setVertexPosition(e,s)})}createScaleAction(){return new Ve(this.selection.editableMesh.meshData.meshName,this.world.resourceManager,this.selection.selectedVertices,this.pivot,this.scale)}}class Le{constructor(e,t){this.startingPositions=[],this.pivot=new M.w(0,0),this.scale=0,this.selection=e,this.world=t,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length)}onMouseMove(){this.selection.selectedIndices.forEach((e,t)=>{let n=this.startingPositions[t].clone().sub(this.pivot),s=this.pivot.clone().add(n.clone().multiplyScalar(this.scale));this.selection.editableSkeleton.setBoneVertexPosition(e,s)}),this.selection.editableSkeleton.updateBoneData()}createScaleAction(){let e;return this.selection.editableSkeleton.cachedSkeleton.skeletonData&&(e=this.selection.editableSkeleton.cachedSkeleton.skeletonData),new ke(e.name,this.world.resourceManager,e.clone())}}class Pe{constructor(e,t,n,s){this.isEnabled=!1,this.onApplyAction=new i,this.onCancel=new i,this.startingDistance=0,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.onApplyAction.bind(n),this.onCancel.bind(s),this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){if(!this.isEnabled){this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selection instanceof ge?this.scaleHelper=new Be(this.selection,this.world):this.selection instanceof fe&&(this.scaleHelper=new Le(this.selection,this.world));let e=this.world.getMouseWorldPosition();this.startingDistance=this.scaleHelper.pivot.distanceTo(e),this.startingDistance<1&&(this.startingDistance=1)}}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.onCancel.execute(void 0))}handleMouseMove(e){let t=this.world.getMouseWorldPosition(),n=this.scaleHelper.pivot.distanceTo(t)/this.startingDistance;this.scaleHelper.scale=n,this.scaleHelper.onMouseMove(),this.world.render()}handleMouseDown(e){0===e.button&&this.onApplyAction.execute(this.scaleHelper.createScaleAction()),2===e.button&&this.onCancel.execute(void 0)}}class Re{constructor(e,t,n){this.meshName=e,this.resourceManager=t,this.cachedMeshData=n}swapMeshData(){let e=this.resourceManager.meshes.get(this.meshName);if(e){let t=e.clone();this.resourceManager.meshes.set(this.meshName,this.cachedMeshData),this.cachedMeshData=t}}apply(){this.swapMeshData()}revert(){this.swapMeshData()}}class Ne{constructor(e,t){this.startingPositions=[],this.newVertices=new Map,this.deltaPosition=new M.w(0,0),this.selection=e,this.world=t,this.selection.selectedVertices.forEach(e=>{this.startingPositions.push(this.selection.editableMesh.getVertexPosition(e))});let n=this.selection.editableMesh.getSelectedVertices(),s=this.selection.editableMesh.getSelectedEdges();n.forEach(e=>{let t=this.selection.editableMesh.getVertexPosition(e);this.startingPositions.push(t);let n=this.selection.editableMesh.addVertex(t);this.newVertices.set(e,n),this.selection.editableMesh.deselectVertex(e),this.selection.editableMesh.selectVertex(n)}),n=n.filter(e=>!s.includes(e));let i=0;for(;i<s.length/2;++i){let e=s[2*i],t=s[2*i+1],n=this.newVertices.get(t),o=this.newVertices.get(e);n&&o&&this.selection.editableMesh.addQuad(e,t,n,o)}n.forEach(e=>{let t=this.newVertices.get(e);t&&this.selection.editableMesh.addLine(e,t)})}onMouseMove(){let e=0;this.newVertices.forEach((t,n)=>{this.selection.editableMesh.setVertexPosition(t,(new M.w).addVectors(this.startingPositions[e],this.deltaPosition)),++e})}createExtrudeAction(){let e;return this.selection.editableMesh.meshData&&(e=this.selection.editableMesh.meshData),new Re(e.meshName,this.world.resourceManager,e.clone())}}class ze{constructor(e,t){this.startingPosition=e,this.tailIndex=t}}class Te{constructor(e,t){this.extrudeData=new Map,this.deltaPosition=new M.w(0,0),this.selection=e,this.world=t,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneVertexPosition(e),n=this.selection.editableSkeleton.getBoneVertexParent(e),s=e;void 0===n&&(s=this.selection.editableSkeleton.addBoneVertex(t.x,t.y));let i=this.selection.editableSkeleton.addBoneVertex(t.x,t.y);this.selection.editableSkeleton.createBoneFromBoneVertices(s,i,n),this.extrudeData.set(e,new ze(t,i)),this.selection.editableSkeleton.deselectIndex(e),this.selection.editableSkeleton.selectIndex(i)})}onMouseMove(){this.extrudeData.forEach((e,t)=>{this.selection.editableSkeleton.setBoneVertexPosition(e.tailIndex,(new M.w).addVectors(e.startingPosition,this.deltaPosition))}),this.selection.editableSkeleton.updateBoneData()}createExtrudeAction(){let e;return this.selection.editableSkeleton.cachedSkeleton.skeletonData&&(e=this.selection.editableSkeleton.cachedSkeleton.skeletonData),new ke(e.name,this.world.resourceManager,e.clone())}}class He{constructor(e,t,n,s){this.isEnabled=!1,this.onApplyAction=new i,this.onCancel=new i,this.leftButtonDown=!1,this.rightButtonDown=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.onApplyAction.bind(n),this.onCancel.bind(s),this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selection instanceof ge?this.extrudeHelper=new Ne(this.selection,this.world):this.selection instanceof fe&&(this.extrudeHelper=new Te(this.selection,this.world)))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.onCancel.execute(void 0))}handleMouseMove(e){this.extrudeHelper.deltaPosition.x+=e.movementX/this.world.camera.zoom,this.extrudeHelper.deltaPosition.y+=-e.movementY/this.world.camera.zoom,this.extrudeHelper.onMouseMove(),this.world.render()}handleMouseDown(e){0===e.button&&this.onApplyAction.execute(this.extrudeHelper.createExtrudeAction()),2===e.button&&this.onCancel.execute(void 0)}}class Ke{constructor(e,t,n,s){this.isEnabled=!1,this.onApplyAction=new i,this.onCancel=new i,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.onApplyAction.bind(n),this.onCancel.bind(s),this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){if(!this.isEnabled&&(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),void 0===this.tailIndex)){let e=0,t=void 0;this.selection.selectedIndices.forEach(n=>{let s=this.selection.editableSkeleton.getBoneVertexParent(n);void 0!==s&&(++e,t=s)}),e>1&&(t=void 0);let n=this.world.getMouseWorldPosition(),s=this.selection.editableSkeleton.addBoneVertex(n.x,n.y);this.tailIndex=this.selection.editableSkeleton.addBoneVertex(n.x,n.y);this.selection.editableSkeleton.createBoneFromBoneVertices(s,this.tailIndex,t)}}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.onCancel.execute(void 0))}handleMouseMove(e){if(void 0!==this.tailIndex){let t=this.selection.editableSkeleton.getBoneVertexPosition(this.tailIndex);t.x+=e.movementX/this.world.camera.zoom,t.y+=-e.movementY/this.world.camera.zoom,this.selection.editableSkeleton.setBoneVertexPosition(this.tailIndex,t),this.selection.editableSkeleton.updateBoneData(),this.world.render()}}handleMouseDown(e){if(0===e.button){let e;this.selection.editableSkeleton.cachedSkeleton.skeletonData&&(e=this.selection.editableSkeleton.cachedSkeleton.skeletonData);let t=new ke(e.name,this.world.resourceManager,e.clone());this.onApplyAction.execute(t)}2===e.button&&this.onCancel.execute(void 0)}}class Fe{constructor(e){this.globalPosition=new M.w,this.globalRotation=0,this.localRotation=0,this.children=[],this.boneIndex=e}}class Ue{constructor(e,t,n){this.positiveAngle=!1,this.targetCachedBoneIndex=e,this.cachedBoneIndices=t,this.length0=n}}class We{constructor(){this.currentFrame=0,this.cachedBones=[],this.rootIndices=[],this.cachedIKConstraints=[]}setSkeletonData(e){this.skeletonData=void 0!==e?e.clone():void 0}setAnimationData(e){this.animationData=e}addCachedBone(e){return this.cachedBones.push(new Fe(e))-1}getCachedBoneIndexFromBoneName(e){let t=void 0;return this.cachedBones.forEach((n,s)=>{this.skeletonData&&this.skeletonData.bones[n.boneIndex].name===e&&(t=s)}),t}getBoneTranslation(e){if(!this.skeletonData||e<0||e>=this.skeletonData.bones.length)return new M.w;let t=this.skeletonData.bones[e],n=this.animationData?this.animationData.getBoneTranslation(this.currentFrame,t.name):void 0;return void 0!==n?n:t.translation}getBoneRotation(e){if(!this.skeletonData||e<0||e>=this.skeletonData.bones.length)return 0;let t=this.skeletonData.bones[e],n=this.animationData?this.animationData.getBoneRotation(this.currentFrame,t.name):void 0;return void 0!==n?n:t.rotation}createCachedBones(){if(!this.skeletonData)return;this.cachedBones=[],this.rootIndices=[],this.cachedIKConstraints=[];let e=(t,n)=>{if(!this.skeletonData)return-1;let s=this.skeletonData.bones[t],i=this.addCachedBone(t);for(let t of s.children){let n=e(t,i);this.cachedBones[n].parent=i,this.cachedBones[i].children.push(n)}return i},t=this.skeletonData.getRootIndices();for(let n of t){let t=e(n,void 0);-1!==t&&this.rootIndices.push(t)}let n=e=>{for(let t=0;t<this.cachedBones.length;++t)if(this.cachedBones[t].boneIndex===e)return t};for(const e of this.skeletonData.ikConstraints){let t=n(e.targetBone),s=n(e.bones[0]),i=n(e.bones[1]),o=this.skeletonData.bones[e.bones[1]].translation.length();void 0!==t&&void 0!==s&&void 0!==i&&this.cachedIKConstraints.push(new Ue(t,[s,i],o))}this.updatePose(!1,!1)}updatePose(e,t){if(!this.skeletonData)return;let n=(e,t,s,i)=>{if(!this.skeletonData)return-1;let o=new M.w(0,0),a=0;if(void 0!==t){let e=this.cachedBones[t];o=e.globalPosition,a=e.globalRotation}let r=new M.w,l=this.cachedBones[e],h=l.boneIndex,d=this.getBoneTranslation(h).clone();if(d.rotateAround(r,M.l.degToRad(a)),l.globalPosition=(new M.w).addVectors(o,d),s&&(l.localRotation=this.getBoneRotation(h)),i){let e=this.skeletonData.bones[h];e.translation=this.getBoneTranslation(h).clone(),e.rotation=l.localRotation}l.globalRotation=ee.normalizeAngle(a+l.localRotation);for(let t of l.children)n(t,e,s,i)};for(let e of this.rootIndices)n(e,void 0,!0,t);if(e){this.solveIKConstraints();for(let e of this.rootIndices)n(e,void 0,!1,!1)}}solveIKConstraints(){if(this.skeletonData)for(const e of this.cachedIKConstraints){let t=e.length0,n=this.cachedBones[e.cachedBoneIndices[0]],s=this.cachedBones[e.cachedBoneIndices[1]],i=this.skeletonData.bones[n.boneIndex],o=this.skeletonData.bones[s.boneIndex],a=o.length,r=this.cachedBones[e.targetCachedBoneIndex],l=(new M.w).subVectors(r.globalPosition,n.globalPosition),h=l.length(),d=ee.normalizeAngle(M.l.radToDeg(Math.atan2(l.y,l.x))-90);if(t+a<h)n.localRotation=d,s.localRotation=0;else{let r=(h*h+t*t-a*a)/(2*h*t),l=M.l.radToDeg(Math.acos(r)),c=(a*a+t*t-h*h)/(2*a*t),m=M.l.radToDeg(Math.acos(c));console.log("angle0 = ",l,", angle1 = ",m),e.positiveAngle?(i.rotation=d-l,o.rotation=180-m):(n.localRotation=d+l,s.localRotation=-180+m)}if(console.log(n),void 0!==n.parent){let e=this.cachedBones[n.parent];console.log("parentRot ",e.globalRotation),console.log("cachedBone0.localRotation = ",n.localRotation),n.localRotation=ee.normalizeAngle(n.localRotation-e.globalRotation),console.log("cachedBone0.localRotation = ",n.localRotation)}console.log("diff = ",l.x," ",l.y),console.log("atan = ",d),console.log(n.localRotation," ",s.localRotation)}}}class Oe{constructor(){this.points=new M.r,this.lines=new M.j,this.faces=new M.m,this.dashedLines=new M.j,this.points.position.z=2,this.points.material=new M.s({vertexColors:M.x,size:5,sizeAttenuation:!1}),this.lines.position.z=1,this.lines.material=new M.h({vertexColors:M.x}),this.faces.material=new M.n({color:16777215,opacity:.2,transparent:!0,side:M.f}),this.dashedLines.position.z=1,this.dashedLines.material=new M.i({color:5263440,dashSize:4,gapSize:2})}createVisuals(e,t,n,s){let i=[],o=[],a=[],r=[],l=[],h=[],d=0,c=(e,t,n)=>(i.push(e),i.push(t),i.push(0),o.push(n?1:.5),o.push(n?.661:.5),o.push(n?.188:.5),d++);t.forEach((i,o)=>{if(void 0!==i.tail){let t=new M.w(e[i.head].x,e[i.head].y),h=new M.w(e[i.tail].x,e[i.tail].y),d=(new M.w).subVectors(h,t),m=d.length(),u=m>=20?10:.5*m;d.multiplyScalar(1/m);let w=new M.w(d.y,-d.x);d.multiplyScalar(u);let p,g,b=(new M.w).addVectors(t,d).add(w.multiplyScalar(2)),f=(new M.w).addVectors(t,d).add(w.multiplyScalar(-2));s===be.Vertices?(p=n.has(i.head),g=n.has(i.tail)):g=p=n.has(o);let x=c(t.x,t.y,p),v=c(b.x,b.y,p),k=c(f.x,f.y,p),E=c(h.x,h.y,g);a.push(x),a.push(E),r.push(x),r.push(v),r.push(v),r.push(E),r.push(E),r.push(k),r.push(k),r.push(x),l.push(x),l.push(k),l.push(v),l.push(v),l.push(k),l.push(E)}else{let t,l=new M.w(e[i.head].x,e[i.head].y);t=s===be.Vertices?n.has(i.head):n.has(o);let h=c(l.x,l.y,t);a.push(h);let d=c(l.x-10,l.y,t),m=c(l.x+10,l.y,t),u=c(l.x,l.y+10,t),w=c(l.x,l.y-10,t);r.push(d),r.push(m),r.push(u),r.push(w)}i.children.forEach(n=>{let s=t[n];if(s.head!==i.getTailIndex()){let t=e[i.getTailIndex()],n=e[s.head];h.push(t.x,t.y,0),h.push(n.x,n.y,0)}})});let m=new Float32Array(i),u=new Float32Array(o),w=new Uint32Array(a),p=new Uint32Array(r),g=new Uint32Array(l),b=new M.c;b.addAttribute("position",new M.b(m,3)),b.addAttribute("color",new M.g(u,3)),b.setIndex(new M.b(w,1)),this.points.geometry=b;let f=new M.c;f.addAttribute("position",new M.b(m,3)),f.addAttribute("color",new M.g(u,3)),f.setIndex(new M.b(p,1)),this.lines.geometry=f;let x=new M.c;x.addAttribute("position",new M.b(m,3)),x.setIndex(new M.b(g,1)),this.faces.geometry=x;let v=new M.c;v.addAttribute("position",new M.g(h,3)),this.dashedLines.geometry=v,this.dashedLines.computeLineDistances()}addToScene(e,t){t&&(this.points.position.z=43,e.add(this.points)),this.lines.position.z=42,this.dashedLines.position.z=41,this.faces.position.z=40,e.add(this.lines),e.add(this.faces),e.add(this.dashedLines)}toggleWireframe(){this.points.visible=!this.points.visible,this.lines.visible=!this.lines.visible,this.dashedLines.visible=!this.dashedLines.visible,this.faces.visible=!this.faces.visible}}class je{constructor(e){this.meshRenderer=new L,this.rotationOffset=0,this.cachedBoneIndex=e}}class Ze{constructor(e){this.attachedMeshes=[],this.cachedSkeleton=e}async setSkinData(e,t){for(let n of e.components){let e=this.cachedSkeleton.getCachedBoneIndexFromBoneName(n.boneName),s=t.meshes.get(n.meshName);if(e&&s){let i=this.cachedSkeleton.cachedBones[e],o=new je(e);await o.meshRenderer.createMeshFromMeshData(s,t);let a=i.globalPosition;o.rotationOffset=i.globalRotation,o.meshRenderer.setPivot(a.x,a.y),o.meshRenderer.mesh.position.z=n.zOffset,this.attachedMeshes.push(o)}}this.updateAttachedMeshes()}updateAttachedMeshes(){for(let e of this.attachedMeshes){let t=this.cachedSkeleton.cachedBones[e.cachedBoneIndex];e.meshRenderer.setPosition(t.globalPosition.x,t.globalPosition.y),e.meshRenderer.setRotation(ee.normalizeAngle(t.globalRotation-e.rotationOffset)),e.meshRenderer.updateTransform()}}addToScene(e){for(let t of this.attachedMeshes)e.add(t.meshRenderer.mesh)}removeFromScene(e){for(let t of this.attachedMeshes)e.remove(t.meshRenderer.mesh)}}class qe{constructor(){this.x=0,this.y=0}}class Je{constructor(e,t,n){this.children=[],this.cachedBoneIndex=e,this.head=t,this.tail=n}getTailIndex(){return void 0!==this.tail?this.tail:this.head}}class Ye{constructor(){this.boneVertices=[],this.boneEdges=[],this.rootIndices=[],this.selectionType=be.Vertices,this.selectedIndices=new Set,this.cachedSkeleton=new We,this.skeletonVisuals=new Oe,this.skins=[]}setSkeletonData(e,t){this.cachedSkeleton.setSkeletonData(t.skeletons.get(e)),this.createBoneEdges()}setAnimationData(e,t){this.cachedSkeleton.setAnimationData(t.animations.get(e)),this.cachedSkeleton.animationData&&(this.selectionType=be.Edges)}resetSelection(){this.selectedIndices.clear()}createBoneEdges(){if(!this.cachedSkeleton.skeletonData)return;this.cachedSkeleton.createCachedBones(),this.boneVertices=[],this.boneEdges=[],this.rootIndices=[];let e=(t,n)=>{let s=this.cachedSkeleton.skeletonData;if(!s)return-1;let i,o=this.cachedSkeleton.cachedBones[t],a=o.boneIndex,r=s.bones[a];i=void 0!==n&&r.isConnected?this.boneEdges[n].getTailIndex():this.addBoneVertex();let l=void 0;r.length>0&&(l=this.addBoneVertex());let h=this.addBoneEdge(t,i,l);for(let t of o.children){let n=e(t,h);this.boneEdges[h].children.push(n)}return h};for(let t of this.cachedSkeleton.rootIndices){let n=e(t,void 0);-1!==n&&this.rootIndices.push(n)}this.updateBoneEdges(!1,!1),this.updateVisuals()}updateBoneEdges(e,t){if(!this.cachedSkeleton.skeletonData)return;this.cachedSkeleton.updatePose(e,t),this.updateSkins();let n=(e,t)=>{let s=this.cachedSkeleton.skeletonData;if(!s)return;let i=new M.w,o=this.boneEdges[e],a=this.cachedSkeleton.cachedBones[o.cachedBoneIndex],r=s.bones[a.boneIndex];if(this.setBoneVertexPosition(o.head,a.globalPosition),o.tail){let e=new M.w(0,r.length);e.rotateAround(i,M.l.degToRad(a.globalRotation));let t=(new M.w).addVectors(a.globalPosition,e);this.setBoneVertexPosition(o.tail,new M.w(t.x,t.y))}for(let t of o.children)n(t,e)};for(let e of this.rootIndices)n(e,void 0)}updateBoneData(){for(let e of this.rootIndices)this.updateBoneDataRecursive(e,void 0);this.updateVisuals()}updateBoneDataRecursive(e,t){let n=this.cachedSkeleton.skeletonData;if(!n)return;let s=this.boneEdges[e],i=this.cachedSkeleton.cachedBones[s.cachedBoneIndex],o=n.bones[i.boneIndex],a=this.boneVertices[s.head],r=o.rotation,l=0;if(void 0!==s.tail){let e=this.boneVertices[s.tail],n=(new M.w).subVectors(new M.w(e.x,e.y),new M.w(a.x,a.y));if(l=n.length(),i.globalRotation=ee.normalizeAngle(M.l.radToDeg(Math.atan2(n.y,n.x))-90),r=i.globalRotation,void 0!==t){let e=this.boneEdges[t],n=this.cachedSkeleton.cachedBones[e.cachedBoneIndex];r=ee.normalizeAngle(i.globalRotation-n.globalRotation)}}else if(i.globalRotation=r,void 0!==t){let e=this.boneEdges[t],n=this.cachedSkeleton.cachedBones[e.cachedBoneIndex];r=ee.normalizeAngle(r+n.globalRotation)}let h=new M.w(a.x,a.y),d=!1;if(void 0!==t){let e=this.boneEdges[t],n=this.cachedSkeleton.cachedBones[e.cachedBoneIndex];r=ee.normalizeAngle(i.globalRotation-n.globalRotation);let o=this.boneVertices[e.head];h.sub(new M.w(o.x,o.y)),h.rotateAround(new M.w,M.l.degToRad(-n.globalRotation)),s.head===e.getTailIndex()&&(d=!0)}o.translation=h,o.rotation=r,o.length=l,o.isConnected=d;for(let t of o.children){this.updateBoneDataRecursive(t,e)}}addBoneVertex(e,t){let n=this.boneVertices.push(new qe)-1;return void 0!==e&&void 0!==t&&this.setBoneVertexPosition(n,new M.w(e,t)),n}addBoneEdge(e,t,n){return this.boneEdges.push(new Je(e,t,n))-1}createBoneFromBoneVertices(e,t,n){let s=this.cachedSkeleton.skeletonData;if(!s)return-1;let i=this.boneVertices[e],o=this.boneVertices[t],a=(new M.w).subVectors(new M.w(o.x,o.y),new M.w(i.x,i.y)),r=ee.normalizeAngle(M.l.radToDeg(Math.atan2(a.y,a.x))),l=r,h=new M.w(i.x,i.y),d=h,c=!1;if(void 0!==n){let t=this.boneEdges[n],s=this.cachedSkeleton.cachedBones[t.cachedBoneIndex];l=ee.normalizeAngle(r-s.globalRotation);let i=this.boneVertices[t.head];d.sub(new M.w(i.x,i.y)),d.rotateAround(new M.w,M.l.degToRad(-s.globalRotation)),e===t.tail&&(c=!0)}let m=s.addBone("new_bone",d.x,d.y,l),u=s.bones[m],w=this.cachedSkeleton.addCachedBone(m),p=this.cachedSkeleton.cachedBones[w];if(p.globalPosition=h,p.globalRotation=r,u.length=a.length(),u.isConnected=c,void 0!==n){let e=this.boneEdges[n],t=this.cachedSkeleton.cachedBones[e.cachedBoneIndex];s.attachBone(m,t.boneIndex),t.children.push(w),this.boneEdges[n].children.push(m)}return this.addBoneEdge(m,e,t)}toggleSelection(e){this.selectedIndices.has(e)?this.deselectIndex(e):this.selectIndex(e)}selectIndex(e){this.selectedIndices.add(e)}deselectIndex(e){this.selectedIndices.delete(e)}trySelectAtMousePosition(e,t,n){let s=2500/(n*n),i=void 0;if(this.boneVertices.forEach((n,o)=>{let a=e-n.x,r=t-n.y,l=a*a+r*r;l<s&&(s=l,i=o)}),void 0!==i){if(this.selectionType===be.Vertices)this.toggleSelection(i);else{let e;this.boneEdges.forEach((t,n)=>{console.log(t.head," ",t.tail),t.getTailIndex()===i&&(e=n)}),void 0!==e&&this.toggleSelection(e)}this.updateVisuals()}}toggleSelectAll(){let e=Array.from(this.selectedIndices);e.length>0?e.forEach(e=>{this.deselectIndex(e)}):this.boneVertices.forEach((e,t)=>{this.selectIndex(t)}),this.updateVisuals()}deselectAll(){Array.from(this.selectedIndices).forEach(e=>{this.deselectIndex(e)})}getBoneVertexPosition(e){return new M.w(this.boneVertices[e].x,this.boneVertices[e].y)}setBoneVertexPosition(e,t){this.boneVertices[e].x=t.x,this.boneVertices[e].y=t.y}getBoneEdgeHeadPosition(e){let t=this.boneVertices[this.boneEdges[e].head];return new M.w(t.x,t.y)}insertBoneRotation(e,t){if(void 0===this.cachedSkeleton.skeletonData||void 0===this.cachedSkeleton.animationData)return;let n=this.boneEdges[e],s=this.cachedSkeleton.cachedBones[n.cachedBoneIndex],i=this.cachedSkeleton.skeletonData.bones[s.boneIndex].name,o=this.cachedSkeleton.animationData.bones.get(i);if(o)o.insertRotation(this.cachedSkeleton.currentFrame,t);else{let e=new oe(i);e.insertRotation(this.cachedSkeleton.currentFrame,t),this.cachedSkeleton.animationData.addBoneAnimationData(e)}}getBoneEdgeTranslation(e){let t=this.cachedSkeleton.skeletonData,n=this.cachedSkeleton.animationData;if(void 0===t)return new M.w(0,0);let s=this.boneEdges[e],i=this.cachedSkeleton.cachedBones[s.cachedBoneIndex],o=t.bones[i.boneIndex];if(n){let e=n.getBoneTranslation(this.cachedSkeleton.currentFrame,o.name);if(e)return e}return o.translation}getBoneEdgeRotation(e){let t=this.cachedSkeleton.skeletonData,n=this.cachedSkeleton.animationData;if(void 0===t)return 0;let s=this.boneEdges[e],i=this.cachedSkeleton.cachedBones[s.cachedBoneIndex],o=t.bones[i.boneIndex];if(n){let e=n.getBoneRotation(this.cachedSkeleton.currentFrame,o.name);if(e)return e}return o.rotation}hasTranslationKeyframe(e){let t=this.cachedSkeleton.skeletonData,n=this.cachedSkeleton.animationData;if(void 0===t||void 0===n)return!1;let s=this.boneEdges[e],i=this.cachedSkeleton.cachedBones[s.cachedBoneIndex],o=t.bones[i.boneIndex];return n.hasTranslationKeyframe(this.cachedSkeleton.currentFrame,o.name)}hasRotationKeyframe(e){let t=this.cachedSkeleton.skeletonData,n=this.cachedSkeleton.animationData;if(void 0===t||void 0===n)return!1;let s=this.boneEdges[e],i=this.cachedSkeleton.cachedBones[s.cachedBoneIndex],o=t.bones[i.boneIndex];return n.hasRotationKeyframe(this.cachedSkeleton.currentFrame,o.name)}getBoneIndexFromEdgeIndex(e){let t=this.boneEdges[e];return this.cachedSkeleton.cachedBones[t.cachedBoneIndex].boneIndex}getBoneVertexParent(e){for(let t=0;t<this.boneEdges.length;++t)if(this.boneEdges[t].getTailIndex()===e)return t}async addSkins(e){if(this.cachedSkeleton.skeletonData){this.skins=[];for(let[t,n]of e.skins){if(n.skeletonName!==this.cachedSkeleton.skeletonData.name)continue;let t=new Ze(this.cachedSkeleton);await t.setSkinData(n,e),this.skins.push(t)}}}updateSkins(){for(let e of this.skins)e.updateAttachedMeshes()}updateVisuals(){this.skeletonVisuals.createVisuals(this.boneVertices,this.boneEdges,this.selectedIndices,this.selectionType)}addToScene(e,t){this.skeletonVisuals.addToScene(e,t)}addSkinsToScene(e){for(let t of this.skins)t.addToScene(e)}removeSkinsFromScene(e){for(let t of this.skins)t.removeFromScene(e)}toggleWireframe(){this.skeletonVisuals.toggleWireframe()}}class Xe extends ce{constructor(e,t,n,s){super(),this.onApplyAction=new i,this.editableSkeleton=new Ye,this.isDefaultContextActive=!1,this.world=e,this.onApplyAction.bind(t),this.onUndo.bind(n),this.onRedo.bind(s),this.handleApplyAction=this.handleApplyAction.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleUndo=this.handleUndo.bind(this),this.handleRedo=this.handleRedo.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.enableDefaultContext=this.enableDefaultContext.bind(this),this.undoRedoHandler=new me(this.handleUndo,this.handleRedo),this.panHandler=new ue(e),this.zoomHandler=new we(e),this.selectHandler=new pe(e,this.editableSkeleton),this.enableDefaultContext(),this.panHandler.enable(),this.zoomHandler.enable(),this.editableSkeleton.addToScene(this.scene,!0)}handleApplyAction(e){this.onApplyAction.execute(e),this.enableDefaultContext()}handleCancel(){this.enableDefaultContextAndReloadSkeleton()}async handleUndo(){this.onUndo.execute(void 0),await this.showSkeleton(this.currentSkeletonName),this.world.render()}async handleRedo(){this.onRedo.execute(void 0),await this.showSkeleton(this.currentSkeletonName),this.world.render()}disable(){super.disable(),this.disableDefaultContext(),this.panHandler.disable(),this.zoomHandler.disable()}enableDefaultContext(){this.isDefaultContextActive||(this.isDefaultContextActive=!0,this.disableActiveContext(),this.undoRedoHandler.enable(),this.selectHandler.enable(),document.addEventListener("mousedown",this.handleMouseDown),document.addEventListener("keydown",this.handleKeyDown))}async enableDefaultContextAndReloadSkeleton(){this.enableDefaultContext(),await this.showSkeleton(this.currentSkeletonName),this.world.render()}disableDefaultContext(){this.isDefaultContextActive&&(this.isDefaultContextActive=!1,this.undoRedoHandler.disable(),this.selectHandler.disable(),document.removeEventListener("mousedown",this.handleMouseDown),document.removeEventListener("keydown",this.handleKeyDown))}handleMouseDown(e){if(0===e.button&&e.ctrlKey){let e=new fe(this.editableSkeleton);this.disableDefaultContext(),this.setActiveContext(new Ke(this.world,e,this.handleApplyAction,this.handleCancel))}}handleKeyDown(e){switch(e.code){case"KeyE":{let e=new fe(this.editableSkeleton);e.selectedIndices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new He(this.world,e,this.handleApplyAction,this.handleCancel)));break}case"KeyG":{let e=new fe(this.editableSkeleton);e.selectedIndices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new _e(this.world,e,this.handleApplyAction,this.handleCancel)));break}case"KeyR":{let e=new fe(this.editableSkeleton);e.selectedIndices.length>1&&(this.disableDefaultContext(),this.setActiveContext(new Ie(this.world,e,this.handleApplyAction,this.handleCancel)));break}case"KeyS":{let e=new fe(this.editableSkeleton);e.selectedIndices.length>1&&(this.disableDefaultContext(),this.setActiveContext(new Pe(this.world,e,this.handleApplyAction,this.handleCancel)));break}}}async showSkeleton(e){let t=!1;this.currentSkeletonName!==e&&(this.currentSkeletonName=e,this.editableSkeleton.resetSelection(),t=!0),void 0!==e?(this.editableSkeleton.setSkeletonData(e,this.world.resourceManager),t&&(this.editableSkeleton.removeSkinsFromScene(this.scene),await this.editableSkeleton.addSkins(this.world.resourceManager),this.editableSkeleton.addSkinsToScene(this.scene))):this.editableSkeleton.removeSkinsFromScene(this.scene)}}class Ge extends ce{constructor(e,t,n,s){super(),this.onApplyAction=new i,this.editableSkeleton=new Ye,this.isDefaultContextActive=!1,this.world=e,this.onApplyAction.bind(t),this.onUndo.bind(n),this.onRedo.bind(s),this.handleApplyAction=this.handleApplyAction.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleUndo=this.handleUndo.bind(this),this.handleRedo=this.handleRedo.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.enableDefaultContext=this.enableDefaultContext.bind(this),this.undoRedoHandler=new me(this.handleUndo,this.handleRedo),this.panHandler=new ue(e),this.zoomHandler=new we(e),this.selectHandler=new pe(e,this.editableSkeleton),this.enableDefaultContext(),this.panHandler.enable(),this.zoomHandler.enable(),this.editableSkeleton.addToScene(this.scene,!1)}handleApplyAction(e){this.onApplyAction.execute(e),this.enableDefaultContext()}handleCancel(){}async handleUndo(){this.onUndo.execute(void 0),await this.showAnimation(this.currentAnimationName),this.world.render()}async handleRedo(){this.onRedo.execute(void 0),await this.showAnimation(this.currentAnimationName),this.world.render()}disable(){super.disable(),this.disableDefaultContext(),this.panHandler.disable(),this.zoomHandler.disable()}enableDefaultContext(){this.isDefaultContextActive||(this.isDefaultContextActive=!0,this.disableActiveContext(),this.undoRedoHandler.enable(),this.selectHandler.enable(),document.addEventListener("keydown",this.handleKeyDown))}disableDefaultContext(){this.isDefaultContextActive&&(this.isDefaultContextActive=!1,this.undoRedoHandler.disable(),this.selectHandler.disable(),document.removeEventListener("keydown",this.handleKeyDown))}handleKeyDown(e){switch(e.code){case"KeyG":{let e=new fe(this.editableSkeleton);e.selectedIndices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new _e(this.world,e,this.handleApplyAction,this.handleCancel)));break}case"KeyR":{let e=new fe(this.editableSkeleton);e.selectedIndices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new Ie(this.world,e,this.handleApplyAction,this.handleCancel)));break}case"KeyW":this.editableSkeleton.toggleWireframe(),this.world.render();break;case"Space":this.toggleAnimation()}}async showAnimation(e){if(void 0!==e){let t=this.world.resourceManager.animations.get(e);t&&(this.editableSkeleton.setSkeletonData(t.skeletonName,this.world.resourceManager),await this.editableSkeleton.addSkins(this.world.resourceManager),this.editableSkeleton.addSkinsToScene(this.scene),this.editableSkeleton.setAnimationData(e,this.world.resourceManager),this.editableSkeleton.updateBoneEdges(!0,!1),this.editableSkeleton.updateVisuals())}}setFrame(e){this.editableSkeleton.cachedSkeleton.currentFrame=e,this.editableSkeleton.updateBoneEdges(!0,!1),this.editableSkeleton.updateVisuals(),console.log(this.editableSkeleton.cachedSkeleton.animationData)}toggleAnimation(){void 0===this.animationStart?(console.log("StartAnimation"),this.animationStart=window.performance.now(),requestAnimationFrame(e=>this.animationTick(e))):(console.log("StopAnimation"),this.animationStart=void 0)}animationTick(e){if(void 0!==this.animationStart){requestAnimationFrame(e=>this.animationTick(e));let t=Math.floor((e-this.animationStart)/16.6666)%120;this.editableSkeleton.cachedSkeleton.currentFrame!==t&&(this.editableSkeleton.cachedSkeleton.currentFrame=t,this.editableSkeleton.updateBoneEdges(!0,!1),this.editableSkeleton.updateVisuals(),this.world.render())}}}class Qe{constructor(e,t){this.width=e,this.height=t}isValid(){return 0!==this.width&&0!==this.height}}class $e{constructor(){this.meshData=new B,this.backgroundRenderer=new L,this.positionBuffer=new Float32Array(0),this.edgeColorBuffer=new Float32Array(0),this.faceColorBuffer=new Float32Array(0),this.edgeIndices=new Uint32Array(0),this.faceIndices=new Uint32Array(0),this.edges=new Map,this.selectedVertices=new Set,this.points=new M.r,this.lines=new M.j,this.faces=new M.m,this.points.position.z=2,this.points.material=new M.s({vertexColors:M.x,size:5,sizeAttenuation:!1}),this.lines.position.z=1,this.lines.material=new M.h({vertexColors:M.x}),this.faces.material=new M.n({color:16777215,opacity:.2,transparent:!0,side:M.f})}async setMeshData(e,t){let n=t.meshes.get(e);if(n){this.meshData=n.clone(),this.createBuffers(),await this.backgroundRenderer.createMeshFromMeshData(n,t);const e=t.images.get(n.textureName),s=e?e.imageBitmap:void 0;s&&(this.textureDimensions=new Qe(s.width,s.height))}else this.reset()}reset(){this.resetSelection(),this.meshData=new B,this.createBuffers()}resetSelection(){this.selectedVertices.clear()}addVertex(e){let t=this.meshData.addVertex(e.x,e.y);return this.createBuffers(),t}addLine(e,t){this.meshData.addLine(e,t),this.createBuffers()}addTriangle(e,t,n){this.meshData.addTriangle(e,t,n),this.createBuffers()}addQuad(e,t,n,s){this.meshData.addQuad(e,t,n,s),this.createBuffers()}addEdge(e,t){e>t&&([e,t]=[t,e]);let n=this.edges.get(e);n&&!n.includes(t)&&(n.push(t),this.edges.set(e,n)),n||this.edges.set(e,[t])}createBuffers(){this.positionBuffer=this.meshData.generatePositionBuffer(),this.faceIndices=this.meshData.generateFaceIndices(),this.edgeColorBuffer=new Float32Array(3*this.meshData.vertices.length),this.faceColorBuffer=new Float32Array(3*this.meshData.vertices.length),this.meshData.vertices.forEach((e,t)=>{let n=this.selectedVertices.has(t);this.edgeColorBuffer[3*t]=n?1:.5,this.edgeColorBuffer[3*t+1]=n?1:.5,this.edgeColorBuffer[3*t+2]=n?1:.5,this.faceColorBuffer[3*t]=n?1:.5,this.faceColorBuffer[3*t+1]=n?1:.5,this.faceColorBuffer[3*t+2]=n?1:.5}),this.edges.clear(),this.meshData.lines.forEach((e,t)=>{this.addEdge(e.v1,e.v2)}),this.meshData.triangles.forEach((e,t)=>{this.addEdge(e.v1,e.v2),this.addEdge(e.v2,e.v3),this.addEdge(e.v3,e.v1)}),this.meshData.quads.forEach((e,t)=>{this.addEdge(e.v1,e.v2),this.addEdge(e.v2,e.v3),this.addEdge(e.v3,e.v4),this.addEdge(e.v4,e.v1)});let e=0;for(let t of this.edges.values())e+=t.length;this.edgeIndices=new Uint32Array(2*e);let t=0;this.edges.forEach((e,n)=>{for(let s of e)this.edgeIndices[t]=n,this.edgeIndices[t+1]=s,t+=2}),this.updateMeshes()}updateMeshes(){let e=new M.c;e.addAttribute("position",new M.b(this.positionBuffer,3)),e.setIndex(new M.b(this.faceIndices,1)),this.faces.geometry=e;let t=new M.c;t.addAttribute("position",new M.b(this.positionBuffer,3)),t.addAttribute("color",new M.g(this.edgeColorBuffer,3)),t.setIndex(new M.b(this.edgeIndices,1)),this.lines.geometry=t;let n=new M.c;n.addAttribute("position",new M.b(this.positionBuffer,3)),n.addAttribute("color",new M.g(this.edgeColorBuffer,3)),this.points.geometry=n}toggleVertexSelection(e){this.selectedVertices.has(e)?this.deselectVertex(e):this.selectVertex(e)}selectVertex(e){this.selectedVertices.add(e)}deselectVertex(e){this.selectedVertices.delete(e)}trySelectAtMousePosition(e,t,n){let s=2500/(n*n),i=null;this.meshData.vertices.forEach((n,o)=>{let a=e-n.x,r=t-n.y,l=a*a+r*r;l<s&&(s=l,i=o)}),null!=i&&(this.toggleVertexSelection(i),this.createBuffers())}toggleSelectAll(){let e=this.getSelectedVertices();e.length>0?e.forEach(e=>{this.deselectVertex(e)}):this.meshData.vertices.forEach((e,t)=>{this.selectVertex(t)}),this.createBuffers()}deselectAll(){this.getSelectedVertices().forEach(e=>{this.deselectVertex(e)})}getSelectedVertices(){return Array.from(this.selectedVertices)}getSelectedEdges(){let e=[];return this.selectedVertices.forEach(t=>{let n=this.edges.get(t);if(n){let s=!1;n.forEach(t=>{this.selectedVertices.has(t)&&(s=!0,e.push(t))}),s&&e.push(t)}}),e}getVertexPosition(e){return new M.w(this.meshData.vertices[e].x,this.meshData.vertices[e].y)}setVertexPosition(e,t){this.meshData.vertices[e].x=t.x,this.meshData.vertices[e].y=t.y,this.createBuffers(),this.textureDimensions&&this.textureDimensions.isValid()&&(this.meshData.vertices[e].u=t.x/this.textureDimensions.width,this.meshData.vertices[e].v=t.y/this.textureDimensions.height)}getMeshJson(){return JSON.stringify(this.meshData)}addToScene(e){e.add(this.backgroundRenderer.mesh),e.add(this.faces),e.add(this.lines),e.add(this.points)}}class et extends ce{constructor(e,t,n,s){super(),this.onApplyAction=new i,this.editableMesh=new $e,this.isDefaultContextActive=!1,this.world=e,this.onApplyAction.bind(t),this.onUndo.bind(n),this.onRedo.bind(s),this.handleApplyAction=this.handleApplyAction.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleUndo=this.handleUndo.bind(this),this.handleRedo=this.handleRedo.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.enableDefaultContext=this.enableDefaultContext.bind(this),this.enableDefaultContextAndReloadMesh=this.enableDefaultContextAndReloadMesh.bind(this),this.undoRedoHandler=new me(this.handleUndo,this.handleRedo),this.panHandler=new ue(e),this.zoomHandler=new we(e),this.selectHandler=new pe(e,this.editableMesh),this.enableDefaultContext(),this.panHandler.enable(),this.zoomHandler.enable(),this.editableMesh.addToScene(this.scene)}handleApplyAction(e){this.onApplyAction.execute(e),this.enableDefaultContext()}handleCancel(){this.enableDefaultContextAndReloadMesh()}async handleUndo(){this.onUndo.execute(void 0),await this.showMesh(this.currentMeshName),this.world.render()}async handleRedo(){this.onRedo.execute(void 0),await this.showMesh(this.currentMeshName),this.world.render()}disable(){super.disable(),this.disableDefaultContext(),this.panHandler.disable(),this.zoomHandler.disable()}enableDefaultContext(){this.isDefaultContextActive||(this.isDefaultContextActive=!0,this.disableActiveContext(),this.undoRedoHandler.enable(),this.selectHandler.enable(),document.addEventListener("keydown",this.handleKeyDown))}async enableDefaultContextAndReloadMesh(){this.enableDefaultContext(),await this.showMesh(this.currentMeshName),this.world.render()}disableDefaultContext(){this.isDefaultContextActive&&(this.isDefaultContextActive=!1,this.undoRedoHandler.disable(),this.selectHandler.disable(),document.removeEventListener("keydown",this.handleKeyDown))}handleKeyDown(e){switch(e.code){case"KeyE":{let e=new ge(this.editableMesh);e.selectedVertices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new He(this.world,e,this.handleApplyAction,this.handleCancel)));break}case"KeyG":{let e=new ge(this.editableMesh);e.selectedVertices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new _e(this.world,e,this.handleApplyAction,this.handleCancel)));break}case"KeyR":{let e=new ge(this.editableMesh);e.selectedVertices.length>1&&(this.disableDefaultContext(),this.setActiveContext(new Ie(this.world,e,this.handleApplyAction,this.handleCancel)));break}case"KeyS":{let e=new ge(this.editableMesh);e.selectedVertices.length>1&&(this.disableDefaultContext(),this.setActiveContext(new Pe(this.world,e,this.handleApplyAction,this.handleCancel)));break}}}async showMesh(e){this.currentMeshName!==e&&(this.currentMeshName=e,this.editableMesh.resetSelection()),void 0!==e?await this.editableMesh.setMeshData(e,this.world.resourceManager):this.editableMesh.reset()}}class tt extends ce{constructor(e){super(),this.imageRenderer=new L,this.isDefaultContextActive=!1,this.world=e,this.panningContext=new ue(e),this.zoomContext=new we(e),this.panningContext.enable(),this.zoomContext.enable(),this.scene.add(this.imageRenderer.mesh)}disable(){super.disable(),this.panningContext.disable(),this.zoomContext.disable()}async showImage(e){await this.imageRenderer.createMeshDataFromImageResource(e,this.world.resourceManager)}}n(7);zip.workerScriptsPath="zip-js/";let nt=new class{constructor(){this.context_menu=new y,this.left_panel=new g(this.context_menu),this.right_panel=new S,this.domElement=document.createElement("div"),this.domElement.className="root";let e=document.createElement("div");e.className="horizontal_box";let t=new s;e.appendChild(this.left_panel.domElement),e.appendChild(t.domElement),e.appendChild(this.right_panel.domElement),this.domElement.appendChild(e),document.body.appendChild(this.context_menu.domElement)}setWorld(e){this.left_panel.setWorld(e),this.right_panel.setWorld(e)}setEditor(e){this.left_panel.setEditor(e),this.right_panel.setEditor(e)}};document.body.appendChild(nt.domElement);let st=new class{constructor(){this.mouseX=0,this.mouseY=0,this.renderer=new M.y({antialias:!0}),this.character=new X,this.resourceManager=new de;let e=document.getElementById("world_view"),t=e.clientWidth,n=e.clientHeight;this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(t,n);let s=document.getElementById("world_view");null!==s&&s.appendChild(this.renderer.domElement),this.camera=new M.q(-t/2,t/2,n/2,-n/2,1,1e3),this.camera.position.z=50,this.camera.updateProjectionMatrix(),this.scene=new M.t,this.scene.background=new M.d(1315860)}async loadMeshes(){this.render()}setScene(e){this.scene=e}render(){this.renderer.render(this.scene,this.camera)}setMousePosition(e,t){let n=document.getElementById("world_view");this.mouseX=e-n.offsetLeft,this.mouseY=n.offsetHeight-(t-n.offsetTop)}getMouseWorldPosition(){let e=document.getElementById("world_view"),t=this.camera.position.x+(this.mouseX-e.offsetWidth/2)/this.camera.zoom,n=this.camera.position.y+(this.mouseY-e.offsetHeight/2)/this.camera.zoom;return new M.w(t,n)}downloadProject(){this.resourceManager.downloadZip()}loadProject(e){this.resourceManager.loadZip(e)}async loadImage(e){await this.resourceManager.loadImage(e.name,e);let t=this.resourceManager.images.get(e.name);if(t){let n=new B,s=e.name,i=s.lastIndexOf(".");s=s.slice(0,i),n.meshName=s,n.textureName=e.name;let o=t.imageBitmap;n.setAsRectangle(o.width,o.height),this.resourceManager.addMesh(n)}console.log(this.resourceManager),this.render()}handleResize(e){let t=document.getElementById("world_view"),n=t.clientWidth,s=t.clientHeight;this.renderer.setSize(n,s),this.camera.left=-n/2,this.camera.right=n/2,this.camera.top=s/2,this.camera.bottom=-s/2,this.camera.updateProjectionMatrix(),this.render()}};st.render();let it=new class{constructor(e){this.undoStack=[],this.redoStack=[],this.world=e,this.applyAction=this.applyAction.bind(this),this.undo=this.undo.bind(this),this.redo=this.redo.bind(this)}applyAction(e){this.redoStack=[],e.apply(),this.undoStack.push(e)}undo(){let e=this.undoStack.pop();e&&(e.revert(),this.redoStack.push(e))}redo(){let e=this.redoStack.pop();e&&(e.apply(),this.undoStack.push(e))}async showSkeleton(e){this.activeView?this.activeView instanceof Xe||(this.activeView.disable(),this.activeView=new Xe(this.world,this.applyAction,this.undo,this.redo),this.world.setScene(this.activeView.scene)):(this.activeView=new Xe(this.world,this.applyAction,this.undo,this.redo),this.world.setScene(this.activeView.scene)),await this.activeView.showSkeleton(e),this.world.render()}async showAnimation(e){this.activeView?this.activeView instanceof Ge||(this.activeView.disable(),this.activeView=new Ge(this.world,this.applyAction,this.undo,this.redo),this.world.setScene(this.activeView.scene)):(this.activeView=new Ge(this.world,this.applyAction,this.undo,this.redo),this.world.setScene(this.activeView.scene)),await this.activeView.showAnimation(e),this.world.render()}async showMesh(e){this.activeView?this.activeView instanceof et||(this.activeView.disable(),this.activeView=new et(this.world,this.applyAction,this.undo,this.redo),this.world.setScene(this.activeView.scene)):(this.activeView=new et(this.world,this.applyAction,this.undo,this.redo),this.world.setScene(this.activeView.scene)),await this.activeView.showMesh(e),this.world.render()}async showImage(e){this.activeView?this.activeView instanceof tt||(this.activeView.disable(),this.activeView=new tt(this.world),this.world.setScene(this.activeView.scene)):(this.activeView=new tt(this.world),this.world.setScene(this.activeView.scene)),await this.activeView.showImage(e),this.world.render()}setFrame(e){this.activeView&&this.activeView instanceof Ge&&this.activeView.setFrame(e)}}(st);nt.setWorld(st),nt.setEditor(it),document.addEventListener("contextmenu",function(e){e.preventDefault()}),document.addEventListener("mousemove",function(e){st.setMousePosition(e.clientX,e.clientY)}),window.addEventListener("resize",e=>{st.handleResize(e)}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("service-worker.js").then(e=>{console.log("Service worker registered: ",e)}).catch(e=>{console.log("Service worker registration failed: ",e)})})},,,,,function(e,t,n){(e.exports=n(5)(!1)).push([e.i,'html {\r\n    font-size: 62.5%;\r\n}\r\n\r\nbody {\r\n    margin: 0;\r\n    padding: 0;\r\n    background-color: rgba(50, 50, 52, 255);\r\n    color: #ffffff;\r\n    font-family: Helvetica;\r\n    font-size: 1.3rem;\r\n}\r\n\r\n* {\r\n    box-sizing: border-box;\r\n}\r\n\r\n.root {\r\n    display: flex;\r\n    height: 100vh;\r\n    width: 100wh;\r\n    padding: 2.5px;\r\n    border-top: 1px solid rgb(90, 90, 90);\r\n}\r\n\r\n/* Layout */\r\n\r\n.horizontal_box {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n    padding: 0px;\r\n    margin: 0px;\r\n}\r\n\r\n.horizontal_box > * {\r\n    margin: 2.5px;\r\n}\r\n\r\n.vertical_box {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n    padding: 0px;\r\n    margin: 0px;\r\n}\r\n\r\n.vertical_box > * {\r\n    margin: 2.5px;\r\n}\r\n\r\n/* Property section */\r\n\r\n/*.property_section:before {\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    content: " ";\r\n    position: absolute;\r\n    left: -1px;\r\n    right: -1px;\r\n}*/\r\n\r\n.property_section > .vertical_box {\r\n    padding: 2.5px;\r\n    /*padding-top: 4.5px;*/     /* To compensate for 2px separator! */\r\n}\r\n\r\n.property_section_title {\r\n    font-weight: bold;\r\n}\r\n\r\n/* Buttons */\r\n\r\n.button_group {\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    padding: 0.5px;\r\n\r\n    background-color: rgb(10, 10, 10);\r\n    border-radius: 2px;\r\n    box-shadow: 0 1px 4px black;\r\n}\r\n\r\n.button_group > :first-child {\r\n    border-top-left-radius: 2px;\r\n    border-bottom-left-radius: 2px;\r\n}\r\n\r\n.button_group > :last-child {\r\n    border-top-right-radius: 2px;\r\n    border-bottom-right-radius: 2px;\r\n}\r\n\r\n.button_group > button, .button_group > input, .button_group > label, .button_group > div {\r\n    flex: 1 1 0;\r\n    padding: 2px;\r\n    margin: 0.5px;\r\n    \r\n    background: linear-gradient(rgba(73, 73, 75, 255), rgba(58, 58, 60, 255));\r\n    /*border: 1px solid rgb(100, 100, 100);*/\r\n    border: 1px solid rgb(60, 60, 60);\r\n    border-top: 1px solid rgb(90, 90, 90);\r\n    border-bottom: 1px solid rgb(50, 50, 50);\r\n    \r\n    text-align: center;\r\n    text-shadow: 0 1px 1px black;\r\n    color: white;\r\n    /*text-shadow: 0 0 0 white, 0 1px 1px black;\r\n    color: transparent;*/\r\n\r\n    position: relative;     /* for file select button */\r\n\r\n    overflow: hidden;\r\n}\r\n\r\n.button_group > button:hover, .button_group > input:hover, .button_group > label:hover, .button_group > div:hover {\r\n    background: linear-gradient(rgba(83, 83, 85, 255), rgba(68, 68, 70, 255));\r\n}\r\n\r\n.button_group > button:active, .button_group > input:active, .button_group > label:active, .button_group > div:active {\r\n    background: linear-gradient(rgba(58, 58, 60, 255), rgba(73, 73, 75, 255));\r\n}\r\n\r\nlabel [type=file] {\r\n    opacity: 0;\r\n    position: absolute;\r\n}\r\n\r\n/* ListView */\r\n\r\n.list_view_container {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n    \r\n    position: relative;\r\n}\r\n\r\n.list_view_border {\r\n    pointer-events: none;\r\n\r\n    border-radius: 2px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    box-shadow: 0 1px 4px black inset;\r\n\r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n}\r\n\r\n.list_view {\r\n    background: rgba(40, 40, 42, 255);\r\n    \r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n\r\n    overflow: auto;\r\n}\r\n\r\n.list_view_entry {\r\n    cursor: default;\r\n\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    -moz-user-select: none;\r\n    user-select: none;\r\n\r\n    padding: 5px;\r\n    padding-left: 10px;\r\n    margin-left: 1px;\r\n    margin-right: 1px;\r\n\r\n    border-top: 1px solid rgb(60, 60, 60);\r\n    border-bottom: 1px solid rgb(20, 20, 20);\r\n}\r\n\r\n.list_view_entry_selected {\r\n    cursor: default;\r\n\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n    \r\n    -moz-user-select: none;\r\n    user-select: none;\r\n\r\n    padding: 5px;\r\n    padding-left: 10px;\r\n    margin-left: 1px;\r\n    margin-right: 1px;\r\n\r\n    background: linear-gradient(#3b6cc9, #264581);\r\n    border-top: 1px solid #437ce7;\r\n    border-bottom: 1px solid #1d3564;\r\n}\r\n\r\n/* Tmp */\r\n\r\n.side_panel {\r\n    flex: 0 0 260px;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n\r\n    position: relative;\r\n    overflow: auto;\r\n}\r\n\r\n/*.world_view {\r\n    flex-grow: 1;\r\n    background-color: rgb(20, 20, 20);\r\n}*/\r\n\r\n/*.world_view {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n\r\n    background: rgba(40, 40, 42, 255);\r\n    border-radius: 4px;\r\n    border: 1px solid rgb(60, 60, 60);\r\n    border-top: 1px solid rgb(30, 30, 30);\r\n    border-bottom: 1px solid rgb(90, 90, 90);\r\n    box-shadow: 0 1px 5px black inset;\r\n}*/\r\n\r\n/* Input */\r\n\r\n.world_view {\r\n    flex-grow: 1;\r\n    overflow: hidden;\r\n\r\n    border-radius: 2px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    /*background: transparent;*/\r\n    box-shadow: 0 1px 4px black inset;\r\n    position: relative;\r\n    top: 0px;\r\n    bottom: 0px;\r\n    left: 0px;\r\n    right: 0px;\r\n}\r\n\r\ncanvas {\r\n    border-radius: 2px;\r\n\r\n    position: relative;\r\n    z-index: -1;\r\n}\r\n\r\n.input_group {\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    padding: 0px;\r\n\r\n    background-color: rgb(40, 40, 40);\r\n    border-radius: 2px;\r\n\r\n    position: relative;\r\n}\r\n\r\n.input_group:after {\r\n    border-radius: 2px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    background: transparent;\r\n    box-shadow: 0 1px 4px black inset;\r\n    content: " ";\r\n    position: absolute;\r\n    top: 0px;\r\n    bottom: 0px;\r\n    left: 0px;\r\n    right: 0px;\r\n    margin: 0px;\r\n    z-index: 1;\r\n}\r\n\r\n.input_group > hr {\r\n    width: 3px;\r\n    border: none;\r\n    border-left: 1px solid rgb(50, 50, 50);\r\n    background-color: rgb(10, 10, 10);\r\n    border-right: 1px solid rgb(50, 50, 50);\r\n    height: 100%;\r\n    margin: 0px;\r\n    position: relative;\r\n    z-index: 1;\r\n}\r\n\r\n.input_group > input {\r\n    flex: 1 1 0;\r\n    padding: 4px;\r\n    margin: 0.5px;\r\n\r\n    /*outline: none;*/\r\n    background-color: transparent;\r\n    border-style: none;\r\n    \r\n    /*background-color: linear-gradient(rgba(73, 73, 75, 255), rgba(58, 58, 60, 255));*/\r\n    /*background-color: rgb(40, 40, 40);*/\r\n    /*border: 1px solid rgb(100, 100, 100);*/\r\n    /*background: transparent;*/\r\n    \r\n    /*text-align: center;*/\r\n    padding-left:8px;\r\n    text-shadow: 0 1px 1px black;\r\n    color: white;\r\n\r\n    position: relative;\r\n    z-index: 2;\r\n    overflow: hidden;\r\n\r\n    /*background: rgba(40, 40, 42, 255);*/\r\n    /*border-radius: 4px;*/\r\n    /*border: 1px solid rgb(60, 60, 60);\r\n    border-top: 1px solid rgb(30, 30, 30);\r\n    border-bottom: 1px solid rgb(90, 90, 90);\r\n    box-shadow: 0 1px 5px black inset;\r\n\r\n    overflow: auto;*/\r\n}\r\n\r\n/* Context menu */\r\n\r\n.context_menu {\r\n    display: block;\r\n    position: absolute;\r\n    z-index: 10;\r\n    box-shadow: 0 1px 4px black;\r\n    background-color: rgba(10, 10, 10, 0.9);\r\n    list-style: none;\r\n\r\n    left: 50px;\r\n    top: 50px;\r\n    padding: 4px 1px;\r\n}\r\n\r\n.context_menu_entry {\r\n    display: block;\r\n    margin-bottom: 4px;\r\n    padding: 2px 6px;\r\n}\r\n\r\n.context_menu_entry:hover {\r\n    /*background-color: #3b6cc9;*/\r\n    /*background: linear-gradient(rgba(73, 73, 75, 255), rgba(58, 58, 60, 255));*/\r\n    background: linear-gradient(#3b6cc9, #264581);\r\n}\r\n\r\n.context_menu_entry:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n@media screen and (min-resolution: 1.5dppx) {\r\n    body {\r\n        font-size: 1rem;\r\n    }\r\n    \r\n    .button_group > button, .button_group > input, .button_group > label, .button_group > div {\r\n        padding: 1px;\r\n    }\r\n}\r\n',""])},function(e,t,n){var s=n(6);"string"==typeof s&&(s=[[e.i,s,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n(4)(s,i);s.locals&&(e.exports=s.locals)}]]);