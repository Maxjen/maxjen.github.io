(window.webpackJsonp=window.webpackJsonp||[]).push([[1],[,function(e,t,s){"use strict";s.r(t);class i{constructor(){this.domElement=document.createElement("div"),this.domElement.className="world_view",this.domElement.id="world_view"}}class n{constructor(){this.listeners=[],this.listenersOnce=[]}bind(e){return this.listeners.push(e),{dispose:()=>this.unbind(e)}}bindForOneExecution(e){this.listenersOnce.push(e)}unbind(e){let t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}execute(e){this.listeners.forEach(t=>{t(e)}),this.listenersOnce.forEach(t=>{t(e)}),this.listenersOnce=[]}}class o{constructor(e,t,s){this.listEntry=e,this.x=t,this.y=s}}class r{constructor(e=!0){this.isSelected=!1,this.onClicked=new n,this.onContextMenu=new n,this.domElement=document.createElement("div"),e&&(this.domElement.className="list_view_entry",this.domElement.addEventListener("click",e=>{this.onClicked.execute(this)}),this.domElement.addEventListener("contextmenu",e=>{this.onContextMenu.execute(new o(this,e.pageX,e.pageY))}))}setIsSelected(e){this.isSelected=e,this.updateVisuals()}updateVisuals(){this.domElement.className=this.isSelected?"list_view_entry_selected":"list_view_entry"}}class a{constructor(){this.listEntries=[],this.domElement=document.createElement("div"),this.domElement.className="list_view_container",this.borderDomElement=document.createElement("div"),this.borderDomElement.className="list_view_border",this.contentDomElement=document.createElement("div"),this.contentDomElement.className="list_view",this.domElement.appendChild(this.contentDomElement),this.domElement.appendChild(this.borderDomElement)}addListEntry(e){e.onClicked.bind(e=>this.handleListEntryClicked(e)),e.onContextMenu.bind(e=>this.handleListEntryContextMenu(e)),this.listEntries.push(e),this.contentDomElement.appendChild(e.domElement)}handleListEntryClicked(e){this.selectedEntry&&this.selectedEntry.setIsSelected(!1),this.selectedEntry=e,this.selectedEntry.setIsSelected(!0)}handleListEntryContextMenu(e){this.handleListEntryClicked(e.listEntry)}clear(){this.contentDomElement.innerHTML="",this.listEntries=[],this.selectedEntry=void 0}}class l extends r{constructor(){super(!1),this.subEntries=[],this.onSubEntryAdded=new n,this.depth=0,this.isCollapsed=!1,this.entryDomElement=document.createElement("div"),this.entryDomElement.className="list_view_entry",this.entryDomElement.addEventListener("click",e=>{this.onClicked.execute(this)}),this.entryDomElement.addEventListener("contextmenu",e=>{this.onContextMenu.execute(new o(this,e.pageX,e.pageY))}),this.domElement.appendChild(this.entryDomElement),this.subEntriesDomElement=document.createElement("div"),this.setIsCollapsed(!1)}updateVisuals(){this.entryDomElement.className=this.isSelected?"list_view_entry_selected":"list_view_entry"}setDepth(e){this.depth=e,this.subEntries.forEach(t=>{t.setDepth(e+1)})}setIsCollapsed(e){this.isCollapsed=e,e?this.domElement.removeChild(this.subEntriesDomElement):this.domElement.appendChild(this.subEntriesDomElement)}addSubEntry(e,t){t.registerSubEntry(e),e.setDepth(this.depth+1),this.subEntries.push(e),this.subEntriesDomElement.appendChild(e.domElement),this.onSubEntryAdded.execute(e)}createExpansionWidget(){let e=document.createElement("div");return e.style.pointerEvents="none",e.style.width="10px",this.onSubEntryAdded.bindForOneExecution(t=>{console.log("SubEntry added"),e.style.pointerEvents="auto",e.textContent=this.isCollapsed?"▸":"▾ "}),e.addEventListener("click",t=>{e.textContent=this.isCollapsed?"▾ ":"▸",this.setIsCollapsed(!this.isCollapsed),t.stopPropagation()}),e}}class h extends a{addListEntry(e){super.addListEntry(e),e instanceof l&&e.setDepth(0)}registerSubEntry(e){e.onClicked.bind(e=>this.handleListEntryClicked(e)),e.onContextMenu.bind(e=>this.handleListEntryContextMenu(e))}}class d extends l{constructor(e){super(),this.expansionWidget=this.createExpansionWidget(),this.entryDomElement.appendChild(this.expansionWidget),this.labelDomElement=document.createElement("div"),this.labelDomElement.style.marginLeft="2px",this.labelDomElement.textContent=e,this.entryDomElement.appendChild(this.labelDomElement)}setDepth(e){let t=8*e;this.expansionWidget.style.marginLeft=t+"px",super.setDepth(e)}}class c extends d{constructor(e){super(e),this.skeletonName=e}}class m extends d{constructor(e){super(e),this.meshName=e}}class u extends d{constructor(e){super(e),this.animationName=e}}class w extends d{constructor(e){super(e),this.imageName=e}}class g extends h{constructor(e){super(),this.recreateList=(()=>{this.clear();let e=new d("Skeletons"),t=new d("Animations"),s=new d("Meshes"),i=new d("Images");if(this.world){for(const[t,s]of this.world.resourceManager.skeletons){let s=new c(t);e.addSubEntry(s,this)}for(const[e,s]of this.world.resourceManager.animations){let s=new u(e);t.addSubEntry(s,this)}for(const[e,t]of this.world.resourceManager.meshes){let t=new m(e);s.addSubEntry(t,this)}for(const[e,t]of this.world.resourceManager.images){let t=new w(e);i.addSubEntry(t,this)}}this.addListEntry(e),this.addListEntry(t),this.addListEntry(s),this.addListEntry(i)}),this.contextMenu=e}setWorld(e){this.world=e,this.recreateList()}setEditor(e){this.editor=e}handleListEntryClicked(e){super.handleListEntryClicked(e),this.editor&&(e instanceof c&&this.editor.showSkeleton(e.skeletonName),e instanceof u&&this.editor.showAnimation(e.animationName),e instanceof m?this.editor.showMesh(e.meshName):e instanceof w&&this.editor.showImage(e.imageName))}handleListEntryContextMenu(e){super.handleListEntryContextMenu(e),this.contextMenu.clear(),this.contextMenu.setPositionFromMousePos(e.x,e.y),e.listEntry instanceof w&&this.contextMenu.addEntry("Remove",()=>{this.world&&(this.world.resourceManager.removeImage(e.listEntry.imageName),this.recreateList())})}}class p{constructor(e){e=e,this.domElement=document.createElement("div"),this.domElement.className="side_panel",this.domElement.id="left_panel",this.outliner=new g(e),this.domElement.appendChild(this.outliner.domElement)}setWorld(e){this.world=e,this.outliner.setWorld(e),this.outliner.recreateList(),this.world.resourceManager.onSkeletonsChanged.bind(this.outliner.recreateList),this.world.resourceManager.onAnimationsChanged.bind(this.outliner.recreateList),this.world.resourceManager.onMeshesChanged.bind(this.outliner.recreateList),this.world.resourceManager.onImagesChanged.bind(this.outliner.recreateList)}setEditor(e){this.outliner.setEditor(e)}}class f{constructor(e){this.domElement=document.createElement("div"),this.domElement.className="property_section",this.verticalBox=document.createElement("div"),this.verticalBox.className="vertical_box";let t=document.createElement("div");t.className="property_section_title";let s=document.createTextNode("▾ "+e);t.appendChild(s),this.verticalBox.appendChild(t),this.domElement.appendChild(this.verticalBox)}addWidget(e){this.verticalBox.appendChild(e.domElement)}}class b{constructor(e){this.domElement=document.createElement("div"),this.domElement.className="button",this.domElement.onclick=(()=>{this.onClick()}),this.domElement.appendChild(document.createTextNode(e))}}class x{constructor(e){this.domElement=document.createElement("label"),this.domElement.className="button",this.domElement.appendChild(document.createTextNode(e)),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept="application/zip",this.domElement.appendChild(this.fileInput)}}class v{constructor(){this.domElement=document.createElement("div"),this.domElement.className="button_group",this.buttons=[]}addButton(e){this.buttons.push(e),this.domElement.appendChild(e.domElement)}}class _{constructor(){this.domElement=document.createElement("div"),this.domElement.className="side_panel";let e=new f("Import/Export"),t=new x("Open");t.fileInput.addEventListener("change",()=>{t.fileInput.files&&this.world&&this.world.loadProject(t.fileInput.files[0])},!1);let s=new b("Save");zip.workerScriptsPath="zip-js/",s.onClick=(()=>{this.world&&this.world.downloadProject()});let i=new v;i.addButton(t),i.addButton(s),e.addWidget(i);let n=new x("Load image");n.fileInput.accept="image/*",n.fileInput.addEventListener("change",()=>{n.fileInput.files&&this.world&&this.world.loadImage(n.fileInput.files[0])},!1);let o=new v;o.addButton(n),e.addWidget(o),this.domElement.appendChild(e.domElement)}setWorld(e){this.world=e}}class E{constructor(){this.domElement=document.createElement("ul"),this.domElement.className="context_menu"}clear(){this.domElement.innerHTML=""}addEntry(e,t){let s=document.createElement("li");s.className="context_menu_entry",s.appendChild(document.createTextNode(e)),s.onclick=t,this.domElement.appendChild(s)}setPositionFromMousePos(e,t){this.domElement.style.left=e+"px",this.domElement.style.top=t+"px"}}var k,y,S=s(2);class D{constructor(e,t,s,i){this.x=e,this.y=t,this.u=s,this.v=i}}class C{constructor(e,t){this.v1=e,this.v2=t}}class M{constructor(e,t,s){this.v1=e,this.v2=t,this.v3=s}}class V{constructor(e,t,s,i){this.v1=e,this.v2=t,this.v3=s,this.v4=i}}class B{constructor(){this.meshName="",this.textureName="",this.vertices=[],this.lines=[],this.triangles=[],this.quads=[]}reset(){this.vertices=[],this.lines=[],this.triangles=[],this.quads=[]}setAsRectangle(e,t){this.reset();let s=this.addVertex(0,0,0,0),i=this.addVertex(e,0,1,0),n=this.addVertex(e,t,1,1),o=this.addVertex(0,t,0,1);this.addQuad(s,i,n,o)}addVertex(e,t,s,i){return this.vertices.push(new D(e,t,s||0,i||0))-1}addLine(e,t){this.lines.push(new C(e,t))}addTriangle(e,t,s){this.triangles.push(new M(e,t,s))}addQuad(e,t,s,i){this.quads.push(new V(e,t,s,i))}getVertexPosition(e){return new S.w(this.vertices[e].x,this.vertices[e].y)}setVertexPosition(e,t){this.vertices[e].x=t.x,this.vertices[e].y=t.y}setTextureName(e){this.textureName=e}generatePositionBuffer(){let e=new Float32Array(3*this.vertices.length);return this.vertices.forEach((t,s)=>{e[3*s]=t.x,e[3*s+1]=t.y,e[3*s+2]=0}),e}generateTexCoordBuffer(){let e=new Float32Array(2*this.vertices.length);return this.vertices.forEach((t,s)=>{e[2*s]=t.u,e[2*s+1]=t.v}),e}generateFaceIndices(){let e=new Uint32Array(3*this.triangles.length+6*this.quads.length);this.triangles.forEach((t,s)=>{e[3*s]=t.v1,e[3*s+1]=t.v2,e[3*s+2]=t.v3});let t=3*this.triangles.length;return this.quads.forEach((s,i)=>{e[6*i+t]=s.v1,e[6*i+t+1]=s.v2,e[6*i+t+2]=s.v3,e[6*i+t+3]=s.v1,e[6*i+t+4]=s.v3,e[6*i+t+5]=s.v4}),e}}class I{constructor(){this.mesh=new S.m,this.pivot=new S.w(0,0),this.position=new S.w(0,0),this.rotation=0}reset(){this.meshData=void 0}createMeshFromMeshData(e,t){return this.meshData=e,new Promise(s=>{let i=t.images.get(e.textureName);if(i){let e=new Image;e.onload=(()=>{let t=new S.u(e);t.needsUpdate=!0,this.setupMesh(t),s()}),e.src=URL.createObjectURL(i.blob)}})}createMeshDataFromImageResource(e,t){return new Promise(s=>{let i=t.images.get(e);if(i){let e=new Image;e.onload=(()=>{let t=new S.u(e);t.needsUpdate=!0,this.meshData=new B,this.meshData.setAsRectangle(t.image.width,t.image.height),this.setupMesh(t),s()}),e.src=URL.createObjectURL(i.blob)}})}createMeshDataFromTexture(e){return new Promise(t=>this.loadTexture("images/"+e).then(e=>{this.meshData=new B,this.meshData.setAsRectangle(e.image.width,e.image.height),this.setupMesh(e),t()}))}setupMesh(e){if(!this.meshData)return;let t=this.meshData.generatePositionBuffer(),s=this.meshData.generateTexCoordBuffer(),i=this.meshData.generateFaceIndices(),n=new S.c;n.addAttribute("position",new S.b(t,3)),n.addAttribute("uv",new S.b(s,2)),n.setIndex(new S.b(i,1)),e.anisotropy=0,e.premultiplyAlpha=!0,e.magFilter=S.k,e.minFilter=S.k;let o=new S.n({map:e,opacity:1,transparent:!0,side:S.f,blending:S.e,blendEquation:S.a,blendSrc:S.o,blendDst:S.p});this.mesh.geometry=n,this.mesh.material=o}loadTexture(e){return new Promise(t=>{(new S.v).load(e,t)})}setPivot(e,t){this.pivot.x=e,this.pivot.y=t}setPosition(e,t){this.position.x=e,this.position.y=t}setRotation(e){this.rotation=e}updateTransform(){let e=S.l.degToRad(this.rotation),t=this.position.clone().sub(this.pivot.clone().rotateAround(new S.w(0,0),e));this.mesh.position.x=t.x,this.mesh.position.y=t.y,this.mesh.rotation.z=e}}class L{constructor(e,t){this.width=e,this.height=t}isValid(){return 0!==this.width&&0!==this.height}}class A{constructor(){this.meshData=new B,this.backgroundRenderer=new I,this.positionBuffer=new Float32Array(0),this.edgeColorBuffer=new Float32Array(0),this.faceColorBuffer=new Float32Array(0),this.edgeIndices=new Uint32Array(0),this.faceIndices=new Uint32Array(0),this.edges=new Map,this.selectedVertices=new Set,this.points=new S.r,this.lines=new S.j,this.faces=new S.m,this.points.position.z=2,this.points.material=new S.s({vertexColors:S.x,size:5,sizeAttenuation:!1}),this.lines.position.z=1,this.lines.material=new S.h({vertexColors:S.x}),this.faces.material=new S.n({color:16777215,opacity:.2,transparent:!0,side:S.f})}async setMeshData(e,t){this.selectedVertices.clear();let s=t.meshes.get(e);if(s){this.meshData=s,this.createBuffers(),await this.backgroundRenderer.createMeshFromMeshData(s,t);const e=t.images.get(s.textureName),i=e?e.imageBitmap:void 0;i&&(this.textureDimensions=new L(i.width,i.height))}else this.reset()}reset(){this.meshData=new B,this.createBuffers()}addVertex(e){let t=this.meshData.addVertex(e.x,e.y);return this.createBuffers(),t}addLine(e,t){this.meshData.addLine(e,t),this.createBuffers()}addTriangle(e,t,s){this.meshData.addTriangle(e,t,s),this.createBuffers()}addQuad(e,t,s,i){this.meshData.addQuad(e,t,s,i),this.createBuffers()}addEdge(e,t){e>t&&([e,t]=[t,e]);let s=this.edges.get(e);s&&!s.includes(t)&&(s.push(t),this.edges.set(e,s)),s||this.edges.set(e,[t])}createBuffers(){this.positionBuffer=this.meshData.generatePositionBuffer(),this.faceIndices=this.meshData.generateFaceIndices(),this.edgeColorBuffer=new Float32Array(3*this.meshData.vertices.length),this.faceColorBuffer=new Float32Array(3*this.meshData.vertices.length),this.meshData.vertices.forEach((e,t)=>{let s=this.selectedVertices.has(t);this.edgeColorBuffer[3*t]=s?1:.5,this.edgeColorBuffer[3*t+1]=s?1:.5,this.edgeColorBuffer[3*t+2]=s?1:.5,this.faceColorBuffer[3*t]=s?1:.5,this.faceColorBuffer[3*t+1]=s?1:.5,this.faceColorBuffer[3*t+2]=s?1:.5}),this.edges.clear(),this.meshData.lines.forEach((e,t)=>{this.addEdge(e.v1,e.v2)}),this.meshData.triangles.forEach((e,t)=>{this.addEdge(e.v1,e.v2),this.addEdge(e.v2,e.v3),this.addEdge(e.v3,e.v1)}),this.meshData.quads.forEach((e,t)=>{this.addEdge(e.v1,e.v2),this.addEdge(e.v2,e.v3),this.addEdge(e.v3,e.v4),this.addEdge(e.v4,e.v1)});let e=0;for(let t of this.edges.values())e+=t.length;this.edgeIndices=new Uint32Array(2*e);let t=0;this.edges.forEach((e,s)=>{for(let i of e)this.edgeIndices[t]=s,this.edgeIndices[t+1]=i,t+=2}),this.updateMeshes()}updateMeshes(){let e=new S.c;e.addAttribute("position",new S.b(this.positionBuffer,3)),e.setIndex(new S.b(this.faceIndices,1)),this.faces.geometry=e;let t=new S.c;t.addAttribute("position",new S.b(this.positionBuffer,3)),t.addAttribute("color",new S.g(this.edgeColorBuffer,3)),t.setIndex(new S.b(this.edgeIndices,1)),this.lines.geometry=t;let s=new S.c;s.addAttribute("position",new S.b(this.positionBuffer,3)),s.addAttribute("color",new S.g(this.edgeColorBuffer,3)),this.points.geometry=s}toggleVertexSelection(e){this.selectedVertices.has(e)?this.deselectVertex(e):this.selectVertex(e)}selectVertex(e){this.selectedVertices.add(e)}deselectVertex(e){this.selectedVertices.delete(e)}trySelectAtMousePosition(e,t,s){let i=2500/(s*s),n=null;this.meshData.vertices.forEach((s,o)=>{let r=e-s.x,a=t-s.y,l=r*r+a*a;l<i&&(i=l,n=o)}),null!=n&&(this.toggleVertexSelection(n),this.createBuffers())}toggleSelectAll(){let e=this.getSelectedVertices();e.length>0?e.forEach(e=>{this.deselectVertex(e)}):this.meshData.vertices.forEach((e,t)=>{this.selectVertex(t)}),this.createBuffers()}getSelectedVertices(){return Array.from(this.selectedVertices)}getSelectedEdges(){let e=[];return this.selectedVertices.forEach(t=>{let s=this.edges.get(t);if(s){let i=!1;s.forEach(t=>{this.selectedVertices.has(t)&&(i=!0,e.push(t))}),i&&e.push(t)}}),e}getVertexPosition(e){return new S.w(this.meshData.vertices[e].x,this.meshData.vertices[e].y)}setVertexPosition(e,t){this.meshData.vertices[e].x=t.x,this.meshData.vertices[e].y=t.y,this.createBuffers(),this.textureDimensions&&this.textureDimensions.isValid()&&(this.meshData.vertices[e].u=t.x/this.textureDimensions.width,this.meshData.vertices[e].v=t.y/this.textureDimensions.height)}getMeshJson(){return JSON.stringify(this.meshData)}addToScene(e){e.add(this.backgroundRenderer.mesh),e.add(this.faces),e.add(this.lines),e.add(this.points)}}!function(e){e[e.Male=0]="Male",e[e.Female=1]="Female"}(k||(k={})),function(e){e[e.Standard=0]="Standard",e[e.Skin=1]="Skin",e[e.Eye=2]="Eye",e[e.Hair=3]="Hair"}(y||(y={}));class P{constructor(e,t,s){this.path=e,this.zOffset=t,this.meshType=s}}const z=[new S.d(16764597),new S.d(15249304),new S.d(7885904)],N=[new S.d(12412238),new S.d(6408447),new S.d(4706377),new S.d(16776960)],R=[new S.d(2891805),new S.d(15062686),new S.d(7021340),new S.d(458844)],T=[new P("m/m_f_r_arm_1.png",-6,y.Skin),new P("m/m_f_r_arm_2.png",-7,y.Skin),new P("m/m_f_r_arm_3.png",-8,y.Skin),new P("m/m_f_r_leg_1.png",-3,y.Skin),new P("m/m_f_r_leg_2.png",-5,y.Skin),new P("m/m_f_r_leg_3.png",-4,y.Skin),new P("m/m_s_eyebrow.png",-2.5,y.Hair),new P("m/m_s_eye_fg.png",-2.4,y.Eye),new P("m/m_s_eye_bg.png",-2.3,y.Standard),new P("m/m_s_ear.png",-2.2,y.Skin),new P("m/m_s_head.png",-2,y.Skin),new P("m/m_f_neck.png",-1,y.Skin),new P("m/m_f_torso.png",0,y.Skin),new P("m/m_f_l_leg_1.png",3,y.Skin),new P("m/m_f_l_leg_2.png",1,y.Skin),new P("m/m_f_l_leg_3.png",2,y.Skin),new P("m/m_f_l_arm_1.png",6,y.Skin),new P("m/m_f_l_arm_2.png",5,y.Skin),new P("m/m_f_l_arm_3.png",4,y.Skin)],W=[new P("f/f_f_r_arm_1.png",-6,y.Skin),new P("f/f_f_r_arm_2.png",-7,y.Skin),new P("f/f_f_r_arm_3.png",-8,y.Skin),new P("f/f_f_r_leg_1.png",-3,y.Skin),new P("f/f_f_r_leg_2.png",-4,y.Skin),new P("f/f_f_r_leg_3.png",-5,y.Skin),new P("f/f_head_s_eyebrow.png",-2.5,y.Hair),new P("f/f_head_s_eye_fg.png",-2.4,y.Eye),new P("f/f_head_s_eye_bg.png",-2.3,y.Standard),new P("f/f_head_s_ear.png",-2.2,y.Skin),new P("f/f_head_s_head.png",-2,y.Skin),new P("f/f_head_f_neck.png",-1,y.Skin),new P("f/f_f_torso.png",0,y.Skin),new P("f/f_f_l_leg_1.png",3,y.Skin),new P("f/f_f_l_leg_2.png",2,y.Skin),new P("f/f_f_l_leg_3.png",1,y.Skin),new P("f/f_f_l_arm_1.png",6,y.Skin),new P("f/f_f_l_arm_2.png",5,y.Skin),new P("f/f_f_l_arm_3.png",4,y.Skin)],F=[new P("m/m_s_hair_front_1.png",-2.6,y.Hair),new P("m/m_s_hair_1.png",-2.1,y.Hair)],H=[new P("m/m_s_hair_front_2.png",-2.6,y.Hair),new P("m/m_s_hair_2.png",-2.1,y.Hair),new P("m/m_s_hair_back_2.png",.1,y.Hair)],U=[new P("f/f_hair_s_hair_front_1.png",-2.6,y.Hair),new P("f/f_hair_s_hair_1.png",-2.1,y.Hair)],O=[new P("f/f_hair_s_hair_2.png",-2.1,y.Hair),new P("f/f_hair_s_hair_back_2.png",.1,y.Hair)],j=[new P("m/m_clothing_f_r_arm_1.png",-6.1,y.Standard),new P("m/m_clothing_shirt_bottom.png",-5.9,y.Standard),new P("m/m_clothing_f_r_leg_1.png",-3.1,y.Standard),new P("m/m_clothing_f_r_leg_2.png",-5.1,y.Standard),new P("m/m_clothing_f_torso.png",-.1,y.Standard),new P("m/m_clothing_f_l_leg_1.png",2.9,y.Standard),new P("m/m_clothing_f_l_leg_2.png",.9,y.Standard),new P("m/m_clothing_f_l_arm_1.png",5.9,y.Standard)],K=[new P("m/m_clothing2_f_r_arm_1.png",-6.1,y.Standard),new P("m/m_clothing2_shirt_bottom.png",-5.9,y.Standard),new P("m/m_clothing2_f_r_leg_1.png",-3.1,y.Standard),new P("m/m_clothing2_f_r_leg_2.png",-5.1,y.Standard),new P("m/m_clothing2_f_torso.png",-.1,y.Standard),new P("m/m_clothing2_f_l_leg_1.png",2.9,y.Standard),new P("m/m_clothing2_f_l_leg_2.png",.9,y.Standard),new P("m/m_clothing2_f_l_arm_1.png",5.9,y.Standard)],Z=[new P("f/f_clothing_f_r_arm_1.png",-6.1,y.Standard),new P("f/f_clothing_shirt_bottom.png",-5.9,y.Standard),new P("f/f_clothing_f_r_leg_1.png",-3.1,y.Standard),new P("f/f_clothing_f_r_leg_2.png",-5.1,y.Standard),new P("f/f_clothing_f_torso.png",-.1,y.Standard),new P("f/f_clothing_f_l_leg_1.png",2.9,y.Standard),new P("f/f_clothing_f_l_leg_2.png",.9,y.Standard),new P("f/f_clothing_f_l_arm_1.png",5.9,y.Standard)],J=[new P("f/f_clothing2_f_r_arm_1.png",-6.1,y.Standard),new P("f/f_clothing2_shirt_bottom.png",-5.9,y.Standard),new P("f/f_clothing2_f_r_leg_1.png",-3.1,y.Standard),new P("f/f_clothing2_f_r_leg_2.png",-5.1,y.Standard),new P("f/f_clothing2_f_torso.png",-.1,y.Standard),new P("f/f_clothing2_f_l_leg_1.png",2.9,y.Standard),new P("f/f_clothing2_f_l_leg_2.png",.9,y.Standard),new P("f/f_clothing2_f_l_arm_1.png",5.9,y.Standard)],Y=[new P("m/m_sabre.png",-6.9,y.Standard),new P("m/m_longsword.png",-6.9,y.Standard)],q=[new P("f/f_sabre.png",-6.9,y.Standard),new P("f/f_longsword.png",-6.9,y.Standard)];class X{constructor(){this.isLoading=!1,this.gender=k.Male,this.hairIndex=0,this.clothingIndex=0,this.swordIndex=0,this.skinColorIndex=0,this.eyeColorIndex=0,this.hairColorIndex=0,this.standardMeshes=[],this.skinMeshes=[],this.hairMeshes=[],this.eyeMesh=new I,this.skinColor=z[this.skinColorIndex],this.eyeColor=N[this.eyeColorIndex],this.hairColor=R[this.hairColorIndex],this.wasAddedToScene=!1}setScene(e){this.scene=e}setGender(e){return this.gender!==e&&(this.gender=e,!0)}setHairIndex(e){return this.hairIndex!==e&&(this.hairIndex=e,!0)}setClothingIndex(e){return this.clothingIndex!==e&&(this.clothingIndex=e,!0)}setSwordIndex(e){return this.swordIndex!==e&&(this.swordIndex=e,!0)}setSkinColorIndex(e){this.skinColorIndex!==e&&(this.skinColorIndex=e,this.setSkinColor(z[e]))}setSkinColor(e){if(!this.isLoading){this.skinColor=e;for(let t of this.skinMeshes){let s=t.mesh.material;s&&(s.color=e)}}}setEyeColorIndex(e){this.eyeColorIndex!==e&&(this.eyeColorIndex=e,this.setEyeColor(N[e]))}setEyeColor(e){if(this.isLoading)return;this.eyeColor=e;let t=this.eyeMesh.mesh.material;t&&(t.color=e)}setHairColorIndex(e){this.hairColorIndex!==e&&(this.hairColorIndex=e,this.setHairColor(R[e]))}setHairColor(e){if(!this.isLoading){this.hairColor=e;for(let t of this.hairMeshes){let s=t.mesh.material;s&&(s.color=e)}}}createMeshInternal(e){return this.createMesh(e.path,e.zOffset,e.meshType)}createMeshes(e){let t=[];for(let s of e)t.push(this.createMeshInternal(s));return Promise.all(t)}createMesh(e,t,s){return new Promise(i=>{let n=new I,o=null;switch(s){case y.Standard:this.standardMeshes.push(n);break;case y.Skin:this.skinMeshes.push(n),o=this.skinColor;break;case y.Eye:this.eyeMesh=n,o=this.eyeColor;break;case y.Hair:this.hairMeshes.push(n),o=this.hairColor}n.createMeshDataFromTexture(e).then(()=>{if(o){let e=n.mesh.material;e&&(e.color=o)}n.mesh.translateZ(-8-t),i()})})}recreateCharacter(){if(this.isLoading)return Promise.all([]);this.isLoading=!0,this.removeFromScene();let e=[];return this.gender===k.Male?(e=e.concat(T),0===this.hairIndex?e=e.concat(F):1===this.hairIndex&&(e=e.concat(H)),0===this.clothingIndex?e=e.concat(j):1===this.clothingIndex&&(e=e.concat(K)),e.push(Y[this.swordIndex])):(e=e.concat(W),0===this.hairIndex?e=e.concat(U):1===this.hairIndex&&(e=e.concat(O)),0===this.clothingIndex?e=e.concat(Z):1===this.clothingIndex&&(e=e.concat(J)),e.push(q[this.swordIndex])),this.createMeshes(e).then(()=>(this.addToScene(),this.isLoading=!1,Promise.all([])))}addToScene(){if(this.scene){this.wasAddedToScene=!0;for(let e of this.standardMeshes)this.scene.add(e.mesh);for(let e of this.skinMeshes)this.scene.add(e.mesh);this.scene.add(this.eyeMesh.mesh);for(let e of this.hairMeshes)this.scene.add(e.mesh)}}removeFromScene(){if(this.scene&&this.wasAddedToScene){this.wasAddedToScene=!1;for(let e of this.standardMeshes)this.scene.remove(e.mesh);for(let e of this.skinMeshes)this.scene.remove(e.mesh);this.scene.remove(this.eyeMesh.mesh);for(let e of this.hairMeshes)this.scene.remove(e.mesh);this.standardMeshes=[],this.skinMeshes=[],this.hairMeshes=[]}}}class Q{constructor(e,t,s){this.length=0,this.isConnected=!1,this.children=[],this.name=e,this.translation=t,this.rotation=s}}class G{constructor(e){this.bones=[],this.name=e}addBone(e,t,s,i){return this.bones.push(new Q(e,new S.w(t,s),i))-1}setBoneLength(e,t){this.bones[e].length=t}setIsBoneConnected(e,t){this.bones[e].isConnected=t}attachBone(e,t){let s=this.bones[t];s.children.push(e);let i=this.bones[e];i.isConnected&&(i.translation.x=0,i.translation.y=s.length)}getRootIndices(){class e{constructor(){this.children=[]}}let t=new Array(this.bones.length);for(let s=0;s<this.bones.length;++s)t[s]=new e;for(let e=0;e<this.bones.length;++e){t[e].children=this.bones[e].children;for(let s of t[e].children)t[s].parent=e}let s=[];for(let e=0;e<t.length;++e)void 0===t[e].parent&&s.push(e);return s}createJsonObject(){let e={};e.name=this.name,e.bones=[];for(const t of this.bones){let s={};s.name=t.name,t.isConnected||(s.translation=[t.translation.x,t.translation.y]),s.rotation=t.rotation,s.length=t.length,t.isConnected&&(s.isConnected=t.isConnected),t.children.length>0&&(s.children=t.children),e.bones.push(s)}return e}}class ${static normalizeAngle(e){let t=(e+180)%360;return t<0&&(t+=360),t-180}static isIterable(e){return null!=e&&"function"==typeof e[Symbol.iterator]}}class ee{constructor(e){this.frame=e}}class te extends ee{constructor(e,t){super(e),this.angle=0,this.angle=t}}class se extends ee{constructor(e,t){super(e),this.translation=new S.w(0,0),this.translation=t}}class ie extends ee{constructor(e,t){super(e),this.scale=1,this.scale=t}}class ne{constructor(e){this.translation=void 0,this.rotation=void 0,this.scale=void 0,this.boneName=e}insertTranslation(e,t){if(this.translation)for(let s=0;s<this.translation.length;++s)this.translation[s].frame===e?this.translation[s].translation=t:this.translation[s].frame>e&&this.translation.splice(s,0,new se(e,t));else this.translation=[new se(e,t)]}insertRotation(e,t){if(this.rotation)for(let s=0;s<this.rotation.length;++s)this.rotation[s].frame===e?this.rotation[s].angle=t:this.rotation[s].frame>e&&this.rotation.splice(s,0,new te(e,t));else this.rotation=[new te(e,t)]}insertScale(e,t){if(this.scale)for(let s=0;s<this.scale.length;++s)this.scale[s].frame===e?this.scale[s].scale=t:this.scale[s].frame>e&&this.scale.splice(s,0,new ie(e,t));else this.scale=[new ie(e,t)]}getInterpolationKeyIndicesAndAlpha(e,t){if(t.length>0){let s=void 0;for(let i=0;i<t.length&&e<=t[i].frame;++i)s=i;if(void 0===s)return[void 0,void 0,0];let i=void 0,n=0;if(s+1<t.length){i=s+1;let o=t[s].frame;return[s,i,(e-o)/((n=t[i].frame)-o)]}return[s,void 0,0]}return[void 0,void 0,0]}}class oe{constructor(e,t){this.bones=new Map,this.animationName=e,this.skeletonName=t}addBoneAnimationData(e){this.bones.set(e.boneName,e)}getBoneTranslation(e,t){let s=this.bones.get(t);if(s&&s.translation){let[t,i,n]=s.getInterpolationKeyIndicesAndAlpha(e,s.translation);if(void 0===t)return;{if(void 0===i)return s.translation[t].translation;let e=s.translation[t].translation,o=(new S.w).subVectors(s.translation[i].translation,e);return(new S.w).addVectors(e,o.multiplyScalar(n))}}}getBoneRotation(e,t){let s=this.bones.get(t);if(s&&s.rotation){let[t,i,n]=s.getInterpolationKeyIndicesAndAlpha(e,s.rotation);if(void 0===t)return;{if(void 0===i)return s.rotation[t].angle;let e=s.rotation[t].angle;return e+(s.rotation[i].angle-e)*n}}}getBoneScale(e,t){let s=this.bones.get(t);if(s&&s.scale){let[t,i,n]=s.getInterpolationKeyIndicesAndAlpha(e,s.scale);if(void 0===t)return;{if(void 0===i)return s.scale[t].scale;let e=s.scale[t].scale;return e+(s.scale[i].scale-e)*n}}}createJsonObject(){let e={};e.animationName=this.animationName,e.skeletonName=this.skeletonName,e.bones=[];for(const t of this.bones.values()){let s={};if(s.boneName=t.boneName,t.translation&&$.isIterable(t.translation)){let e=[];for(const s of t.translation){let t={};t.frame=s.frame,t.translation=[s.translation.x,s.translation.y],e.push(t)}s.translation=e}if(t.rotation&&$.isIterable(t.rotation)){let e=[];for(const s of t.rotation){let t={};t.frame=s.frame,t.angle=s.angle,e.push(t)}s.rotation=e}if(t.scale&&$.isIterable(t.scale)){let e=[];for(const s of t.scale){let t={};t.frame=s.frame,t.angle=s.scale,e.push(t)}s.scale=e}e.bones.push(s)}return e}}class re{constructor(e,t){this.zOffset=0,this.meshName=e,this.boneName=t}}class ae{constructor(e,t){this.components=[],this.skinName=e,this.skeletonName=t}}class le{constructor(e,t){this.blob=e,this.imageBitmap=t}}class he{constructor(){this.images=new Map,this.onImagesChanged=new n,this.meshes=new Map,this.onMeshesChanged=new n,this.skeletons=new Map,this.onSkeletonsChanged=new n,this.animations=new Map,this.onAnimationsChanged=new n,this.skins=new Map,this.onSkinsChanged=new n}loadImage(e,t){return new Promise((s,i)=>{createImageBitmap(t).then(i=>{this.images.set(e,new le(t,i)),console.log("loaded image "+e),this.onImagesChanged.execute(void 0),s()},t=>{console.log("error loading image "+e+": "+t),i()})})}removeImage(e){this.images.delete(e)}addMesh(e){this.meshes.set(e.meshName,e),this.onMeshesChanged.execute(void 0)}loadSkeleton(e){if(!e.name)return;let t=new G(e.name),s=!0;e.bones&&(e.bones.forEach((e,i)=>{if(!s)return;if(!e.name)return void(s=!1);let n=0,o=0,r=!!e.isConnected&&e.isConnected;!r&&e.translation&&2==e.translation.length&&(n=e.translation[0],o=e.translation[1]);let a=e.rotation?e.rotation:0;t.addBone(e.name,n,o,a),e.isConnected&&t.setIsBoneConnected(i,r),e.length&&t.setBoneLength(i,e.length)}),e.bones.forEach((e,s)=>{if(e.children)for(let i of e.children)t.attachBone(i,s)})),s&&(this.skeletons.set(t.name,t),this.onSkeletonsChanged.execute(void 0))}loadAnimation(e){if(!e.animationName||!e.skeletonName)return;let t=new oe(e.animationName,e.skeletonName);if($.isIterable(e.bones))for(let s of e.bones){if(!s.boneName)return;let e=new ne(s.boneName);if(s.translation){let t=void 0;for(let i of s.translation){if(void 0===t)t=i.frame;else if(i.frame<=t)return;e.insertTranslation(i.frame,i.translation)}}if(s.rotation){let t=void 0;for(let i of s.rotation){if(void 0===t)t=i.frame;else if(i.frame<=t)return;e.insertRotation(i.frame,i.angle)}}if(s.scale){let t=void 0;for(let i of s.scale){if(void 0===t)t=i.frame;else if(i.frame<=t)return;e.insertScale(i.frame,i.rotation)}}t.addBoneAnimationData(e),this.animations.set(t.animationName,t),this.onAnimationsChanged.execute(void 0)}}loadSkin(e){if(!e.skinName||!e.skeletonName)return;let t=new ae(e.skinName,e.skeletonName);if(e.components)for(let s of e.components){if(!s.meshName||!s.boneName)continue;let e=new re(s.meshName,s.boneName);s.zOffset&&(e.zOffset=s.zOffset),t.components.push(e)}this.skins.set(t.skinName,t),this.onSkinsChanged.execute(void 0)}loadMesh(e){let t=new B;e.meshName&&(t.meshName=e.meshName),e.textureName&&(t.textureName=e.textureName),e.vertices&&e.vertices.forEach(e=>{t.addVertex(e.x,e.y,e.u,e.v)}),e.lines&&e.lines.forEach(e=>{t.addLine(e.v1,e.v2)}),e.triangles&&e.triangles.forEach(e=>{t.addTriangle(e.v1,e.v2,e.v3)}),e.quads&&e.quads.forEach(e=>{t.addQuad(e.v1,e.v2,e.v3,e.v4)}),this.meshes.set(t.meshName,t),this.onMeshesChanged.execute(void 0)}loadJson(e){console.log(e);let t=JSON.parse(e);t.skeletons&&t.skeletons.forEach(e=>{this.loadSkeleton(e)}),t.animations&&t.animations.forEach(e=>{this.loadAnimation(e)}),t.skins&&t.skins.forEach(e=>{this.loadSkin(e)}),t.meshes&&t.meshes.forEach(e=>{this.loadMesh(e)})}getZipEntries(e){return new Promise((t,s)=>{zip.createReader(new zip.BlobReader(e),e=>{e.getEntries(t)},e=>{console.log(e),s()})})}async loadZip(e){let t=await this.getZipEntries(e);for(const e of t)e.filename.endsWith("png")?e.getData(new zip.BlobWriter("image/png"),t=>{this.loadImage(e.filename,t)}):e.filename.endsWith("json")&&e.getData(new zip.BlobWriter("application/json"),e=>{let t=new FileReader;t.onload=(()=>{"string"==typeof t.result&&this.loadJson(t.result)}),t.readAsText(e)})}addBlobToZip(e,t,s){return new Promise((i,n)=>{s.add(e,new zip.BlobReader(t),()=>{i(s)})})}addTextToZip(e,t,s){return new Promise((i,n)=>{s.add(e,new zip.TextReader(t),()=>{i(s)})})}createZipWriter(){return new Promise((e,t)=>{zip.createWriter(new zip.BlobWriter("application/zip"),t=>{e(t)},e=>{console.log(e),t()})})}writeZip(e){return new Promise(t=>{e.close(e=>{t(e)})})}async downloadZip(){let e=await this.createZipWriter();for(const[t,s]of this.images)await this.addBlobToZip(t,s.blob,e);let t={skeletons:[],animations:[],skins:[],meshes:[]};for(const[e,s]of this.skeletons)t.skeletons.push(s.createJsonObject());for(const[e,s]of this.animations)t.animations.push(s.createJsonObject());for(const[e,s]of this.skins)t.skins.push(s);for(const[e,s]of this.meshes)t.meshes.push(s);let s=JSON.stringify(t);await this.addTextToZip("meshes.json",s,e);let i=await this.writeZip(e),n=URL.createObjectURL(i),o=document.createElement("a");document.body.appendChild(o),o.style.display="none",o.href=n,o.download="project.zip",o.click(),o.parentNode&&o.parentNode.removeChild(o),window.URL.revokeObjectURL(n)}}class de{constructor(){this.scene=new S.t,this.scene.background=new S.d(1315860)}disableActiveContext(){this.activeContext&&this.activeContext.disable()}setActiveContext(e){this.disableActiveContext(),this.activeContext=e,this.activeContext.enable()}disable(){this.activeContext&&this.activeContext.disable()}}class ce{constructor(e){this.isEnabled=!1,this.middleButtonDown=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener,!0),this.worldView.addEventListener("mousedown",this.mouseDownListener,!0),this.worldView.addEventListener("mouseup",this.mouseUpListener,!0))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener,!0),this.worldView.removeEventListener("mousedown",this.mouseDownListener,!0),this.worldView.removeEventListener("mouseup",this.mouseUpListener,!0))}handleMouseMove(e){this.middleButtonDown&&(this.world.camera.position.x+=-e.movementX/this.world.camera.zoom,this.world.camera.position.y+=e.movementY/this.world.camera.zoom,this.world.render())}handleMouseDown(e){1!==e.button||this.middleButtonDown||(this.middleButtonDown=!0)}handleMouseUp(e){1===e.button&&(this.middleButtonDown=!1)}}class me{constructor(e){this.isEnabled=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.wheelListener=this.handleWheel.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("wheel",this.wheelListener,{capture:!0,passive:!0}))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("wheel",this.wheelListener,!0))}handleWheel(e){let t=e.deltaY>0?.1:-.1;this.world.camera.zoom-=t,this.world.camera.zoom=Math.min(this.world.camera.zoom,5),this.world.camera.zoom=Math.max(this.world.camera.zoom,.1),this.world.camera.updateProjectionMatrix(),this.world.render()}}class ue{constructor(e,t){this.isEnabled=!1,this.leftButtonDown=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.selectable=t,this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this),this.keyDownListener=this.handleKeyDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousedown",this.mouseDownListener,!0),this.worldView.addEventListener("mouseup",this.mouseUpListener,!0),document.addEventListener("keydown",this.keyDownListener))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousedown",this.mouseDownListener,!0),this.worldView.removeEventListener("mouseup",this.mouseUpListener,!0),document.removeEventListener("keydown",this.keyDownListener))}handleMouseDown(e){if(0===e.button&&!this.leftButtonDown){this.leftButtonDown=!0;let e=this.world.getMouseWorldPosition();this.selectable.trySelectAtMousePosition(e.x,e.y,this.world.camera.zoom),this.world.render()}}handleMouseUp(e){0===e.button&&(this.leftButtonDown=!1)}handleKeyDown(e){switch(e.key){case"a":this.selectable.toggleSelectAll(),this.world.render()}}}class we{constructor(e){this.editableMesh=e,this.selectedVertices=e.getSelectedVertices()}}var ge;!function(e){e[e.Vertices=0]="Vertices",e[e.Edges=1]="Edges"}(ge||(ge={}));class pe{constructor(e){this.selectionType=ge.Vertices,this.editableSkeleton=e,this.selectedIndices=Array.from(e.selectedIndices),this.selectionType=e.selectionType}}class fe{constructor(e){this.startingPositions=[],this.deltaPosition=new S.w(0,0),this.selection=e,this.selection.selectedVertices.forEach(e=>{this.startingPositions.push(this.selection.editableMesh.getVertexPosition(e))})}apply(){this.selection.selectedVertices.forEach((e,t)=>{this.selection.editableMesh.setVertexPosition(e,(new S.w).addVectors(this.startingPositions[t],this.deltaPosition))})}revert(){this.selection.selectedVertices.forEach((e,t)=>{this.selection.editableMesh.setVertexPosition(e,this.startingPositions[t])})}}class be{constructor(e){this.startingPositions=[],this.deltaPosition=new S.w(0,0),this.selection=e,this.selection.selectedIndices.forEach(e=>{this.startingPositions.push(this.selection.editableSkeleton.getBoneVertexPosition(e))})}apply(){this.selection.selectedIndices.forEach((e,t)=>{this.selection.editableSkeleton.setBoneVertexPosition(e,(new S.w).addVectors(this.startingPositions[t],this.deltaPosition))}),this.selection.editableSkeleton.updateBoneData()}revert(){this.selection.selectedIndices.forEach((e,t)=>{this.selection.editableSkeleton.setBoneVertexPosition(e,this.startingPositions[t])}),this.selection.editableSkeleton.updateBoneData()}}class xe{constructor(e,t,s){this.isEnabled=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selection instanceof we?this.grabAction=new fe(this.selection):this.selection instanceof pe&&(this.grabAction=new be(this.selection)))}disable(){this.isEnabled&&(this.isEnabled=!1,this.undo(),this.removeListeners())}undo(){this.grabAction.revert()}removeListeners(){this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback()}handleMouseMove(e){this.grabAction.deltaPosition.x+=e.movementX/this.world.camera.zoom,this.grabAction.deltaPosition.y+=-e.movementY/this.world.camera.zoom,this.grabAction.apply(),this.world.render()}handleMouseDown(e){0===e.button&&this.removeListeners(),2===e.button&&(this.undo(),this.removeListeners(),this.world.render())}}class ve{constructor(e){this.startingPositions=[],this.pivot=new S.w(0,0),this.angle=0,this.selection=e,this.selection.selectedVertices.forEach(e=>{let t=this.selection.editableMesh.getVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length)}apply(){this.selection.selectedVertices.forEach((e,t)=>{let s=this.startingPositions[t].clone().rotateAround(this.pivot,this.angle);this.selection.editableMesh.setVertexPosition(e,s)})}revert(){this.selection.selectedVertices.forEach((e,t)=>{this.selection.editableMesh.setVertexPosition(e,this.startingPositions[t])})}}class _e{constructor(e){this.startingPositions=[],this.pivot=new S.w(0,0),this.angle=0,this.selection=e,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length)}apply(){this.selection.selectedIndices.forEach((e,t)=>{let s=this.startingPositions[t].clone().rotateAround(this.pivot,this.angle);this.selection.editableSkeleton.setBoneVertexPosition(e,s)}),this.selection.editableSkeleton.updateBoneData()}revert(){this.selection.selectedIndices.forEach((e,t)=>{this.selection.editableSkeleton.setBoneVertexPosition(e,this.startingPositions[t])}),this.selection.editableSkeleton.updateBoneData()}}class Ee{constructor(e){this.startingRotations=[],this.pivot=new S.w(0,0),this.angle=0,this.selection=e,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneEdgeRotation(e);this.startingRotations.push(t),this.pivot.add(this.selection.editableSkeleton.getBoneEdgeHeadPosition(e))}),this.pivot.divideScalar(this.startingRotations.length)}apply(){this.selection.selectedIndices.forEach((e,t)=>{console.log("startingRotation[",t,"] = ",this.startingRotations[t]),console.log("angle = ",S.l.radToDeg(this.angle));let s=$.normalizeAngle(this.startingRotations[t]+S.l.radToDeg(this.angle));console.log("rotation = ",s),this.selection.editableSkeleton.insertBoneRotation(e,s)}),this.selection.editableSkeleton.updateBoneEdges(),this.selection.editableSkeleton.updateVisuals()}revert(){this.selection.selectedIndices.forEach((e,t)=>{this.selection.editableSkeleton.insertBoneRotation(e,this.startingRotations[t])}),this.selection.editableSkeleton.updateBoneEdges(),this.selection.editableSkeleton.updateVisuals()}}class ke{constructor(e,t,s){this.isEnabled=!1,this.startingAngle=0,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){if(!this.isEnabled){this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selection instanceof we?this.rotateAction=new ve(this.selection):this.selection instanceof pe&&(this.selection.selectionType===ge.Vertices?this.rotateAction=new _e(this.selection):this.rotateAction=new Ee(this.selection));let e=this.world.getMouseWorldPosition();this.startingAngle=Math.atan2(e.y-this.rotateAction.pivot.y,e.x-this.rotateAction.pivot.x)}}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback())}handleMouseMove(e){let t=this.world.getMouseWorldPosition(),s=Math.atan2(t.y-this.rotateAction.pivot.y,t.x-this.rotateAction.pivot.x);this.rotateAction.angle=s-this.startingAngle,this.rotateAction.apply(),this.world.render()}handleMouseDown(e){0===e.button&&this.disable(),2===e.button&&(this.rotateAction.revert(),this.world.render(),this.disable())}}class ye{constructor(e){this.startingPositions=[],this.pivot=new S.w(0,0),this.scale=0,this.selection=e,this.selection.selectedVertices.forEach(e=>{let t=this.selection.editableMesh.getVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length)}apply(){this.selection.selectedVertices.forEach((e,t)=>{let s=this.startingPositions[t].clone().sub(this.pivot),i=this.pivot.clone().add(s.clone().multiplyScalar(this.scale));this.selection.editableMesh.setVertexPosition(e,i)})}revert(){this.selection.selectedVertices.forEach((e,t)=>{this.selection.editableMesh.setVertexPosition(e,this.startingPositions[t])})}}class Se{constructor(e){this.startingPositions=[],this.pivot=new S.w(0,0),this.scale=0,this.selection=e,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length)}apply(){this.selection.selectedIndices.forEach((e,t)=>{let s=this.startingPositions[t].clone().sub(this.pivot),i=this.pivot.clone().add(s.clone().multiplyScalar(this.scale));this.selection.editableSkeleton.setBoneVertexPosition(e,i)}),this.selection.editableSkeleton.updateBoneData()}revert(){this.selection.selectedIndices.forEach((e,t)=>{this.selection.editableSkeleton.setBoneVertexPosition(e,this.startingPositions[t])}),this.selection.editableSkeleton.updateBoneData()}}class De{constructor(e,t,s){this.isEnabled=!1,this.startingDistance=0,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){if(!this.isEnabled){this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selection instanceof we?this.scaleAction=new ye(this.selection):this.selection instanceof pe&&(this.scaleAction=new Se(this.selection));let e=this.world.getMouseWorldPosition();this.startingDistance=this.scaleAction.pivot.distanceTo(e),this.startingDistance<1&&(this.startingDistance=1)}}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback())}handleMouseMove(e){let t=this.world.getMouseWorldPosition(),s=this.scaleAction.pivot.distanceTo(t)/this.startingDistance;this.scaleAction.scale=s,this.scaleAction.apply(),this.world.render()}handleMouseDown(e){0===e.button&&this.disable(),2===e.button&&(this.scaleAction.revert(),this.world.render(),this.disable())}}class Ce{constructor(e){this.startingPositions=[],this.newVertices=new Map,this.deltaPosition=new S.w(0,0),this.selection=e,this.selection.selectedVertices.forEach(e=>{this.startingPositions.push(this.selection.editableMesh.getVertexPosition(e))});let t=this.selection.editableMesh.getSelectedVertices(),s=this.selection.editableMesh.getSelectedEdges();t.forEach(e=>{let t=this.selection.editableMesh.getVertexPosition(e);this.startingPositions.push(t);let s=this.selection.editableMesh.addVertex(t);this.newVertices.set(e,s),this.selection.editableMesh.deselectVertex(e),this.selection.editableMesh.selectVertex(s)}),t=t.filter(e=>!s.includes(e));let i=0;for(;i<s.length/2;++i){let e=s[2*i],t=s[2*i+1],n=this.newVertices.get(t),o=this.newVertices.get(e);n&&o&&this.selection.editableMesh.addQuad(e,t,n,o)}t.forEach(e=>{let t=this.newVertices.get(e);t&&this.selection.editableMesh.addLine(e,t)})}apply(){let e=0;this.newVertices.forEach((t,s)=>{this.selection.editableMesh.setVertexPosition(t,(new S.w).addVectors(this.startingPositions[e],this.deltaPosition)),++e})}revert(){}}class Me{constructor(e,t){this.startingPosition=e,this.tailIndex=t}}class Ve{constructor(e){this.extrudeData=new Map,this.deltaPosition=new S.w(0,0),this.selection=e,this.selection.selectedIndices.forEach(e=>{let t=this.selection.editableSkeleton.getBoneVertexPosition(e),s=this.selection.editableSkeleton.getBoneVertexParent(e),i=e;void 0===s&&(i=this.selection.editableSkeleton.addBoneVertex(t.x,t.y));let n=this.selection.editableSkeleton.addBoneVertex(t.x,t.y);this.selection.editableSkeleton.createBoneFromBoneVertices(i,n,s),this.extrudeData.set(e,new Me(t,n)),this.selection.editableSkeleton.deselectIndex(e),this.selection.editableSkeleton.selectIndex(n)})}apply(){this.extrudeData.forEach((e,t)=>{this.selection.editableSkeleton.setBoneVertexPosition(e.tailIndex,(new S.w).addVectors(e.startingPosition,this.deltaPosition))}),this.selection.editableSkeleton.updateBoneData()}revert(){}}class Be{constructor(e,t,s){this.isEnabled=!1,this.leftButtonDown=!1,this.rightButtonDown=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selection instanceof we?this.extrudeAction=new Ce(this.selection):this.selection instanceof pe&&(this.extrudeAction=new Ve(this.selection)))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback())}handleMouseMove(e){this.extrudeAction.deltaPosition.x+=e.movementX/this.world.camera.zoom,this.extrudeAction.deltaPosition.y+=-e.movementY/this.world.camera.zoom,this.extrudeAction.apply(),this.world.render()}handleMouseDown(e){0===e.button&&(this.leftButtonDown=!0,this.disable())}}class Ie{constructor(e,t,s){this.isEnabled=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.selection=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.keyUpListener=this.handleKeyUp.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.worldView.addEventListener("keyup",this.keyUpListener))}disable(){this.isEnabled&&(this.isEnabled=!1,this.removeListeners())}removeListeners(){this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback()}handleMouseMove(e){if(void 0!==this.tailIndex){let t=this.selection.editableSkeleton.getBoneVertexPosition(this.tailIndex);t.x+=e.movementX/this.world.camera.zoom,t.y+=-e.movementY/this.world.camera.zoom,this.selection.editableSkeleton.setBoneVertexPosition(this.tailIndex,t)}this.selection.editableSkeleton.updateBoneData(),this.world.render()}handleMouseDown(e){if(0===e.button)if(void 0===this.tailIndex){let e=0,t=void 0;this.selection.selectedIndices.forEach(s=>{let i=this.selection.editableSkeleton.getBoneVertexParent(s);void 0!==i&&(++e,t=i)}),e>1&&(t=void 0);let s=this.world.getMouseWorldPosition(),i=this.selection.editableSkeleton.addBoneVertex(s.x,s.y);this.tailIndex=this.selection.editableSkeleton.addBoneVertex(s.x,s.y);this.selection.editableSkeleton.createBoneFromBoneVertices(i,this.tailIndex,t)}else this.removeListeners()}handleKeyUp(e){e.ctrlKey||this.removeListeners()}}class Le{constructor(e){this.globalPosition=new S.w,this.globalRotation=0,this.children=[],this.boneIndex=e}}class Ae{constructor(){this.currentFrame=0,this.cachedBones=[],this.rootIndices=[]}setSkeletonData(e){this.skeletonData=e}setAnimationData(e){this.animationData=e}addCachedBone(e){return this.cachedBones.push(new Le(e))-1}getCachedBoneIndexFromBoneName(e){let t=void 0;return this.cachedBones.forEach((s,i)=>{this.skeletonData&&this.skeletonData.bones[s.boneIndex].name===e&&(t=i)}),t}getBoneTranslation(e){if(!this.skeletonData||e<0||e>=this.skeletonData.bones.length)return new S.w;let t=this.skeletonData.bones[e],s=this.animationData?this.animationData.getBoneTranslation(this.currentFrame,t.name):void 0;return void 0!==s?s:t.translation}getBoneRotation(e){if(!this.skeletonData||e<0||e>=this.skeletonData.bones.length)return 0;let t=this.skeletonData.bones[e],s=this.animationData?this.animationData.getBoneRotation(this.currentFrame,t.name):void 0;return void 0!==s?s:t.rotation}createCachedBones(){if(!this.skeletonData)return;let e=(t,s)=>{if(!this.skeletonData)return-1;let i=this.skeletonData.bones[t],n=this.addCachedBone(t);for(let t of i.children){let s=e(t,n);this.cachedBones[n].children.push(s)}return n},t=this.skeletonData.getRootIndices();for(let s of t){let t=e(s,void 0);-1!==t&&this.rootIndices.push(t)}this.updateCachedBones()}updateCachedBones(){if(!this.skeletonData)return;let e=(t,s)=>{if(!this.skeletonData)return-1;let i=new S.w(0,0),n=0;if(void 0!==s){let e=this.cachedBones[s];i=e.globalPosition,n=e.globalRotation}let o=new S.w,r=this.cachedBones[t],a=r.boneIndex,l=this.getBoneTranslation(a).clone();l.rotateAround(o,S.l.degToRad(n)),r.globalPosition=(new S.w).addVectors(i,l),r.globalRotation=$.normalizeAngle(n+this.getBoneRotation(a));for(let s of r.children)e(s,t)};for(let t of this.rootIndices)e(t,void 0)}}class Pe{constructor(){this.points=new S.r,this.lines=new S.j,this.faces=new S.m,this.dashedLines=new S.j,this.points.position.z=2,this.points.material=new S.s({vertexColors:S.x,size:5,sizeAttenuation:!1}),this.lines.position.z=1,this.lines.material=new S.h({vertexColors:S.x}),this.faces.material=new S.n({color:16777215,opacity:.2,transparent:!0,side:S.f}),this.dashedLines.position.z=1,this.dashedLines.material=new S.i({color:5263440,dashSize:4,gapSize:2})}createVisuals(e,t,s,i){let n=new Float32Array(4*t.length*3),o=new Float32Array(4*t.length*3),r=new Uint32Array(2*t.length),a=new Uint32Array(8*t.length),l=new Uint32Array(6*t.length),h=[],d=0,c=(e,t,s)=>(n[3*d]=e,n[3*d+1]=t,n[3*d+2]=0,o[3*d]=s?1:.5,o[3*d+1]=s?.661:.5,o[3*d+2]=s?.188:.5,d++);t.forEach((n,o)=>{let d=new S.w(e[n.head].x,e[n.head].y),m=new S.w(e[n.tail].x,e[n.tail].y),u=(new S.w).subVectors(m,d),w=u.length(),g=w>=20?10:.5*w;u.multiplyScalar(1/w);let p=new S.w(u.y,-u.x);u.multiplyScalar(g);let f,b,x=(new S.w).addVectors(d,u).add(p.multiplyScalar(2)),v=(new S.w).addVectors(d,u).add(p.multiplyScalar(-2));i===ge.Vertices?(f=s.has(n.head),b=s.has(n.tail)):b=f=s.has(o);let _=c(d.x,d.y,f),E=c(x.x,x.y,f),k=c(v.x,v.y,f),y=c(m.x,m.y,b);r[2*o]=_,r[2*o+1]=y,a[8*o]=_,a[8*o+1]=E,a[8*o+2]=E,a[8*o+3]=y,a[8*o+4]=y,a[8*o+5]=k,a[8*o+6]=k,a[8*o+7]=_,l[6*o]=_,l[6*o+1]=k,l[6*o+2]=E,l[6*o+3]=E,l[6*o+4]=k,l[6*o+5]=y,n.children.forEach(s=>{let i=t[s];if(i.head!==n.tail){let t=e[n.tail],s=e[i.head];h.push(t.x,t.y,0),h.push(s.x,s.y,0)}})});let m=new S.c;m.addAttribute("position",new S.b(n,3)),m.addAttribute("color",new S.g(o,3)),m.setIndex(new S.b(r,1)),this.points.geometry=m;let u=new S.c;u.addAttribute("position",new S.b(n,3)),u.addAttribute("color",new S.g(o,3)),u.setIndex(new S.b(a,1)),this.lines.geometry=u;let w=new S.c;w.addAttribute("position",new S.b(n,3)),w.setIndex(new S.b(l,1)),this.faces.geometry=w;let g=new S.c;g.addAttribute("position",new S.g(h,3)),this.dashedLines.geometry=g,this.dashedLines.computeLineDistances()}addToScene(e,t){t&&(this.points.position.z=43,e.add(this.points)),this.lines.position.z=42,this.dashedLines.position.z=41,this.faces.position.z=40,e.add(this.lines),e.add(this.faces),e.add(this.dashedLines)}toggleWireframe(){this.points.visible=!this.points.visible,this.lines.visible=!this.lines.visible,this.dashedLines.visible=!this.dashedLines.visible,this.faces.visible=!this.faces.visible}}class ze{constructor(e){this.meshRenderer=new I,this.rotationOffset=0,this.cachedBoneIndex=e}}class Ne{constructor(e){this.attachedMeshes=[],this.cachedSkeleton=e}async setSkinData(e,t){for(let s of e.components){let e=this.cachedSkeleton.getCachedBoneIndexFromBoneName(s.boneName),i=t.meshes.get(s.meshName);if(e&&i){let n=this.cachedSkeleton.cachedBones[e],o=new ze(e);await o.meshRenderer.createMeshFromMeshData(i,t);let r=n.globalPosition;o.rotationOffset=n.globalRotation,o.meshRenderer.setPivot(r.x,r.y),o.meshRenderer.mesh.position.z=s.zOffset,this.attachedMeshes.push(o)}}this.updateAttachedMeshes()}updateAttachedMeshes(){for(let e of this.attachedMeshes){let t=this.cachedSkeleton.cachedBones[e.cachedBoneIndex];e.meshRenderer.setPosition(t.globalPosition.x,t.globalPosition.y),e.meshRenderer.setRotation($.normalizeAngle(t.globalRotation-e.rotationOffset)),e.meshRenderer.updateTransform()}}addToScene(e){for(let t of this.attachedMeshes)e.add(t.meshRenderer.mesh)}}class Re{constructor(){this.x=0,this.y=0}}class Te{constructor(e,t,s){this.children=[],this.cachedBoneIndex=e,this.head=t,this.tail=s}}class We{constructor(){this.boneVertices=[],this.boneEdges=[],this.rootIndices=[],this.selectionType=ge.Vertices,this.selectedIndices=new Set,this.cachedSkeleton=new Ae,this.skeletonVisuals=new Pe,this.skins=[]}setSkeletonData(e,t){this.selectedIndices.clear(),this.cachedSkeleton.setSkeletonData(t.skeletons.get(e))}setAnimationData(e,t){this.cachedSkeleton.setAnimationData(t.animations.get(e)),this.cachedSkeleton.animationData&&(this.selectionType=ge.Edges)}createBoneEdges(){if(console.log("createBoneEdges"),!this.cachedSkeleton.skeletonData)return;this.cachedSkeleton.createCachedBones();let e=(t,s)=>{let i=this.cachedSkeleton.skeletonData;if(!i)return-1;let n,o=this.cachedSkeleton.cachedBones[t],r=o.boneIndex,a=i.bones[r];n=void 0!==s&&a.isConnected?this.boneEdges[s].tail:this.addBoneVertex();let l=this.addBoneVertex(),h=this.addBoneEdge(t,n,l);for(let t of o.children){let s=e(t,h);this.boneEdges[h].children.push(s)}return h};for(let t of this.cachedSkeleton.rootIndices){let s=e(t,void 0);-1!==s&&this.rootIndices.push(s)}this.updateBoneEdges(),this.updateVisuals()}updateBoneEdges(){if(!this.cachedSkeleton.skeletonData)return;this.cachedSkeleton.updateCachedBones(),this.updateSkins();let e=(t,s)=>{let i=this.cachedSkeleton.skeletonData;if(!i)return;let n=new S.w,o=this.boneEdges[t],r=this.cachedSkeleton.cachedBones[o.cachedBoneIndex],a=i.bones[r.boneIndex];this.setBoneVertexPosition(o.head,r.globalPosition);let l=new S.w(0,a.length);l.rotateAround(n,S.l.degToRad(r.globalRotation));let h=(new S.w).addVectors(r.globalPosition,l);this.setBoneVertexPosition(o.tail,new S.w(h.x,h.y));for(let s of o.children)e(s,t)};for(let t of this.rootIndices)e(t,void 0)}updateBoneData(){for(let e of this.rootIndices)this.updateBoneDataRecursive(e,void 0);this.updateVisuals()}updateBoneDataRecursive(e,t){let s=this.cachedSkeleton.skeletonData;if(!s)return;let i=this.boneEdges[e],n=this.cachedSkeleton.cachedBones[i.cachedBoneIndex],o=this.boneVertices[i.head],r=this.boneVertices[i.tail],a=(new S.w).subVectors(new S.w(r.x,r.y),new S.w(o.x,o.y));n.globalRotation=$.normalizeAngle(S.l.radToDeg(Math.atan2(a.y,a.x))-90);let l=n.globalRotation,h=new S.w(o.x,o.y),d=!1;if(void 0!==t){let e=this.boneEdges[t],s=this.cachedSkeleton.cachedBones[e.cachedBoneIndex];l=$.normalizeAngle(n.globalRotation-s.globalRotation);let o=this.boneVertices[e.head];h.sub(new S.w(o.x,o.y)),h.rotateAround(new S.w,S.l.degToRad(-s.globalRotation)),i.head===e.tail&&(d=!0)}let c=s.bones[n.boneIndex];c.translation=h,c.rotation=l,c.length=a.length(),c.isConnected=d;for(let t of c.children){this.updateBoneDataRecursive(t,e)}}addBoneVertex(e,t){let s=this.boneVertices.push(new Re)-1;return void 0!==e&&void 0!==t&&this.setBoneVertexPosition(s,new S.w(e,t)),s}addBoneEdge(e,t,s){return this.boneEdges.push(new Te(e,t,s))-1}createBoneFromBoneVertices(e,t,s){let i=this.cachedSkeleton.skeletonData;if(!i)return-1;let n=this.boneVertices[e],o=this.boneVertices[t],r=(new S.w).subVectors(new S.w(o.x,o.y),new S.w(n.x,n.y)),a=$.normalizeAngle(S.l.radToDeg(Math.atan2(r.y,r.x))),l=a,h=new S.w(n.x,n.y),d=h,c=!1;if(void 0!==s){let t=this.boneEdges[s],i=this.cachedSkeleton.cachedBones[t.cachedBoneIndex];l=$.normalizeAngle(a-i.globalRotation);let n=this.boneVertices[t.head];d.sub(new S.w(n.x,n.y)),d.rotateAround(new S.w,S.l.degToRad(-i.globalRotation)),e===t.tail&&(c=!0)}let m=i.addBone("new_bone",d.x,d.y,l),u=i.bones[m],w=this.cachedSkeleton.addCachedBone(m),g=this.cachedSkeleton.cachedBones[w];if(g.globalPosition=h,g.globalRotation=a,u.length=r.length(),u.isConnected=c,void 0!==s){let e=this.boneEdges[s],t=this.cachedSkeleton.cachedBones[e.cachedBoneIndex];i.attachBone(m,t.boneIndex),t.children.push(w),this.boneEdges[s].children.push(m)}return this.addBoneEdge(m,e,t)}toggleSelection(e){this.selectedIndices.has(e)?this.deselectIndex(e):this.selectIndex(e)}selectIndex(e){this.selectedIndices.add(e)}deselectIndex(e){this.selectedIndices.delete(e)}trySelectAtMousePosition(e,t,s){let i=2500/(s*s),n=void 0;if(this.boneVertices.forEach((s,o)=>{let r=e-s.x,a=t-s.y,l=r*r+a*a;l<i&&(i=l,n=o)}),void 0!==n){if(this.selectionType===ge.Vertices)this.toggleSelection(n);else{let e;this.boneEdges.forEach((t,s)=>{t.tail===n&&(e=s)}),void 0!==e&&this.toggleSelection(e)}this.updateVisuals()}}toggleSelectAll(){let e=Array.from(this.selectedIndices);e.length>0?e.forEach(e=>{this.deselectIndex(e)}):this.boneVertices.forEach((e,t)=>{this.selectIndex(t)}),this.updateVisuals()}getBoneVertexPosition(e){return new S.w(this.boneVertices[e].x,this.boneVertices[e].y)}setBoneVertexPosition(e,t){this.boneVertices[e].x=t.x,this.boneVertices[e].y=t.y}getBoneEdgeHeadPosition(e){let t=this.boneVertices[this.boneEdges[e].head];return new S.w(t.x,t.y)}insertBoneRotation(e,t){if(void 0===this.cachedSkeleton.skeletonData||void 0===this.cachedSkeleton.animationData)return;let s=this.boneEdges[e],i=this.cachedSkeleton.cachedBones[s.cachedBoneIndex],n=this.cachedSkeleton.skeletonData.bones[i.boneIndex].name,o=this.cachedSkeleton.animationData.bones.get(n);if(o)o.insertRotation(this.cachedSkeleton.currentFrame,t);else{let e=new ne(n);e.insertRotation(this.cachedSkeleton.currentFrame,t),this.cachedSkeleton.animationData.addBoneAnimationData(e)}}getBoneEdgeRotation(e){let t=this.cachedSkeleton.skeletonData,s=this.cachedSkeleton.animationData;if(void 0===t)return 0;let i=this.boneEdges[e],n=this.cachedSkeleton.cachedBones[i.cachedBoneIndex],o=t.bones[n.boneIndex];if(s){let e=s.getBoneRotation(this.cachedSkeleton.currentFrame,o.name);if(e)return e}return o.rotation}getBoneVertexParent(e){for(let t=0;t<this.boneEdges.length;++t)if(this.boneEdges[t].tail===e)return t}async addSkins(e){if(this.cachedSkeleton.skeletonData)for(let[t,s]of e.skins){if(s.skeletonName!==this.cachedSkeleton.skeletonData.name)continue;let t=new Ne(this.cachedSkeleton);await t.setSkinData(s,e),this.skins.push(t)}}updateSkins(){for(let e of this.skins)e.updateAttachedMeshes()}updateVisuals(){this.skeletonVisuals.createVisuals(this.boneVertices,this.boneEdges,this.selectedIndices,this.selectionType)}addToScene(e,t){this.skeletonVisuals.addToScene(e,t)}addSkinsToScene(e){for(let t of this.skins)t.addToScene(e)}toggleWireframe(){this.skeletonVisuals.toggleWireframe()}}class Fe extends de{constructor(e){super(),this.editableSkeleton=new We,this.isDefaultContextActive=!1,this.world=e,this.handleKeyDown=this.handleKeyDown.bind(this),this.enableDefaultContext=this.enableDefaultContext.bind(this),this.panningContext=new ce(e),this.zoomContext=new me(e),this.selectHandler=new ue(e,this.editableSkeleton),this.enableDefaultContext(),this.panningContext.enable(),this.zoomContext.enable(),this.editableSkeleton.addToScene(this.scene,!0)}disable(){super.disable(),this.disableDefaultContext(),this.panningContext.disable(),this.zoomContext.disable()}enableDefaultContext(){this.isDefaultContextActive||(this.isDefaultContextActive=!0,this.disableActiveContext(),this.selectHandler.enable(),document.addEventListener("keydown",this.handleKeyDown))}disableDefaultContext(){this.isDefaultContextActive&&(this.isDefaultContextActive=!1,this.selectHandler.disable(),document.removeEventListener("keydown",this.handleKeyDown))}handleKeyDown(e){if(e.ctrlKey){let e=new pe(this.editableSkeleton);return this.disableDefaultContext(),void this.setActiveContext(new Ie(this.world,e,this.enableDefaultContext))}switch(e.key){case"e":{let e=new pe(this.editableSkeleton);e.selectedIndices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new Be(this.world,e,this.enableDefaultContext)));break}case"g":{let e=new pe(this.editableSkeleton);e.selectedIndices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new xe(this.world,e,this.enableDefaultContext)));break}case"r":{let e=new pe(this.editableSkeleton);e.selectedIndices.length>1&&(this.disableDefaultContext(),this.setActiveContext(new ke(this.world,e,this.enableDefaultContext)));break}case"s":{let e=new pe(this.editableSkeleton);e.selectedIndices.length>1&&(this.disableDefaultContext(),this.setActiveContext(new De(this.world,e,this.enableDefaultContext)));break}}}async showSkeleton(e){this.editableSkeleton.setSkeletonData(e,this.world.resourceManager),this.editableSkeleton.createBoneEdges(),await this.editableSkeleton.addSkins(this.world.resourceManager),this.editableSkeleton.addSkinsToScene(this.scene)}}class He extends de{constructor(e){super(),this.editableSkeleton=new We,this.isDefaultContextActive=!1,this.world=e,this.handleKeyDown=this.handleKeyDown.bind(this),this.enableDefaultContext=this.enableDefaultContext.bind(this),this.panningContext=new ce(e),this.zoomContext=new me(e),this.selectHandler=new ue(e,this.editableSkeleton),this.enableDefaultContext(),this.panningContext.enable(),this.zoomContext.enable(),this.editableSkeleton.addToScene(this.scene,!1)}disable(){super.disable(),this.disableDefaultContext(),this.panningContext.disable(),this.zoomContext.disable()}enableDefaultContext(){this.isDefaultContextActive||(this.isDefaultContextActive=!0,this.disableActiveContext(),this.selectHandler.enable(),document.addEventListener("keydown",this.handleKeyDown))}disableDefaultContext(){this.isDefaultContextActive&&(this.isDefaultContextActive=!1,this.selectHandler.disable(),document.removeEventListener("keydown",this.handleKeyDown))}handleKeyDown(e){switch(e.key){case"r":{let e=new pe(this.editableSkeleton);e.selectedIndices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new ke(this.world,e,this.enableDefaultContext)));break}case"w":this.editableSkeleton.toggleWireframe(),this.world.render()}}async showAnimation(e){let t=this.world.resourceManager.animations.get(e);t&&(this.editableSkeleton.setSkeletonData(t.skeletonName,this.world.resourceManager),this.editableSkeleton.createBoneEdges(),await this.editableSkeleton.addSkins(this.world.resourceManager),this.editableSkeleton.addSkinsToScene(this.scene),this.editableSkeleton.setAnimationData(e,this.world.resourceManager),this.editableSkeleton.updateBoneEdges(),this.editableSkeleton.updateVisuals())}}class Ue extends de{constructor(e){super(),this.editableMesh=new A,this.isDefaultContextActive=!1,this.world=e,this.handleKeyDown=this.handleKeyDown.bind(this),this.enableDefaultContext=this.enableDefaultContext.bind(this),this.panningContext=new ce(e),this.zoomContext=new me(e),this.selectHandler=new ue(e,this.editableMesh),this.enableDefaultContext(),this.panningContext.enable(),this.zoomContext.enable(),this.editableMesh.addToScene(this.scene)}disable(){super.disable(),this.disableDefaultContext(),this.panningContext.disable(),this.zoomContext.disable()}enableDefaultContext(){this.isDefaultContextActive||(this.isDefaultContextActive=!0,this.disableActiveContext(),this.selectHandler.enable(),document.addEventListener("keydown",this.handleKeyDown))}disableDefaultContext(){this.isDefaultContextActive&&(this.isDefaultContextActive=!1,this.selectHandler.disable(),document.removeEventListener("keydown",this.handleKeyDown))}handleKeyDown(e){switch(e.key){case"e":{let e=new we(this.editableMesh);e.selectedVertices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new Be(this.world,e,this.enableDefaultContext)));break}case"g":{let e=new we(this.editableMesh);e.selectedVertices.length>0&&(this.disableDefaultContext(),this.setActiveContext(new xe(this.world,e,this.enableDefaultContext)));break}case"r":{let e=new we(this.editableMesh);e.selectedVertices.length>1&&(this.disableDefaultContext(),this.setActiveContext(new ke(this.world,e,this.enableDefaultContext)));break}case"s":{let e=new we(this.editableMesh);e.selectedVertices.length>1&&(this.disableDefaultContext(),this.setActiveContext(new De(this.world,e,this.enableDefaultContext)));break}}}async showMesh(e){await this.editableMesh.setMeshData(e,this.world.resourceManager)}}class Oe extends de{constructor(e){super(),this.imageRenderer=new I,this.isDefaultContextActive=!1,this.world=e,this.panningContext=new ce(e),this.zoomContext=new me(e),this.panningContext.enable(),this.zoomContext.enable(),this.scene.add(this.imageRenderer.mesh)}disable(){super.disable(),this.panningContext.disable(),this.zoomContext.disable()}async showImage(e){await this.imageRenderer.createMeshDataFromImageResource(e,this.world.resourceManager)}}s(7);zip.workerScriptsPath="zip-js/";let je=new class{constructor(){this.context_menu=new E,this.left_panel=new p(this.context_menu),this.right_panel=new _,this.domElement=document.createElement("div"),this.domElement.className="root";let e=document.createElement("div");e.className="horizontal_box";let t=new i;e.appendChild(this.left_panel.domElement),e.appendChild(t.domElement),e.appendChild(this.right_panel.domElement),this.domElement.appendChild(e),document.body.appendChild(this.context_menu.domElement)}setWorld(e){this.left_panel.setWorld(e),this.right_panel.setWorld(e)}setEditor(e){this.left_panel.setEditor(e)}};document.body.appendChild(je.domElement);let Ke=new class{constructor(){this.mouseX=0,this.mouseY=0,this.renderer=new S.y({antialias:!0}),this.character=new X,this.resourceManager=new he;let e=document.getElementById("world_view"),t=e.clientWidth,s=e.clientHeight;this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(t,s);let i=document.getElementById("world_view");null!==i&&i.appendChild(this.renderer.domElement),this.camera=new S.q(-t/2,t/2,s/2,-s/2,1,1e3),this.camera.position.z=50,this.camera.updateProjectionMatrix(),this.scene=new S.t,this.scene.background=new S.d(1315860),this.editableMesh=new A}async loadMeshes(){this.render()}setScene(e){this.scene=e}render(){this.renderer.render(this.scene,this.camera)}setMousePosition(e,t){let s=document.getElementById("world_view");this.mouseX=e-s.offsetLeft,this.mouseY=s.offsetHeight-(t-s.offsetTop)}getMouseWorldPosition(){let e=document.getElementById("world_view"),t=this.camera.position.x+(this.mouseX-e.offsetWidth/2)/this.camera.zoom,s=this.camera.position.y+(this.mouseY-e.offsetHeight/2)/this.camera.zoom;return new S.w(t,s)}downloadProject(){this.resourceManager.downloadZip()}loadProject(e){this.resourceManager.loadZip(e)}async loadImage(e){await this.resourceManager.loadImage(e.name,e);let t=this.resourceManager.images.get(e.name);if(t){let s=new B,i=e.name,n=i.lastIndexOf(".");i=i.slice(0,n),s.meshName=i,s.textureName=e.name;let o=t.imageBitmap;s.setAsRectangle(o.width,o.height),this.resourceManager.addMesh(s),await this.editableMesh.setMeshData(i,this.resourceManager)}console.log(this.resourceManager),this.render()}handleResize(e){let t=document.getElementById("world_view"),s=t.clientWidth,i=t.clientHeight;this.renderer.setSize(s,i),this.camera.left=-s/2,this.camera.right=s/2,this.camera.top=i/2,this.camera.bottom=-i/2,this.camera.updateProjectionMatrix(),this.render()}};Ke.render();let Ze=new class{constructor(e){this.world=e}async showSkeleton(e){this.activeView?this.activeView instanceof Fe||(this.activeView.disable(),this.activeView=new Fe(this.world),this.world.setScene(this.activeView.scene)):(this.activeView=new Fe(this.world),this.world.setScene(this.activeView.scene)),await this.activeView.showSkeleton(e),this.world.render()}async showAnimation(e){this.activeView?this.activeView instanceof He||(this.activeView.disable(),this.activeView=new He(this.world),this.world.setScene(this.activeView.scene)):(this.activeView=new He(this.world),this.world.setScene(this.activeView.scene)),await this.activeView.showAnimation(e),this.world.render()}async showMesh(e){this.activeView?this.activeView instanceof Ue||(this.activeView.disable(),this.activeView=new Ue(this.world),this.world.setScene(this.activeView.scene)):(this.activeView=new Ue(this.world),this.world.setScene(this.activeView.scene)),await this.activeView.showMesh(e),this.world.render()}async showImage(e){this.activeView?this.activeView instanceof Oe||(this.activeView.disable(),this.activeView=new Oe(this.world),this.world.setScene(this.activeView.scene)):(this.activeView=new Oe(this.world),this.world.setScene(this.activeView.scene)),await this.activeView.showImage(e),this.world.render()}}(Ke);je.setWorld(Ke),je.setEditor(Ze),document.addEventListener("contextmenu",function(e){e.preventDefault()}),document.addEventListener("mousemove",function(e){Ke.setMousePosition(e.clientX,e.clientY)}),window.addEventListener("resize",e=>{Ke.handleResize(e)}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("service-worker.js").then(e=>{console.log("Service worker registered: ",e)}).catch(e=>{console.log("Service worker registration failed: ",e)})})},,,,,function(e,t,s){(e.exports=s(5)(!1)).push([e.i,'html {\r\n    font-size: 62.5%;\r\n}\r\n\r\nbody {\r\n    margin: 0;\r\n    padding: 0;\r\n    background-color: rgba(50, 50, 52, 255);\r\n    color: #ffffff;\r\n    font-family: Helvetica;\r\n    font-size: 1.3rem;\r\n}\r\n\r\n* {\r\n    box-sizing: border-box;\r\n}\r\n\r\n.root {\r\n    display: flex;\r\n    height: 100vh;\r\n    width: 100wh;\r\n    padding: 2.5px;\r\n    border-top: 1px solid rgb(90, 90, 90);\r\n}\r\n\r\n/* Layout */\r\n\r\n.horizontal_box {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n    padding: 0px;\r\n    margin: 0px;\r\n}\r\n\r\n.horizontal_box > * {\r\n    margin: 2.5px;\r\n}\r\n\r\n.vertical_box {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n    padding: 0px;\r\n    margin: 0px;\r\n}\r\n\r\n.vertical_box > * {\r\n    margin: 2.5px;\r\n}\r\n\r\n/* Property section */\r\n\r\n/*.property_section:before {\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    content: " ";\r\n    position: absolute;\r\n    left: -1px;\r\n    right: -1px;\r\n}*/\r\n\r\n.property_section > .vertical_box {\r\n    padding: 2.5px;\r\n    /*padding-top: 4.5px;*/     /* To compensate for 2px separator! */\r\n}\r\n\r\n.property_section_title {\r\n    font-weight: bold;\r\n}\r\n\r\n/* Buttons */\r\n\r\n.button_group {\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    padding: 0.5px;\r\n\r\n    background-color: rgb(10, 10, 10);\r\n    border-radius: 2px;\r\n    box-shadow: 0 1px 4px black;\r\n}\r\n\r\n.button_group > :first-child {\r\n    border-top-left-radius: 2px;\r\n    border-bottom-left-radius: 2px;\r\n}\r\n\r\n.button_group > :last-child {\r\n    border-top-right-radius: 2px;\r\n    border-bottom-right-radius: 2px;\r\n}\r\n\r\n.button_group > button, .button_group > input, .button_group > label, .button_group > div {\r\n    flex: 1 1 0;\r\n    padding: 2px;\r\n    margin: 0.5px;\r\n    \r\n    background: linear-gradient(rgba(73, 73, 75, 255), rgba(58, 58, 60, 255));\r\n    /*border: 1px solid rgb(100, 100, 100);*/\r\n    border: 1px solid rgb(60, 60, 60);\r\n    border-top: 1px solid rgb(90, 90, 90);\r\n    border-bottom: 1px solid rgb(50, 50, 50);\r\n    \r\n    text-align: center;\r\n    text-shadow: 0 1px 1px black;\r\n    color: white;\r\n    /*text-shadow: 0 0 0 white, 0 1px 1px black;\r\n    color: transparent;*/\r\n\r\n    position: relative;     /* for file select button */\r\n\r\n    overflow: hidden;\r\n}\r\n\r\n.button_group > button:hover, .button_group > input:hover, .button_group > label:hover, .button_group > div:hover {\r\n    background: linear-gradient(rgba(83, 83, 85, 255), rgba(68, 68, 70, 255));\r\n}\r\n\r\n.button_group > button:active, .button_group > input:active, .button_group > label:active, .button_group > div:active {\r\n    background: linear-gradient(rgba(58, 58, 60, 255), rgba(73, 73, 75, 255));\r\n}\r\n\r\nlabel [type=file] {\r\n    opacity: 0;\r\n    position: absolute;\r\n}\r\n\r\n/* ListView */\r\n\r\n.list_view_container {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n    \r\n    position: relative;\r\n}\r\n\r\n.list_view_border {\r\n    pointer-events: none;\r\n\r\n    border-radius: 2px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    box-shadow: 0 1px 4px black inset;\r\n\r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n}\r\n\r\n.list_view {\r\n    background: rgba(40, 40, 42, 255);\r\n    \r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n\r\n    overflow: auto;\r\n}\r\n\r\n.list_view_entry {\r\n    cursor: default;\r\n\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    -moz-user-select: none;\r\n    user-select: none;\r\n\r\n    padding: 5px;\r\n    padding-left: 10px;\r\n    margin-left: 1px;\r\n    margin-right: 1px;\r\n\r\n    border-top: 1px solid rgb(60, 60, 60);\r\n    border-bottom: 1px solid rgb(20, 20, 20);\r\n}\r\n\r\n.list_view_entry_selected {\r\n    cursor: default;\r\n\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n    \r\n    -moz-user-select: none;\r\n    user-select: none;\r\n\r\n    padding: 5px;\r\n    padding-left: 10px;\r\n    margin-left: 1px;\r\n    margin-right: 1px;\r\n\r\n    background: linear-gradient(#3b6cc9, #264581);\r\n    border-top: 1px solid #437ce7;\r\n    border-bottom: 1px solid #1d3564;\r\n}\r\n\r\n/* Tmp */\r\n\r\n.side_panel {\r\n    flex: 0 0 260px;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n\r\n    position: relative;\r\n    overflow: auto;\r\n}\r\n\r\n/*.world_view {\r\n    flex-grow: 1;\r\n    background-color: rgb(20, 20, 20);\r\n}*/\r\n\r\n/*.world_view {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n\r\n    background: rgba(40, 40, 42, 255);\r\n    border-radius: 4px;\r\n    border: 1px solid rgb(60, 60, 60);\r\n    border-top: 1px solid rgb(30, 30, 30);\r\n    border-bottom: 1px solid rgb(90, 90, 90);\r\n    box-shadow: 0 1px 5px black inset;\r\n}*/\r\n\r\n/* Input */\r\n\r\n.world_view {\r\n    flex-grow: 1;\r\n    overflow: hidden;\r\n\r\n    border-radius: 2px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    /*background: transparent;*/\r\n    box-shadow: 0 1px 4px black inset;\r\n    position: relative;\r\n    top: 0px;\r\n    bottom: 0px;\r\n    left: 0px;\r\n    right: 0px;\r\n}\r\n\r\ncanvas {\r\n    border-radius: 2px;\r\n\r\n    position: relative;\r\n    z-index: -1;\r\n}\r\n\r\n/*.input_group {\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    padding: 0px;\r\n\r\n    background-color: rgb(40, 40, 40);\r\n    border-radius: 4px;\r\n\r\n    position: relative;\r\n}\r\n\r\n.input_group:after {\r\n    border-radius: 4px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    background: transparent;\r\n    box-shadow: 0 1px 5px black inset;\r\n    content: " ";\r\n    position: absolute;\r\n    top: 0px;\r\n    bottom: 0px;\r\n    left: 0px;\r\n    right: 0px;\r\n    margin: 0px;\r\n    z-index: 1;\r\n}*/\r\n\r\n/* Context menu */\r\n\r\n.context_menu {\r\n    display: block;\r\n    position: absolute;\r\n    z-index: 10;\r\n    box-shadow: 0 1px 4px black;\r\n    background-color: rgba(10, 10, 10, 0.9);\r\n    list-style: none;\r\n\r\n    left: 50px;\r\n    top: 50px;\r\n    padding: 4px 1px;\r\n}\r\n\r\n.context_menu_entry {\r\n    display: block;\r\n    margin-bottom: 4px;\r\n    padding: 2px 6px;\r\n}\r\n\r\n.context_menu_entry:hover {\r\n    /*background-color: #3b6cc9;*/\r\n    /*background: linear-gradient(rgba(73, 73, 75, 255), rgba(58, 58, 60, 255));*/\r\n    background: linear-gradient(#3b6cc9, #264581);\r\n}\r\n\r\n.context_menu_entry:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n@media screen and (min-resolution: 1.5dppx) {\r\n    body {\r\n        font-size: 1rem;\r\n    }\r\n    \r\n    .button_group > button, .button_group > input, .button_group > label, .button_group > div {\r\n        padding: 1px;\r\n    }\r\n}\r\n',""])},function(e,t,s){var i=s(6);"string"==typeof i&&(i=[[e.i,i,""]]);var n={hmr:!0,transform:void 0,insertInto:void 0};s(4)(i,n);i.locals&&(e.exports=i.locals)}]]);