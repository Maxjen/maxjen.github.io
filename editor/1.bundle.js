(window.webpackJsonp=window.webpackJsonp||[]).push([[1],[,function(e,t,s){"use strict";s.r(t);class i{constructor(){this.domElement=document.createElement("div"),this.domElement.className="world_view",this.domElement.id="world_view"}}class n{constructor(){this.listeners=[],this.listenersOnce=[]}bind(e){return this.listeners.push(e),{dispose:()=>this.unbind(e)}}bindForOneExecution(e){this.listenersOnce.push(e)}unbind(e){let t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}execute(e){this.listeners.forEach(t=>{t(e)}),this.listenersOnce.forEach(t=>{t(e)}),this.listenersOnce=[]}}class o{constructor(e,t,s){this.listEntry=e,this.x=t,this.y=s}}class r{constructor(e=!0){this.isSelected=!1,this.onClicked=new n,this.onContextMenu=new n,this.domElement=document.createElement("div"),e&&(this.domElement.className="list_view_entry",this.domElement.addEventListener("click",e=>{this.onClicked.execute(this)}),this.domElement.addEventListener("contextmenu",e=>{this.onContextMenu.execute(new o(this,e.pageX,e.pageY))}))}setIsSelected(e){this.isSelected=e,this.updateVisuals()}updateVisuals(){this.domElement.className=this.isSelected?"list_view_entry_selected":"list_view_entry"}}class h{constructor(){this.listEntries=[],this.domElement=document.createElement("div"),this.domElement.className="list_view_container",this.borderDomElement=document.createElement("div"),this.borderDomElement.className="list_view_border",this.contentDomElement=document.createElement("div"),this.contentDomElement.className="list_view",this.domElement.appendChild(this.contentDomElement),this.domElement.appendChild(this.borderDomElement)}addListEntry(e){e.onClicked.bind(e=>this.handleListEntryClicked(e)),e.onContextMenu.bind(e=>this.handleListEntryContextMenu(e)),this.listEntries.push(e),this.contentDomElement.appendChild(e.domElement)}handleListEntryClicked(e){this.selectedEntry&&this.selectedEntry.setIsSelected(!1),this.selectedEntry=e,this.selectedEntry.setIsSelected(!0)}handleListEntryContextMenu(e){this.handleListEntryClicked(e.listEntry)}clear(){this.contentDomElement.innerHTML="",this.listEntries=[],this.selectedEntry=void 0}}class a extends r{constructor(){super(!1),this.subEntries=[],this.onSubEntryAdded=new n,this.depth=0,this.isCollapsed=!1,this.entryDomElement=document.createElement("div"),this.entryDomElement.className="list_view_entry",this.entryDomElement.addEventListener("click",e=>{this.onClicked.execute(this)}),this.entryDomElement.addEventListener("contextmenu",e=>{this.onContextMenu.execute(new o(this,e.pageX,e.pageY))}),this.domElement.appendChild(this.entryDomElement),this.subEntriesDomElement=document.createElement("div"),this.setIsCollapsed(!1)}updateVisuals(){this.entryDomElement.className=this.isSelected?"list_view_entry_selected":"list_view_entry"}setDepth(e){this.depth=e,this.subEntries.forEach(t=>{t.setDepth(e+1)})}setIsCollapsed(e){this.isCollapsed=e,e?this.domElement.removeChild(this.subEntriesDomElement):this.domElement.appendChild(this.subEntriesDomElement)}addSubEntry(e,t){t.registerSubEntry(e),e.setDepth(this.depth+1),this.subEntries.push(e),this.subEntriesDomElement.appendChild(e.domElement),this.onSubEntryAdded.execute(e)}createExpansionWidget(){let e=document.createElement("div");return e.style.pointerEvents="none",e.style.width="10px",this.onSubEntryAdded.bindForOneExecution(t=>{console.log("SubEntry added"),e.style.pointerEvents="auto",e.textContent=this.isCollapsed?"▸":"▾ "}),e.addEventListener("click",t=>{e.textContent=this.isCollapsed?"▾ ":"▸",this.setIsCollapsed(!this.isCollapsed),t.stopPropagation()}),e}}class d extends h{addListEntry(e){super.addListEntry(e),e instanceof a&&e.setDepth(0)}registerSubEntry(e){e.onClicked.bind(e=>this.handleListEntryClicked(e)),e.onContextMenu.bind(e=>this.handleListEntryContextMenu(e))}}class l extends a{constructor(e){super(),this.expansionWidget=this.createExpansionWidget(),this.entryDomElement.appendChild(this.expansionWidget),this.labelDomElement=document.createElement("div"),this.labelDomElement.style.marginLeft="2px",this.labelDomElement.textContent=e,this.entryDomElement.appendChild(this.labelDomElement)}setDepth(e){let t=8*e;this.expansionWidget.style.marginLeft=t+"px",super.setDepth(e)}}class c extends l{constructor(e){super(e),this.meshName=e}}class m extends l{constructor(e){super(e),this.imageName=e}}class u extends d{constructor(e){super(),this.recreateList=(()=>{this.clear();let e=new l("Meshes"),t=new l("Images");if(this.world){for(const[t,s]of this.world.resourceManager.meshes){let s=new c(t);e.addSubEntry(s,this)}for(const[e,s]of this.world.resourceManager.images){let s=new m(e);t.addSubEntry(s,this)}}this.addListEntry(e),this.addListEntry(t)}),this.contextMenu=e}setWorld(e){this.world=e,this.recreateList()}setEditor(e){this.editor=e}handleListEntryClicked(e){super.handleListEntryClicked(e),this.editor&&(e instanceof c?this.editor.showMesh(e.meshName):e instanceof m&&this.editor.showImage(e.imageName))}handleListEntryContextMenu(e){super.handleListEntryContextMenu(e),this.contextMenu.clear(),this.contextMenu.setPositionFromMousePos(e.x,e.y),e.listEntry instanceof m&&this.contextMenu.addEntry("Remove",()=>{this.world&&(this.world.resourceManager.removeImage(e.listEntry.imageName),this.recreateList())})}}class w{constructor(e){e=e,this.domElement=document.createElement("div"),this.domElement.className="side_panel",this.domElement.id="left_panel",this.outliner=new u(e),this.domElement.appendChild(this.outliner.domElement)}setWorld(e){this.world=e,this.outliner.setWorld(e),this.outliner.recreateList(),this.world.resourceManager.onMeshesChanged.bind(this.outliner.recreateList),this.world.resourceManager.onImagesChanged.bind(this.outliner.recreateList)}setEditor(e){this.outliner.setEditor(e)}}class g{constructor(e){this.domElement=document.createElement("div"),this.domElement.className="property_section",this.verticalBox=document.createElement("div"),this.verticalBox.className="vertical_box";let t=document.createElement("div");t.className="property_section_title";let s=document.createTextNode("▾ "+e);t.appendChild(s),this.verticalBox.appendChild(t),this.domElement.appendChild(this.verticalBox)}addWidget(e){this.verticalBox.appendChild(e.domElement)}}class p{constructor(e){this.domElement=document.createElement("div"),this.domElement.className="button",this.domElement.onclick=(()=>{this.onClick()}),this.domElement.appendChild(document.createTextNode(e))}}class b{constructor(e){this.domElement=document.createElement("label"),this.domElement.className="button",this.domElement.appendChild(document.createTextNode(e)),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept="application/zip",this.domElement.appendChild(this.fileInput)}}class f{constructor(){this.domElement=document.createElement("div"),this.domElement.className="button_group",this.buttons=[]}addButton(e){this.buttons.push(e),this.domElement.appendChild(e.domElement)}}class v{constructor(){this.domElement=document.createElement("div"),this.domElement.className="side_panel";let e=new g("Import/Export"),t=new b("Open");t.fileInput.addEventListener("change",()=>{t.fileInput.files&&this.world&&this.world.loadProject(t.fileInput.files[0])},!1);let s=new p("Save");zip.workerScriptsPath="zip-js/",s.onClick=(()=>{this.world&&this.world.downloadProject()});let i=new f;i.addButton(t),i.addButton(s),e.addWidget(i);let n=new b("Load image");n.fileInput.accept="image/*",n.fileInput.addEventListener("change",()=>{n.fileInput.files&&this.world&&this.world.loadImage(n.fileInput.files[0])},!1);let o=new f;o.addButton(n),e.addWidget(o),this.domElement.appendChild(e.domElement)}setWorld(e){this.world=e}}class x{constructor(){this.domElement=document.createElement("ul"),this.domElement.className="context_menu"}clear(){this.domElement.innerHTML=""}addEntry(e,t){let s=document.createElement("li");s.className="context_menu_entry",s.appendChild(document.createTextNode(e)),s.onclick=t,this.domElement.appendChild(s)}setPositionFromMousePos(e,t){this.domElement.style.left=e+"px",this.domElement.style.top=t+"px"}}var _,E,M=s(2);class D{constructor(e,t,s,i){this.x=e,this.y=t,this.u=s,this.v=i}}class L{constructor(e,t){this.v1=e,this.v2=t}}class y{constructor(e,t,s){this.v1=e,this.v2=t,this.v3=s}}class C{constructor(e,t,s,i){this.v1=e,this.v2=t,this.v3=s,this.v4=i}}class V{constructor(){this.meshName="",this.textureName="",this.vertices=[],this.lines=[],this.triangles=[],this.quads=[]}reset(){this.vertices=[],this.lines=[],this.triangles=[],this.quads=[]}setAsRectangle(e,t){this.reset();let s=this.addVertex(0,0,0,0),i=this.addVertex(e,0,1,0),n=this.addVertex(e,t,1,1),o=this.addVertex(0,t,0,1);this.addQuad(s,i,n,o)}addVertex(e,t,s,i){return this.vertices.push(new D(e,t,s||0,i||0))-1}addLine(e,t){this.lines.push(new L(e,t))}addTriangle(e,t,s){this.triangles.push(new y(e,t,s))}addQuad(e,t,s,i){this.quads.push(new C(e,t,s,i))}getVertexPosition(e){return new M.u(this.vertices[e].x,this.vertices[e].y)}setVertexPosition(e,t){this.vertices[e].x=t.x,this.vertices[e].y=t.y}setTextureName(e){this.textureName=e}generatePositionBuffer(){let e=new Float32Array(3*this.vertices.length);return this.vertices.forEach((t,s)=>{e[3*s]=t.x,e[3*s+1]=t.y,e[3*s+2]=0}),e}generateTexCoordBuffer(){let e=new Float32Array(2*this.vertices.length);return this.vertices.forEach((t,s)=>{e[2*s]=t.u,e[2*s+1]=t.v}),e}generateFaceIndices(){let e=new Uint32Array(3*this.triangles.length+6*this.quads.length);this.triangles.forEach((t,s)=>{e[3*s]=t.v1,e[3*s+1]=t.v2,e[3*s+2]=t.v3});let t=this.triangles.length;return this.quads.forEach((s,i)=>{e[6*i+t]=s.v1,e[6*i+t+1]=s.v2,e[6*i+t+2]=s.v3,e[6*i+t+3]=s.v1,e[6*i+t+4]=s.v3,e[6*i+t+5]=s.v4}),e}}class k{constructor(){this.mesh=new M.k}reset(){this.meshData=void 0}createMeshFromMeshData(e,t){return this.meshData=e,new Promise(s=>{let i=t.images.get(e.textureName);if(i){let e=new Image;e.onload=(()=>{let t=new M.s(e);t.needsUpdate=!0,this.setupMesh(t),s()}),e.src=URL.createObjectURL(i.blob)}})}createMeshDataFromImageResource(e,t){return new Promise(s=>{let i=t.images.get(e);if(i){let e=new Image;e.onload=(()=>{let t=new M.s(e);t.needsUpdate=!0,this.meshData=new V,this.meshData.setAsRectangle(t.image.width,t.image.height),this.setupMesh(t),s()}),e.src=URL.createObjectURL(i.blob)}})}createMeshDataFromTexture(e){return new Promise(t=>this.loadTexture("images/"+e).then(e=>{this.meshData=new V,this.meshData.setAsRectangle(e.image.width,e.image.height),this.setupMesh(e),t()}))}setupMesh(e){if(!this.meshData)return;let t=this.meshData.generatePositionBuffer(),s=this.meshData.generateTexCoordBuffer(),i=this.meshData.generateFaceIndices(),n=new M.c;n.addAttribute("position",new M.b(t,3)),n.addAttribute("uv",new M.b(s,2)),n.setIndex(new M.b(i,1)),e.anisotropy=0,e.premultiplyAlpha=!0,e.magFilter=M.j,e.minFilter=M.j;let o=new M.l({map:e,opacity:1,transparent:!0,side:M.f,blending:M.e,blendEquation:M.a,blendSrc:M.m,blendDst:M.n});this.mesh.geometry=n,this.mesh.material=o}loadTexture(e){return new Promise(t=>{(new M.t).load(e,t)})}}class S{constructor(e,t){this.width=e,this.height=t}isValid(){return 0!==this.width&&0!==this.height}}class P{constructor(){this.meshData=new V,this.backgroundRenderer=new k,this.positionBuffer=new Float32Array(0),this.edgeColorBuffer=new Float32Array(0),this.faceColorBuffer=new Float32Array(0),this.edgeIndices=new Uint32Array(0),this.faceIndices=new Uint32Array(0),this.edges=new Map,this.selectedVertices=new Set,this.points=new M.p,this.lines=new M.i,this.faces=new M.k,this.points.position.z=2,this.points.material=new M.q({vertexColors:M.v,size:5,sizeAttenuation:!1}),this.lines.position.z=1,this.lines.material=new M.h({vertexColors:M.v}),this.faces.material=new M.l({color:16777215,opacity:.2,transparent:!0,side:M.f})}async setMeshData(e,t){this.selectedVertices.clear();let s=t.meshes.get(e);if(s){this.meshData=s,this.createBuffers(),await this.backgroundRenderer.createMeshFromMeshData(s,t);const e=t.images.get(s.textureName),i=e?e.imageBitmap:void 0;i&&(this.textureDimensions=new S(i.width,i.height))}else this.reset()}reset(){this.meshData=new V,this.createBuffers()}addVertex(e){let t=this.meshData.addVertex(e.x,e.y);return this.createBuffers(),t}addLine(e,t){this.meshData.addLine(e,t),this.createBuffers()}addTriangle(e,t,s){this.meshData.addTriangle(e,t,s),this.createBuffers()}addQuad(e,t,s,i){this.meshData.addQuad(e,t,s,i),this.createBuffers()}addEdge(e,t){e>t&&([e,t]=[t,e]);let s=this.edges.get(e);s&&!s.includes(t)&&(s.push(t),this.edges.set(e,s)),s||this.edges.set(e,[t])}createBuffers(){this.positionBuffer=this.meshData.generatePositionBuffer(),this.faceIndices=this.meshData.generateFaceIndices(),this.edgeColorBuffer=new Float32Array(3*this.meshData.vertices.length),this.faceColorBuffer=new Float32Array(3*this.meshData.vertices.length),this.meshData.vertices.forEach((e,t)=>{let s=this.selectedVertices.has(t);this.edgeColorBuffer[3*t]=s?1:.5,this.edgeColorBuffer[3*t+1]=s?1:.5,this.edgeColorBuffer[3*t+2]=s?1:.5,this.faceColorBuffer[3*t]=s?1:.5,this.faceColorBuffer[3*t+1]=s?1:.5,this.faceColorBuffer[3*t+2]=s?1:.5}),this.edges.clear(),this.meshData.lines.forEach((e,t)=>{this.addEdge(e.v1,e.v2)}),this.meshData.triangles.forEach((e,t)=>{this.addEdge(e.v1,e.v2),this.addEdge(e.v2,e.v3),this.addEdge(e.v3,e.v1)}),this.meshData.quads.forEach((e,t)=>{this.addEdge(e.v1,e.v2),this.addEdge(e.v2,e.v3),this.addEdge(e.v3,e.v4),this.addEdge(e.v4,e.v1)});let e=0;for(let t of this.edges.values())e+=t.length;this.edgeIndices=new Uint32Array(2*e);let t=0;this.edges.forEach((e,s)=>{for(let i of e)this.edgeIndices[t]=s,this.edgeIndices[t+1]=i,t+=2}),this.updateMeshes()}updateMeshes(){let e=new M.c;e.addAttribute("position",new M.b(this.positionBuffer,3)),e.setIndex(new M.b(this.faceIndices,1)),this.faces.geometry=e;let t=new M.c;t.addAttribute("position",new M.b(this.positionBuffer,3)),t.addAttribute("color",new M.g(this.edgeColorBuffer,3)),t.setIndex(new M.b(this.edgeIndices,1)),this.lines.geometry=t;let s=new M.c;s.addAttribute("position",new M.b(this.positionBuffer,3)),s.addAttribute("color",new M.g(this.edgeColorBuffer,3)),this.points.geometry=s}getClosestVertex(e,t){let s=1/0,i=null;return this.meshData.vertices.forEach((n,o)=>{let r=e-n.x,h=t-n.y,a=r*r+h*h;a<s&&(s=a,i=o)}),i}toggleVertexSelection(e){this.selectedVertices.has(e)?this.deselectVertex(e):this.selectVertex(e),this.createBuffers()}selectVertex(e){this.selectedVertices.add(e)}deselectVertex(e){this.selectedVertices.delete(e)}selectAll(){this.meshData.vertices.forEach((e,t)=>{this.selectVertex(t)}),this.createBuffers()}getSelectedVertices(){return Array.from(this.selectedVertices)}getSelectedEdges(){let e=[];return this.selectedVertices.forEach(t=>{let s=this.edges.get(t);s&&s.forEach(s=>{this.selectedVertices.has(s)&&(e.push(t),e.push(s))})}),e}getVertexPosition(e){return new M.u(this.meshData.vertices[e].x,this.meshData.vertices[e].y)}setVertexPosition(e,t){this.meshData.vertices[e].x=t.x,this.meshData.vertices[e].y=t.y,this.createBuffers(),this.textureDimensions&&this.textureDimensions.isValid()&&(this.meshData.vertices[e].u=t.x/this.textureDimensions.width,this.meshData.vertices[e].v=t.y/this.textureDimensions.height)}getMeshJson(){return JSON.stringify(this.meshData)}}!function(e){e[e.Male=0]="Male",e[e.Female=1]="Female"}(_||(_={})),function(e){e[e.Standard=0]="Standard",e[e.Skin=1]="Skin",e[e.Eye=2]="Eye",e[e.Hair=3]="Hair"}(E||(E={}));class B{constructor(e,t,s){this.path=e,this.zOffset=t,this.meshType=s}}const I=[new M.d(16764597),new M.d(15249304),new M.d(7885904)],z=[new M.d(12412238),new M.d(6408447),new M.d(4706377),new M.d(16776960)],A=[new M.d(2891805),new M.d(15062686),new M.d(7021340),new M.d(458844)],N=[new B("m/m_f_r_arm_1.png",-6,E.Skin),new B("m/m_f_r_arm_2.png",-7,E.Skin),new B("m/m_f_r_arm_3.png",-8,E.Skin),new B("m/m_f_r_leg_1.png",-3,E.Skin),new B("m/m_f_r_leg_2.png",-5,E.Skin),new B("m/m_f_r_leg_3.png",-4,E.Skin),new B("m/m_s_eyebrow.png",-2.5,E.Hair),new B("m/m_s_eye_fg.png",-2.4,E.Eye),new B("m/m_s_eye_bg.png",-2.3,E.Standard),new B("m/m_s_ear.png",-2.2,E.Skin),new B("m/m_s_head.png",-2,E.Skin),new B("m/m_f_neck.png",-1,E.Skin),new B("m/m_f_torso.png",0,E.Skin),new B("m/m_f_l_leg_1.png",3,E.Skin),new B("m/m_f_l_leg_2.png",1,E.Skin),new B("m/m_f_l_leg_3.png",2,E.Skin),new B("m/m_f_l_arm_1.png",6,E.Skin),new B("m/m_f_l_arm_2.png",5,E.Skin),new B("m/m_f_l_arm_3.png",4,E.Skin)],U=[new B("f/f_f_r_arm_1.png",-6,E.Skin),new B("f/f_f_r_arm_2.png",-7,E.Skin),new B("f/f_f_r_arm_3.png",-8,E.Skin),new B("f/f_f_r_leg_1.png",-3,E.Skin),new B("f/f_f_r_leg_2.png",-4,E.Skin),new B("f/f_f_r_leg_3.png",-5,E.Skin),new B("f/f_head_s_eyebrow.png",-2.5,E.Hair),new B("f/f_head_s_eye_fg.png",-2.4,E.Eye),new B("f/f_head_s_eye_bg.png",-2.3,E.Standard),new B("f/f_head_s_ear.png",-2.2,E.Skin),new B("f/f_head_s_head.png",-2,E.Skin),new B("f/f_head_f_neck.png",-1,E.Skin),new B("f/f_f_torso.png",0,E.Skin),new B("f/f_f_l_leg_1.png",3,E.Skin),new B("f/f_f_l_leg_2.png",2,E.Skin),new B("f/f_f_l_leg_3.png",1,E.Skin),new B("f/f_f_l_arm_1.png",6,E.Skin),new B("f/f_f_l_arm_2.png",5,E.Skin),new B("f/f_f_l_arm_3.png",4,E.Skin)],W=[new B("m/m_s_hair_front_1.png",-2.6,E.Hair),new B("m/m_s_hair_1.png",-2.1,E.Hair)],T=[new B("m/m_s_hair_front_2.png",-2.6,E.Hair),new B("m/m_s_hair_2.png",-2.1,E.Hair),new B("m/m_s_hair_back_2.png",.1,E.Hair)],R=[new B("f/f_hair_s_hair_front_1.png",-2.6,E.Hair),new B("f/f_hair_s_hair_1.png",-2.1,E.Hair)],F=[new B("f/f_hair_s_hair_2.png",-2.1,E.Hair),new B("f/f_hair_s_hair_back_2.png",.1,E.Hair)],H=[new B("m/m_clothing_f_r_arm_1.png",-6.1,E.Standard),new B("m/m_clothing_shirt_bottom.png",-5.9,E.Standard),new B("m/m_clothing_f_r_leg_1.png",-3.1,E.Standard),new B("m/m_clothing_f_r_leg_2.png",-5.1,E.Standard),new B("m/m_clothing_f_torso.png",-.1,E.Standard),new B("m/m_clothing_f_l_leg_1.png",2.9,E.Standard),new B("m/m_clothing_f_l_leg_2.png",.9,E.Standard),new B("m/m_clothing_f_l_arm_1.png",5.9,E.Standard)],j=[new B("m/m_clothing2_f_r_arm_1.png",-6.1,E.Standard),new B("m/m_clothing2_shirt_bottom.png",-5.9,E.Standard),new B("m/m_clothing2_f_r_leg_1.png",-3.1,E.Standard),new B("m/m_clothing2_f_r_leg_2.png",-5.1,E.Standard),new B("m/m_clothing2_f_torso.png",-.1,E.Standard),new B("m/m_clothing2_f_l_leg_1.png",2.9,E.Standard),new B("m/m_clothing2_f_l_leg_2.png",.9,E.Standard),new B("m/m_clothing2_f_l_arm_1.png",5.9,E.Standard)],O=[new B("f/f_clothing_f_r_arm_1.png",-6.1,E.Standard),new B("f/f_clothing_shirt_bottom.png",-5.9,E.Standard),new B("f/f_clothing_f_r_leg_1.png",-3.1,E.Standard),new B("f/f_clothing_f_r_leg_2.png",-5.1,E.Standard),new B("f/f_clothing_f_torso.png",-.1,E.Standard),new B("f/f_clothing_f_l_leg_1.png",2.9,E.Standard),new B("f/f_clothing_f_l_leg_2.png",.9,E.Standard),new B("f/f_clothing_f_l_arm_1.png",5.9,E.Standard)],Z=[new B("f/f_clothing2_f_r_arm_1.png",-6.1,E.Standard),new B("f/f_clothing2_shirt_bottom.png",-5.9,E.Standard),new B("f/f_clothing2_f_r_leg_1.png",-3.1,E.Standard),new B("f/f_clothing2_f_r_leg_2.png",-5.1,E.Standard),new B("f/f_clothing2_f_torso.png",-.1,E.Standard),new B("f/f_clothing2_f_l_leg_1.png",2.9,E.Standard),new B("f/f_clothing2_f_l_leg_2.png",.9,E.Standard),new B("f/f_clothing2_f_l_arm_1.png",5.9,E.Standard)],Y=[new B("m/m_sabre.png",-6.9,E.Standard),new B("m/m_longsword.png",-6.9,E.Standard)],X=[new B("f/f_sabre.png",-6.9,E.Standard),new B("f/f_longsword.png",-6.9,E.Standard)];class q{constructor(){this.isLoading=!1,this.gender=_.Male,this.hairIndex=0,this.clothingIndex=0,this.swordIndex=0,this.skinColorIndex=0,this.eyeColorIndex=0,this.hairColorIndex=0,this.standardMeshes=[],this.skinMeshes=[],this.hairMeshes=[],this.eyeMesh=new k,this.skinColor=I[this.skinColorIndex],this.eyeColor=z[this.eyeColorIndex],this.hairColor=A[this.hairColorIndex],this.wasAddedToScene=!1}setScene(e){this.scene=e}setGender(e){return this.gender!==e&&(this.gender=e,!0)}setHairIndex(e){return this.hairIndex!==e&&(this.hairIndex=e,!0)}setClothingIndex(e){return this.clothingIndex!==e&&(this.clothingIndex=e,!0)}setSwordIndex(e){return this.swordIndex!==e&&(this.swordIndex=e,!0)}setSkinColorIndex(e){this.skinColorIndex!==e&&(this.skinColorIndex=e,this.setSkinColor(I[e]))}setSkinColor(e){if(!this.isLoading){this.skinColor=e;for(let t of this.skinMeshes){let s=t.mesh.material;s&&(s.color=e)}}}setEyeColorIndex(e){this.eyeColorIndex!==e&&(this.eyeColorIndex=e,this.setEyeColor(z[e]))}setEyeColor(e){if(this.isLoading)return;this.eyeColor=e;let t=this.eyeMesh.mesh.material;t&&(t.color=e)}setHairColorIndex(e){this.hairColorIndex!==e&&(this.hairColorIndex=e,this.setHairColor(A[e]))}setHairColor(e){if(!this.isLoading){this.hairColor=e;for(let t of this.hairMeshes){let s=t.mesh.material;s&&(s.color=e)}}}createMeshInternal(e){return this.createMesh(e.path,e.zOffset,e.meshType)}createMeshes(e){let t=[];for(let s of e)t.push(this.createMeshInternal(s));return Promise.all(t)}createMesh(e,t,s){return new Promise(i=>{let n=new k,o=null;switch(s){case E.Standard:this.standardMeshes.push(n);break;case E.Skin:this.skinMeshes.push(n),o=this.skinColor;break;case E.Eye:this.eyeMesh=n,o=this.eyeColor;break;case E.Hair:this.hairMeshes.push(n),o=this.hairColor}n.createMeshDataFromTexture(e).then(()=>{if(o){let e=n.mesh.material;e&&(e.color=o)}n.mesh.translateZ(-8-t),i()})})}recreateCharacter(){if(this.isLoading)return Promise.all([]);this.isLoading=!0,this.removeFromScene();let e=[];return this.gender===_.Male?(e=e.concat(N),0===this.hairIndex?e=e.concat(W):1===this.hairIndex&&(e=e.concat(T)),0===this.clothingIndex?e=e.concat(H):1===this.clothingIndex&&(e=e.concat(j)),e.push(Y[this.swordIndex])):(e=e.concat(U),0===this.hairIndex?e=e.concat(R):1===this.hairIndex&&(e=e.concat(F)),0===this.clothingIndex?e=e.concat(O):1===this.clothingIndex&&(e=e.concat(Z)),e.push(X[this.swordIndex])),this.createMeshes(e).then(()=>(this.addToScene(),this.isLoading=!1,Promise.all([])))}addToScene(){if(this.scene){this.wasAddedToScene=!0;for(let e of this.standardMeshes)this.scene.add(e.mesh);for(let e of this.skinMeshes)this.scene.add(e.mesh);this.scene.add(this.eyeMesh.mesh);for(let e of this.hairMeshes)this.scene.add(e.mesh)}}removeFromScene(){if(this.scene&&this.wasAddedToScene){this.wasAddedToScene=!1;for(let e of this.standardMeshes)this.scene.remove(e.mesh);for(let e of this.skinMeshes)this.scene.remove(e.mesh);this.scene.remove(this.eyeMesh.mesh);for(let e of this.hairMeshes)this.scene.remove(e.mesh);this.standardMeshes=[],this.skinMeshes=[],this.hairMeshes=[]}}}class J{constructor(e,t){this.blob=e,this.imageBitmap=t}}class K{constructor(){this.images=new Map,this.onImagesChanged=new n,this.meshes=new Map,this.onMeshesChanged=new n}loadImage(e,t){return new Promise((s,i)=>{createImageBitmap(t).then(i=>{this.images.set(e,new J(t,i)),console.log("loaded image "+e),this.onImagesChanged.execute(void 0),s()},t=>{console.log("error loading image "+e+": "+t),i()})})}removeImage(e){this.images.delete(e)}addMesh(e){this.meshes.set(e.meshName,e),this.onMeshesChanged.execute(void 0)}loadMesh(e){let t=new V;e.meshName&&(t.meshName=e.meshName),e.textureName&&(t.textureName=e.textureName),e.vertices&&e.vertices.forEach(e=>{t.addVertex(e.x,e.y,e.u,e.v)}),e.lines&&e.lines.forEach(e=>{t.addLine(e.v1,e.v2)}),e.triangles&&e.triangles.forEach(e=>{t.addTriangle(e.v1,e.v2,e.v3)}),e.quads&&e.quads.forEach(e=>{t.addQuad(e.v1,e.v2,e.v3,e.v4)}),console.log("loadMesh"),this.meshes.set(t.meshName,t),this.onMeshesChanged.execute(void 0)}loadJson(e){console.log(e);let t=JSON.parse(e);t.meshes&&t.meshes.forEach(e=>{this.loadMesh(e)})}getZipEntries(e){return new Promise((t,s)=>{zip.createReader(new zip.BlobReader(e),e=>{e.getEntries(t)},e=>{console.log(e),s()})})}async loadZip(e){let t=await this.getZipEntries(e);for(const e of t)e.filename.endsWith("png")?e.getData(new zip.BlobWriter("image/png"),t=>{this.loadImage(e.filename,t)}):e.filename.endsWith("json")&&e.getData(new zip.BlobWriter("application/json"),e=>{let t=new FileReader;t.onload=(()=>{"string"==typeof t.result&&this.loadJson(t.result)}),t.readAsText(e)})}addBlobToZip(e,t,s){return new Promise((i,n)=>{s.add(e,new zip.BlobReader(t),()=>{i(s)})})}addTextToZip(e,t,s){return new Promise((i,n)=>{s.add(e,new zip.TextReader(t),()=>{i(s)})})}createZipWriter(){return new Promise((e,t)=>{zip.createWriter(new zip.BlobWriter("application/zip"),t=>{e(t)},e=>{console.log(e),t()})})}writeZip(e){return new Promise(t=>{e.close(e=>{t(e)})})}async downloadZip(){let e=await this.createZipWriter();for(const[t,s]of this.images)await this.addBlobToZip(t,s.blob,e);let t={meshes:[]};for(const[e,s]of this.meshes)t.meshes.push(s);let s=JSON.stringify(t);await this.addTextToZip("meshes.json",s,e);let i=await this.writeZip(e),n=URL.createObjectURL(i),o=document.createElement("a");document.body.appendChild(o),o.style.display="none",o.href=n,o.download="project.zip",o.click(),o.parentNode&&o.parentNode.removeChild(o),window.URL.revokeObjectURL(n)}}class Q{constructor(){this.leftButtonDown=!1,this.rightButtonDown=!1,this.selectedVertices=[],this.startingPositions=[]}start(e,t){this.world=e,this.endCallback=t,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this),document.addEventListener("mousemove",this.mouseMoveListener),document.addEventListener("mousedown",this.mouseDownListener),document.addEventListener("mouseup",this.mouseUpListener),this.selectedVertices=e.editableMesh.getSelectedVertices(),this.startingPositions=[],this.selectedVertices.forEach(e=>{this.startingPositions.push(this.world.editableMesh.getVertexPosition(e))}),this.deltaPosition=new M.u(0,0)}end(){document.removeEventListener("mousemove",this.mouseMoveListener),document.removeEventListener("mousedown",this.mouseDownListener),document.removeEventListener("mouseup",this.mouseUpListener),this.endCallback()}handleMouseMove(e){this.deltaPosition.x+=e.movementX/this.world.camera.zoom,this.deltaPosition.y+=-e.movementY/this.world.camera.zoom,this.selectedVertices.forEach((e,t)=>{this.world.editableMesh.setVertexPosition(e,(new M.u).addVectors(this.startingPositions[t],this.deltaPosition))}),this.world.render()}handleMouseDown(e){0!==e.button||this.leftButtonDown||(this.leftButtonDown=!0,this.end()),2!==e.button||this.rightButtonDown||(this.rightButtonDown=!0,this.selectedVertices.forEach((e,t)=>{this.world.editableMesh.setVertexPosition(e,this.startingPositions[t])}),this.world.render(),this.end())}handleMouseUp(e){0===e.button&&(this.leftButtonDown=!1),1===e.button&&(this.rightButtonDown=!1)}}class G{constructor(){this.leftButtonDown=!1,this.rightButtonDown=!1,this.selectedVertices=[],this.startingPositions=[],this.startingAngle=0}start(e,t){this.world=e,this.endCallback=t,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this),document.addEventListener("mousemove",this.mouseMoveListener),document.addEventListener("mousedown",this.mouseDownListener),document.addEventListener("mouseup",this.mouseUpListener),this.selectedVertices=e.editableMesh.getSelectedVertices(),this.startingPositions=[],this.pivot=new M.u(0,0),this.selectedVertices.forEach(e=>{let t=this.world.editableMesh.getVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length);let s=this.world.getMouseWorldPosition();this.startingAngle=Math.atan2(s.y-this.pivot.y,s.x-this.pivot.x)}end(){document.removeEventListener("mousemove",this.mouseMoveListener),document.removeEventListener("mousedown",this.mouseDownListener),document.removeEventListener("mouseup",this.mouseUpListener),this.endCallback()}handleMouseMove(e){let t=this.world.getMouseWorldPosition(),s=Math.atan2(t.y-this.pivot.y,t.x-this.pivot.x);this.selectedVertices.forEach((e,t)=>{let i=this.startingPositions[t].clone().rotateAround(this.pivot,s-this.startingAngle);this.world.editableMesh.setVertexPosition(e,i)}),this.world.render()}handleMouseDown(e){0!==e.button||this.leftButtonDown||(this.leftButtonDown=!0,this.end()),2!==e.button||this.rightButtonDown||(this.rightButtonDown=!0,this.selectedVertices.forEach((e,t)=>{this.world.editableMesh.setVertexPosition(e,this.startingPositions[t])}),this.world.render(),this.end())}handleMouseUp(e){0===e.button&&(this.leftButtonDown=!1),2===e.button&&(this.rightButtonDown=!1)}}class ${constructor(){this.leftButtonDown=!1,this.rightButtonDown=!1,this.selectedVertices=[],this.startingPositions=[],this.startingDistance=0}start(e,t){this.world=e,this.endCallback=t,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this),document.addEventListener("mousemove",this.mouseMoveListener),document.addEventListener("mousedown",this.mouseDownListener),document.addEventListener("mouseup",this.mouseUpListener),this.selectedVertices=e.editableMesh.getSelectedVertices(),this.startingPositions=[],this.pivot=new M.u(0,0),this.selectedVertices.forEach(e=>{let t=this.world.editableMesh.getVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length);let s=this.world.getMouseWorldPosition();this.startingDistance=this.pivot.distanceTo(s),this.startingDistance<1&&(this.startingDistance=1)}end(){document.removeEventListener("mousemove",this.mouseMoveListener),document.removeEventListener("mousedown",this.mouseDownListener),document.removeEventListener("mouseup",this.mouseUpListener),this.endCallback()}handleMouseMove(e){let t=this.world.getMouseWorldPosition(),s=this.pivot.distanceTo(t)/this.startingDistance;this.selectedVertices.forEach((e,t)=>{let i=this.startingPositions[t].clone().sub(this.pivot),n=this.pivot.clone().add(i.clone().multiplyScalar(s));this.world.editableMesh.setVertexPosition(e,n)}),this.world.render()}handleMouseDown(e){0!==e.button||this.leftButtonDown||(this.leftButtonDown=!0,this.end()),2!==e.button||this.rightButtonDown||(this.rightButtonDown=!0,this.selectedVertices.forEach((e,t)=>{this.world.editableMesh.setVertexPosition(e,this.startingPositions[t])}),this.world.render(),this.end())}handleMouseUp(e){0===e.button&&(this.leftButtonDown=!1),2===e.button&&(this.rightButtonDown=!1)}}class ee{constructor(){this.leftButtonDown=!1,this.rightButtonDown=!1,this.startingPositions=[],this.newVertices=new Map}start(e,t){this.world=e,this.endCallback=t,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this),document.addEventListener("mousemove",this.mouseMoveListener),document.addEventListener("mousedown",this.mouseDownListener),document.addEventListener("mouseup",this.mouseUpListener);let s=e.editableMesh.getSelectedVertices(),i=e.editableMesh.getSelectedEdges();this.startingPositions=[],s.forEach(e=>{let t=this.world.editableMesh.getVertexPosition(e);this.startingPositions.push(t);let s=this.world.editableMesh.addVertex(t);this.newVertices.set(e,s),this.world.editableMesh.deselectVertex(e),this.world.editableMesh.selectVertex(s)}),s=s.filter(e=>!i.includes(e));let n=0;for(;n<i.length/2;++n){let e=i[2*n],t=i[2*n+1],s=this.newVertices.get(t),o=this.newVertices.get(e);s&&o&&this.world.editableMesh.addQuad(e,t,s,o)}s.forEach(e=>{let t=this.newVertices.get(e);t&&this.world.editableMesh.addLine(e,t)}),this.deltaPosition=new M.u(0,0)}end(){document.removeEventListener("mousemove",this.mouseMoveListener),document.removeEventListener("mousedown",this.mouseDownListener),document.removeEventListener("mouseup",this.mouseUpListener),this.endCallback()}handleMouseMove(e){this.deltaPosition.x+=e.movementX/this.world.camera.zoom,this.deltaPosition.y+=-e.movementY/this.world.camera.zoom;let t=0;this.newVertices.forEach((e,s)=>{this.world.editableMesh.setVertexPosition(e,(new M.u).addVectors(this.startingPositions[t],this.deltaPosition)),++t}),this.world.render()}handleMouseDown(e){0!==e.button||this.leftButtonDown||(this.leftButtonDown=!0,this.end())}handleMouseUp(e){0===e.button&&(this.leftButtonDown=!1),1===e.button&&(this.rightButtonDown=!1)}}class te{constructor(){this.scene=new M.r,this.scene.background=new M.d(1315860)}disableActiveContext(){this.activeContext&&this.activeContext.disable()}setActiveContext(e){this.disableActiveContext(),this.activeContext=e,this.activeContext.enable()}disable(){this.activeContext&&this.activeContext.disable()}}class se{constructor(e){this.isEnabled=!1,this.middleButtonDown=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener,!0),this.worldView.addEventListener("mousedown",this.mouseDownListener,!0),this.worldView.addEventListener("mouseup",this.mouseUpListener,!0))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener,!0),this.worldView.removeEventListener("mousedown",this.mouseDownListener,!0),this.worldView.removeEventListener("mouseup",this.mouseUpListener,!0))}handleMouseMove(e){this.middleButtonDown&&(this.world.camera.position.x+=-e.movementX/this.world.camera.zoom,this.world.camera.position.y+=e.movementY/this.world.camera.zoom,this.world.render())}handleMouseDown(e){1!==e.button||this.middleButtonDown||(this.middleButtonDown=!0)}handleMouseUp(e){1===e.button&&(this.middleButtonDown=!1)}}class ie{constructor(e){this.isEnabled=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.wheelListener=this.handleWheel.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("wheel",this.wheelListener,{capture:!0,passive:!0}))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("wheel",this.wheelListener,!0))}handleWheel(e){let t=e.deltaY>0?.1:-.1;this.world.camera.zoom-=t,this.world.camera.zoom=Math.min(this.world.camera.zoom,5),this.world.camera.zoom=Math.max(this.world.camera.zoom,.1),this.world.camera.updateProjectionMatrix(),this.world.render()}}class ne{constructor(e,t){this.isEnabled=!1,this.leftButtonDown=!1,this.middleButtonDown=!1,this.rightButtonDown=!1,this.world=e,this.worldView=document.getElementById("world_view"),this.editableMesh=t,this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this),this.keyDownListener=this.handleKeyDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousedown",this.mouseDownListener,!0),this.worldView.addEventListener("mouseup",this.mouseUpListener,!0),document.addEventListener("keydown",this.keyDownListener))}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousedown",this.mouseDownListener,!0),this.worldView.removeEventListener("mouseup",this.mouseUpListener,!0),document.removeEventListener("keydown",this.keyDownListener))}handleMouseDown(e){if(0===e.button&&!this.leftButtonDown){this.leftButtonDown=!0;let e=this.world.getMouseWorldPosition(),t=this.editableMesh.getClosestVertex(e.x,e.y);null!=t&&this.editableMesh.toggleVertexSelection(t),this.world.render()}}handleMouseUp(e){0===e.button&&(this.leftButtonDown=!1)}handleKeyDown(e){switch(e.key){case"a":{let e=this.editableMesh.getSelectedVertices();e.length>0?e.forEach(e=>{this.editableMesh.toggleVertexSelection(e)}):this.editableMesh.selectAll(),this.world.render();break}}}}class oe{constructor(e,t,s){this.isEnabled=!1,this.selectedVertices=[],this.startingPositions=[],this.world=e,this.worldView=document.getElementById("world_view"),this.editableMesh=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){this.isEnabled||(this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selectedVertices=this.editableMesh.getSelectedVertices(),this.startingPositions=[],this.selectedVertices.forEach(e=>{this.startingPositions.push(this.editableMesh.getVertexPosition(e))}),this.deltaPosition=new M.u(0,0))}disable(){this.isEnabled&&(this.isEnabled=!1,this.undo(),this.removeListeners())}undo(){this.selectedVertices.forEach((e,t)=>{this.editableMesh.setVertexPosition(e,this.startingPositions[t])})}removeListeners(){this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback()}handleMouseMove(e){this.deltaPosition.x+=e.movementX/this.world.camera.zoom,this.deltaPosition.y+=-e.movementY/this.world.camera.zoom,this.selectedVertices.forEach((e,t)=>{this.editableMesh.setVertexPosition(e,(new M.u).addVectors(this.startingPositions[t],this.deltaPosition))}),this.world.render()}handleMouseDown(e){0===e.button&&this.removeListeners(),2===e.button&&(this.undo(),this.removeListeners(),this.world.render())}}class re{constructor(e,t,s){this.isEnabled=!1,this.selectedVertices=[],this.startingPositions=[],this.startingAngle=0,this.world=e,this.worldView=document.getElementById("world_view"),this.editableMesh=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){if(!this.isEnabled){this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selectedVertices=this.editableMesh.getSelectedVertices(),this.startingPositions=[],this.pivot=new M.u(0,0),this.selectedVertices.forEach(e=>{let t=this.editableMesh.getVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length);let e=this.world.getMouseWorldPosition();this.startingAngle=Math.atan2(e.y-this.pivot.y,e.x-this.pivot.x)}}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback())}handleMouseMove(e){let t=this.world.getMouseWorldPosition(),s=Math.atan2(t.y-this.pivot.y,t.x-this.pivot.x);this.selectedVertices.forEach((e,t)=>{let i=this.startingPositions[t].clone().rotateAround(this.pivot,s-this.startingAngle);this.editableMesh.setVertexPosition(e,i)}),this.world.render()}handleMouseDown(e){0===e.button&&this.disable(),2===e.button&&(this.selectedVertices.forEach((e,t)=>{this.editableMesh.setVertexPosition(e,this.startingPositions[t])}),this.world.render(),this.disable())}}class he{constructor(e,t,s){this.isEnabled=!1,this.selectedVertices=[],this.startingPositions=[],this.startingDistance=0,this.world=e,this.worldView=document.getElementById("world_view"),this.editableMesh=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){if(!this.isEnabled){this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener),this.selectedVertices=this.editableMesh.getSelectedVertices(),this.startingPositions=[],this.pivot=new M.u(0,0),this.selectedVertices.forEach(e=>{let t=this.editableMesh.getVertexPosition(e);this.pivot.add(t),this.startingPositions.push(t)}),this.pivot.divideScalar(this.startingPositions.length);let e=this.world.getMouseWorldPosition();this.startingDistance=this.pivot.distanceTo(e),this.startingDistance<1&&(this.startingDistance=1)}}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback())}handleMouseMove(e){let t=this.world.getMouseWorldPosition(),s=this.pivot.distanceTo(t)/this.startingDistance;this.selectedVertices.forEach((e,t)=>{let i=this.startingPositions[t].clone().sub(this.pivot),n=this.pivot.clone().add(i.clone().multiplyScalar(s));this.editableMesh.setVertexPosition(e,n)}),this.world.render()}handleMouseDown(e){0===e.button&&this.disable(),2===e.button&&(this.selectedVertices.forEach((e,t)=>{this.editableMesh.setVertexPosition(e,this.startingPositions[t])}),this.world.render(),this.disable())}}class ae{constructor(e,t,s){this.isEnabled=!1,this.leftButtonDown=!1,this.rightButtonDown=!1,this.startingPositions=[],this.newVertices=new Map,this.world=e,this.worldView=document.getElementById("world_view"),this.editableMesh=t,this.endCallback=s,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this)}enable(){if(!this.isEnabled){this.isEnabled=!0,this.worldView.addEventListener("mousemove",this.mouseMoveListener),this.worldView.addEventListener("mousedown",this.mouseDownListener);let e=this.editableMesh.getSelectedVertices(),t=this.editableMesh.getSelectedEdges();this.startingPositions=[],e.forEach(e=>{let t=this.editableMesh.getVertexPosition(e);this.startingPositions.push(t);let s=this.editableMesh.addVertex(t);this.newVertices.set(e,s),this.editableMesh.deselectVertex(e),this.editableMesh.selectVertex(s)}),e=e.filter(e=>!t.includes(e));let s=0;for(;s<t.length/2;++s){let e=t[2*s],i=t[2*s+1],n=this.newVertices.get(i),o=this.newVertices.get(e);n&&o&&this.editableMesh.addQuad(e,i,n,o)}e.forEach(e=>{let t=this.newVertices.get(e);t&&this.editableMesh.addLine(e,t)}),this.deltaPosition=new M.u(0,0)}}disable(){this.isEnabled&&(this.isEnabled=!1,this.worldView.removeEventListener("mousemove",this.mouseMoveListener),this.worldView.removeEventListener("mousedown",this.mouseDownListener),this.endCallback())}handleMouseMove(e){this.deltaPosition.x+=e.movementX/this.world.camera.zoom,this.deltaPosition.y+=-e.movementY/this.world.camera.zoom;let t=0;this.newVertices.forEach((e,s)=>{this.editableMesh.setVertexPosition(e,(new M.u).addVectors(this.startingPositions[t],this.deltaPosition)),++t}),this.world.render()}handleMouseDown(e){0===e.button&&(this.leftButtonDown=!0,this.disable())}}class de extends te{constructor(e){super(),this.editableMesh=new P,this.isDefaultContextActive=!1,this.world=e,this.handleKeyDown=this.handleKeyDown.bind(this),this.enableDefaultContext=this.enableDefaultContext.bind(this),this.panningContext=new se(e),this.zoomContext=new ie(e),this.vertexSelectContext=new ne(e,this.editableMesh),this.enableDefaultContext(),this.panningContext.enable(),this.zoomContext.enable(),this.scene.add(this.editableMesh.backgroundRenderer.mesh),this.scene.add(this.editableMesh.faces),this.scene.add(this.editableMesh.lines),this.scene.add(this.editableMesh.points)}disable(){super.disable(),this.disableDefaultContext(),this.panningContext.disable(),this.zoomContext.disable()}enableDefaultContext(){this.isDefaultContextActive||(this.isDefaultContextActive=!0,this.disableActiveContext(),this.vertexSelectContext.enable(),document.addEventListener("keydown",this.handleKeyDown))}disableDefaultContext(){this.isDefaultContextActive&&(this.isDefaultContextActive=!1,this.vertexSelectContext.disable(),document.removeEventListener("keydown",this.handleKeyDown))}handleKeyDown(e){switch(e.key){case"e":this.editableMesh.getSelectedVertices().length>0&&(this.disableDefaultContext(),this.setActiveContext(new ae(this.world,this.editableMesh,this.enableDefaultContext)));break;case"g":this.editableMesh.getSelectedVertices().length>0&&(this.disableDefaultContext(),this.setActiveContext(new oe(this.world,this.editableMesh,this.enableDefaultContext)));break;case"r":this.editableMesh.getSelectedVertices().length>1&&(this.disableDefaultContext(),this.setActiveContext(new re(this.world,this.editableMesh,this.enableDefaultContext)));break;case"s":this.editableMesh.getSelectedVertices().length>1&&(this.disableDefaultContext(),this.setActiveContext(new he(this.world,this.editableMesh,this.enableDefaultContext)));break}}async showMesh(e){await this.editableMesh.setMeshData(e,this.world.resourceManager)}}class le extends te{constructor(e){super(),this.imageRenderer=new k,this.isDefaultContextActive=!1,this.world=e,this.panningContext=new se(e),this.zoomContext=new ie(e),this.panningContext.enable(),this.zoomContext.enable(),this.scene.add(this.imageRenderer.mesh)}disable(){super.disable(),this.panningContext.disable(),this.zoomContext.disable()}async showImage(e){await this.imageRenderer.createMeshDataFromImageResource(e,this.world.resourceManager)}}s(7);zip.workerScriptsPath="zip-js/";let ce=new class{constructor(){this.context_menu=new x,this.left_panel=new w(this.context_menu),this.right_panel=new v,this.domElement=document.createElement("div"),this.domElement.className="root";let e=document.createElement("div");e.className="horizontal_box";let t=new i;e.appendChild(this.left_panel.domElement),e.appendChild(t.domElement),e.appendChild(this.right_panel.domElement),this.domElement.appendChild(e),document.body.appendChild(this.context_menu.domElement)}setWorld(e){this.left_panel.setWorld(e),this.right_panel.setWorld(e)}setEditor(e){this.left_panel.setEditor(e)}};document.body.appendChild(ce.domElement);let me=new class{constructor(){this.mouseX=0,this.mouseY=0,this.renderer=new M.w,this.character=new q,this.resourceManager=new K;let e=document.getElementById("world_view"),t=e.clientWidth,s=e.clientHeight;this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(t,s);let i=document.getElementById("world_view");null!==i&&i.appendChild(this.renderer.domElement),this.camera=new M.o(-t/2,t/2,s/2,-s/2,1,1e3),this.camera.position.z=5,this.camera.updateProjectionMatrix(),this.scene=new M.r,this.scene.background=new M.d(1315860),this.editableMesh=new P}async loadMeshes(){this.render()}setScene(e){this.scene=e}render(){this.renderer.render(this.scene,this.camera)}setMousePosition(e,t){let s=document.getElementById("world_view");this.mouseX=e-s.offsetLeft,this.mouseY=s.offsetHeight-(t-s.offsetTop)}getMouseWorldPosition(){let e=document.getElementById("world_view"),t=this.camera.position.x+(this.mouseX-e.offsetWidth/2)/this.camera.zoom,s=this.camera.position.y+(this.mouseY-e.offsetHeight/2)/this.camera.zoom;return new M.u(t,s)}downloadProject(){this.resourceManager.downloadZip()}loadProject(e){this.resourceManager.loadZip(e)}async loadImage(e){await this.resourceManager.loadImage(e.name,e);let t=this.resourceManager.images.get(e.name);if(t){let s=new V,i=e.name,n=i.lastIndexOf(".");i=i.slice(0,n),s.meshName=i,s.textureName=e.name;let o=t.imageBitmap;s.setAsRectangle(o.width,o.height),this.resourceManager.addMesh(s),await this.editableMesh.setMeshData(i,this.resourceManager)}console.log(this.resourceManager),this.render()}handleResize(e){let t=document.getElementById("world_view"),s=t.clientWidth,i=t.clientHeight;this.renderer.setSize(s,i),this.camera.left=-s/2,this.camera.right=s/2,this.camera.top=i/2,this.camera.bottom=-i/2,this.camera.updateProjectionMatrix(),this.render()}};me.render();let ue=new class{constructor(e){this.world=e}async showMesh(e){this.activeView?this.activeView instanceof de||(this.activeView.disable(),this.activeView=new de(this.world),this.world.setScene(this.activeView.scene)):(this.activeView=new de(this.world),this.world.setScene(this.activeView.scene)),await this.activeView.showMesh(e),this.world.render()}async showImage(e){this.activeView?this.activeView instanceof le||(this.activeView.disable(),this.activeView=new le(this.world),this.world.setScene(this.activeView.scene)):(this.activeView=new le(this.world),this.world.setScene(this.activeView.scene)),await this.activeView.showImage(e),this.world.render()}}(me);ce.setWorld(me),ce.setEditor(ue);let we=new class{constructor(){this.leftButtonDown=!1,this.middleButtonDown=!1,this.rightButtonDown=!1}start(e,t){this.world=e,this.endCallback=t,this.mouseMoveListener=this.handleMouseMove.bind(this),this.mouseDownListener=this.handleMouseDown.bind(this),this.mouseUpListener=this.handleMouseUp.bind(this),this.wheelListener=this.handleWheel.bind(this),document.addEventListener("mousemove",this.mouseMoveListener,!0),document.addEventListener("mousedown",this.mouseDownListener,!0),document.addEventListener("mouseup",this.mouseUpListener,!0),document.addEventListener("wheel",this.wheelListener,{capture:!0,passive:!0})}end(){document.removeEventListener("mousemove",this.mouseMoveListener,!0),document.removeEventListener("mousedown",this.mouseDownListener,!0),document.removeEventListener("mouseup",this.mouseUpListener,!0),document.removeEventListener("wheel",this.wheelListener,!0)}handleMouseMove(e){this.middleButtonDown&&(this.world.camera.position.x+=-e.movementX/this.world.camera.zoom,this.world.camera.position.y+=e.movementY/this.world.camera.zoom,this.world.render())}handleMouseDown(e){if(1!==e.button||this.middleButtonDown||(this.middleButtonDown=!0),2===e.button&&!this.rightButtonDown){this.rightButtonDown=!0;let e=this.world.getMouseWorldPosition(),t=this.world.editableMesh.getClosestVertex(e.x,e.y);null!=t&&this.world.editableMesh.toggleVertexSelection(t),this.world.render()}}handleMouseUp(e){0===e.button&&(this.leftButtonDown=!1),1===e.button&&(this.middleButtonDown=!1),2===e.button&&(this.rightButtonDown=!1)}handleWheel(e){let t=e.deltaY>0?.1:-.1;this.world.camera.zoom-=t,this.world.camera.zoom=Math.min(this.world.camera.zoom,5),this.world.camera.zoom=Math.max(this.world.camera.zoom,.1),this.world.camera.updateProjectionMatrix(),this.world.render()}},ge=we;me.camera.zoom;function pe(){ge=we,we.start(me,pe),be()}function be(){document.addEventListener("keydown",ve)}function fe(){document.removeEventListener("keydown",ve)}function ve(e){switch(e.key){case"a":{let e=me.editableMesh.getSelectedVertices();e.length>0?e.forEach(e=>{me.editableMesh.toggleVertexSelection(e)}):me.editableMesh.selectAll(),me.render();break}case"e":me.editableMesh.getSelectedVertices().length>0&&(fe(),ge.end(),(ge=new ee).start(me,pe));break;case"g":me.editableMesh.getSelectedVertices().length>0&&(fe(),ge.end(),(ge=new Q).start(me,pe));break;case"r":me.editableMesh.getSelectedVertices().length>1&&(fe(),ge.end(),(ge=new G).start(me,pe));break;case"s":me.editableMesh.getSelectedVertices().length>1&&(fe(),ge.end(),(ge=new $).start(me,pe));break}}document.addEventListener("contextmenu",function(e){e.preventDefault()}),document.addEventListener("mousemove",function(e){me.setMousePosition(e.clientX,e.clientY)}),window.addEventListener("resize",e=>{me.handleResize(e)}),be(),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("service-worker.js").then(e=>{console.log("Service worker registered: ",e)}).catch(e=>{console.log("Service worker registration failed: ",e)})})},,,,,function(e,t,s){(e.exports=s(5)(!1)).push([e.i,'html {\r\n    font-size: 62.5%;\r\n}\r\n\r\nbody {\r\n    margin: 0;\r\n    padding: 0;\r\n    background-color: rgba(50, 50, 52, 255);\r\n    color: #ffffff;\r\n    font-family: Helvetica;\r\n    font-size: 1.3rem;\r\n}\r\n\r\n* {\r\n    box-sizing: border-box;\r\n}\r\n\r\n.root {\r\n    display: flex;\r\n    height: 100vh;\r\n    width: 100wh;\r\n    padding: 2.5px;\r\n    border-top: 1px solid rgb(90, 90, 90);\r\n}\r\n\r\n/* Layout */\r\n\r\n.horizontal_box {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n    padding: 0px;\r\n    margin: 0px;\r\n}\r\n\r\n.horizontal_box > * {\r\n    margin: 2.5px;\r\n}\r\n\r\n.vertical_box {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n    padding: 0px;\r\n    margin: 0px;\r\n}\r\n\r\n.vertical_box > * {\r\n    margin: 2.5px;\r\n}\r\n\r\n/* Property section */\r\n\r\n/*.property_section:before {\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    content: " ";\r\n    position: absolute;\r\n    left: -1px;\r\n    right: -1px;\r\n}*/\r\n\r\n.property_section > .vertical_box {\r\n    padding: 2.5px;\r\n    /*padding-top: 4.5px;*/     /* To compensate for 2px separator! */\r\n}\r\n\r\n.property_section_title {\r\n    font-weight: bold;\r\n}\r\n\r\n/* Buttons */\r\n\r\n.button_group {\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    padding: 0.5px;\r\n\r\n    background-color: rgb(10, 10, 10);\r\n    border-radius: 2px;\r\n    box-shadow: 0 1px 4px black;\r\n}\r\n\r\n.button_group > :first-child {\r\n    border-top-left-radius: 2px;\r\n    border-bottom-left-radius: 2px;\r\n}\r\n\r\n.button_group > :last-child {\r\n    border-top-right-radius: 2px;\r\n    border-bottom-right-radius: 2px;\r\n}\r\n\r\n.button_group > button, .button_group > input, .button_group > label, .button_group > div {\r\n    flex: 1 1 0;\r\n    padding: 2px;\r\n    margin: 0.5px;\r\n    \r\n    background: linear-gradient(rgba(73, 73, 75, 255), rgba(58, 58, 60, 255));\r\n    /*border: 1px solid rgb(100, 100, 100);*/\r\n    border: 1px solid rgb(60, 60, 60);\r\n    border-top: 1px solid rgb(90, 90, 90);\r\n    border-bottom: 1px solid rgb(50, 50, 50);\r\n    \r\n    text-align: center;\r\n    text-shadow: 0 1px 1px black;\r\n    color: white;\r\n    /*text-shadow: 0 0 0 white, 0 1px 1px black;\r\n    color: transparent;*/\r\n\r\n    position: relative;     /* for file select button */\r\n\r\n    overflow: hidden;\r\n}\r\n\r\n.button_group > button:hover, .button_group > input:hover, .button_group > label:hover, .button_group > div:hover {\r\n    background: linear-gradient(rgba(83, 83, 85, 255), rgba(68, 68, 70, 255));\r\n}\r\n\r\n.button_group > button:active, .button_group > input:active, .button_group > label:active, .button_group > div:active {\r\n    background: linear-gradient(rgba(58, 58, 60, 255), rgba(73, 73, 75, 255));\r\n}\r\n\r\nlabel [type=file] {\r\n    opacity: 0;\r\n    position: absolute;\r\n}\r\n\r\n/* ListView */\r\n\r\n.list_view_container {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n    \r\n    position: relative;\r\n}\r\n\r\n.list_view_border {\r\n    pointer-events: none;\r\n\r\n    border-radius: 2px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    box-shadow: 0 1px 4px black inset;\r\n\r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n}\r\n\r\n.list_view {\r\n    background: rgba(40, 40, 42, 255);\r\n    \r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n\r\n    overflow: auto;\r\n}\r\n\r\n.list_view_entry {\r\n    cursor: default;\r\n\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    -moz-user-select: none;\r\n    user-select: none;\r\n\r\n    padding: 5px;\r\n    padding-left: 10px;\r\n    margin-left: 1px;\r\n    margin-right: 1px;\r\n\r\n    border-top: 1px solid rgb(60, 60, 60);\r\n    border-bottom: 1px solid rgb(20, 20, 20);\r\n}\r\n\r\n.list_view_entry_selected {\r\n    cursor: default;\r\n\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n    \r\n    -moz-user-select: none;\r\n    user-select: none;\r\n\r\n    padding: 5px;\r\n    padding-left: 10px;\r\n    margin-left: 1px;\r\n    margin-right: 1px;\r\n\r\n    background: linear-gradient(#3b6cc9, #264581);\r\n    border-top: 1px solid #437ce7;\r\n    border-bottom: 1px solid #1d3564;\r\n}\r\n\r\n/* Tmp */\r\n\r\n.side_panel {\r\n    flex: 0 0 260px;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n\r\n    position: relative;\r\n    overflow: auto;\r\n}\r\n\r\n/*.world_view {\r\n    flex-grow: 1;\r\n    background-color: rgb(20, 20, 20);\r\n}*/\r\n\r\n/*.world_view {\r\n    flex-grow: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n    flex-wrap: nowrap;\r\n\r\n    background: rgba(40, 40, 42, 255);\r\n    border-radius: 4px;\r\n    border: 1px solid rgb(60, 60, 60);\r\n    border-top: 1px solid rgb(30, 30, 30);\r\n    border-bottom: 1px solid rgb(90, 90, 90);\r\n    box-shadow: 0 1px 5px black inset;\r\n}*/\r\n\r\n/* Input */\r\n\r\n.world_view {\r\n    flex-grow: 1;\r\n    overflow: hidden;\r\n\r\n    border-radius: 2px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    /*background: transparent;*/\r\n    box-shadow: 0 1px 4px black inset;\r\n    position: relative;\r\n    top: 0px;\r\n    bottom: 0px;\r\n    left: 0px;\r\n    right: 0px;\r\n}\r\n\r\ncanvas {\r\n    border-radius: 2px;\r\n\r\n    position: relative;\r\n    z-index: -1;\r\n}\r\n\r\n/*.input_group {\r\n    display: flex;\r\n    flex-direction: row;\r\n    flex-wrap: nowrap;\r\n\r\n    padding: 0px;\r\n\r\n    background-color: rgb(40, 40, 40);\r\n    border-radius: 4px;\r\n\r\n    position: relative;\r\n}\r\n\r\n.input_group:after {\r\n    border-radius: 4px;\r\n    border: 1px solid rgb(70, 70, 70);\r\n    border-top: 1px solid rgb(40, 40, 40);\r\n    border-bottom: 1px solid rgb(100, 100, 100);\r\n    background: transparent;\r\n    box-shadow: 0 1px 5px black inset;\r\n    content: " ";\r\n    position: absolute;\r\n    top: 0px;\r\n    bottom: 0px;\r\n    left: 0px;\r\n    right: 0px;\r\n    margin: 0px;\r\n    z-index: 1;\r\n}*/\r\n\r\n/* Context menu */\r\n\r\n.context_menu {\r\n    display: block;\r\n    position: absolute;\r\n    z-index: 10;\r\n    box-shadow: 0 1px 4px black;\r\n    background-color: rgba(10, 10, 10, 0.9);\r\n    list-style: none;\r\n\r\n    left: 50px;\r\n    top: 50px;\r\n    padding: 4px 1px;\r\n}\r\n\r\n.context_menu_entry {\r\n    display: block;\r\n    margin-bottom: 4px;\r\n    padding: 2px 6px;\r\n}\r\n\r\n.context_menu_entry:hover {\r\n    /*background-color: #3b6cc9;*/\r\n    /*background: linear-gradient(rgba(73, 73, 75, 255), rgba(58, 58, 60, 255));*/\r\n    background: linear-gradient(#3b6cc9, #264581);\r\n}\r\n\r\n.context_menu_entry:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n@media screen and (min-resolution: 1.5dppx) {\r\n    body {\r\n        font-size: 1rem;\r\n    }\r\n    \r\n    .button_group > button, .button_group > input, .button_group > label, .button_group > div {\r\n        padding: 1px;\r\n    }\r\n}\r\n',""])},function(e,t,s){var i=s(6);"string"==typeof i&&(i=[[e.i,i,""]]);var n={hmr:!0,transform:void 0,insertInto:void 0};s(4)(i,n);i.locals&&(e.exports=i.locals)}]]);